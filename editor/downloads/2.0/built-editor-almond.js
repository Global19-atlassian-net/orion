var requirejs,require,define;(function(e){function c(e,t){return f.call(e,t)}function h(e,t){var n,r,i,s,o,a,f,l,c,h,p=t&&t.split("/"),d=u.map,v=d&&d["*"]||{};if(e&&e.charAt(0)===".")if(t){p=p.slice(0,p.length-1),e=p.concat(e.split("/"));for(l=0;l<e.length;l+=1){h=e[l];if(h===".")e.splice(l,1),l-=1;else if(h===".."){if(l===1&&(e[2]===".."||e[0]===".."))break;l>0&&(e.splice(l-1,2),l-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((p||v)&&d){n=e.split("/");for(l=n.length;l>0;l-=1){r=n.slice(0,l).join("/");if(p)for(c=p.length;c>0;c-=1){i=d[p.slice(0,c).join("/")];if(i){i=i[r];if(i){s=i,o=l;break}}}if(s)break;!a&&v&&v[r]&&(a=v[r],f=l)}!s&&a&&(s=a,o=f),s&&(n.splice(0,o,s),e=n.join("/"))}return e}function p(t,r){return function(){return n.apply(e,l.call(arguments,0).concat([t,r]))}}function d(e){return function(t){return h(t,e)}}function v(e){return function(t){s[e]=t}}function m(n){if(c(o,n)){var r=o[n];delete o[n],a[n]=!0,t.apply(e,r)}if(!c(s,n)&&!c(a,n))throw new Error("No "+n);return s[n]}function g(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function y(e){return function(){return u&&u.config&&u.config[e]||{}}}var t,n,r,i,s={},o={},u={},a={},f=Object.prototype.hasOwnProperty,l=[].slice;r=function(e,t){var n,r=g(e),i=r[0];return e=r[1],i&&(i=h(i,t),n=m(i)),i?n&&n.normalize?e=n.normalize(e,d(t)):e=h(e,t):(e=h(e,t),r=g(e),i=r[0],e=r[1],i&&(n=m(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},i={require:function(e){return p(e)},exports:function(e){var t=s[e];return typeof t!="undefined"?t:s[e]={}},module:function(e){return{id:e,uri:"",exports:s[e],config:y(e)}}},t=function(t,n,u,f){var l,h,d,g,y,b=[],w;f=f||t;if(typeof u=="function"){n=!n.length&&u.length?["require","exports","module"]:n;for(y=0;y<n.length;y+=1){g=r(n[y],f),h=g.f;if(h==="require")b[y]=i.require(t);else if(h==="exports")b[y]=i.exports(t),w=!0;else if(h==="module")l=b[y]=i.module(t);else if(c(s,h)||c(o,h)||c(a,h))b[y]=m(h);else{if(!g.p)throw new Error(t+" missing "+h);g.p.load(g.n,p(f,!0),v(h),{}),b[y]=s[h]}}d=u.apply(s[t],b);if(t)if(l&&l.exports!==e&&l.exports!==s[t])s[t]=l.exports;else if(d!==e||!w)s[t]=d}else t&&(s[t]=u)},requirejs=require=n=function(s,o,a,f,l){return typeof s=="string"?i[s]?i[s](o):m(r(s,o).f):(s.splice||(u=s,o.splice?(s=o,o=a,a=null):s=e),o=o||function(){},typeof a=="function"&&(a=f,f=l),f?t(e,s,o,a):setTimeout(function(){t(e,s,o,a)},4),n)},n.config=function(e){return u=e,n},define=function(e,t,n){t.splice||(n=t,t=[]),!c(s,e)&&!c(o,e)&&(o[e]=[e,t,n])},define.amd={jQuery:!0}})(),define("almond",function(){}),define("orion/editor/eventTarget",[],function(){function e(){}return e.addMixin=function(t){var n=e.prototype;for(var r in n)n.hasOwnProperty(r)&&(t[r]=n[r])},e.prototype={addEventListener:function(e,t,n){this._eventTypes||(this._eventTypes={});var r=this._eventTypes[e];r||(r=this._eventTypes[e]={level:0,listeners:[]});var i=r.listeners;i.push({listener:t,useCapture:n})},dispatchEvent:function(e){var t=e.type;this._dispatchEvent("pre"+t,e),this._dispatchEvent(t,e),this._dispatchEvent("post"+t,e)},_dispatchEvent:function(e,t){var n=this._eventTypes?this._eventTypes[e]:null;if(n){var r=n.listeners;try{n.level++;if(r)for(var i=0,s=r.length;i<s;i++)if(r[i]){var o=r[i].listener;typeof o=="function"?o.call(this,t):o.handleEvent&&typeof o.handleEvent=="function"&&o.handleEvent(t)}}finally{n.level--;if(n.compact&&n.level===0){for(var u=r.length-1;u>=0;u--)r[u]||r.splice(u,1);r.length===0&&delete this._eventTypes[e],n.compact=!1}}}},isListening:function(e){return this._eventTypes?this._eventTypes[e]!==undefined:!1},removeEventListener:function(e,t,n){if(!this._eventTypes)return;var r=this._eventTypes[e];if(r){var i=r.listeners;for(var s=0,o=i.length;s<o;s++){var u=i[s];if(u&&u.listener===t&&u.useCapture===n){r.level!==0?(i[s]=null,r.compact=!0):i.splice(s,1);break}}i.length===0&&delete this._eventTypes[e]}}},{EventTarget:e}}),define("orion/editor/util",[],function(){function v(e){var t=arguments;return e.replace(/\$\{([^\}]+)\}/g,function(e,n){return t[(n<<0)+1]})}function g(e,t){return e.createElementNS?e.createElementNS(m,t):e.createElement(t)}var e=navigator.userAgent,t=parseFloat(e.split("MSIE")[1])||undefined,n=parseFloat(e.split("Firefox/")[1]||e.split("Minefield/")[1])||undefined,r=e.indexOf("Opera")!==-1,i=parseFloat(e.split("Chrome/")[1])||undefined,s=e.indexOf("Safari")!==-1&&!i,o=parseFloat(e.split("WebKit/")[1])||undefined,u=e.indexOf("Android")!==-1,a=e.indexOf("iPad")!==-1,f=e.indexOf("iPhone")!==-1,l=a||f,c=navigator.platform.indexOf("Mac")!==-1,h=navigator.platform.indexOf("Win")!==-1,p=navigator.platform.indexOf("Linux")!==-1,d=h?"\r\n":"\n",m="http://www.w3.org/1999/xhtml";return{formatMessage:v,createElement:g,isIE:t,isFirefox:n,isOpera:r,isChrome:i,isSafari:s,isWebkit:o,isAndroid:u,isIPad:a,isIPhone:f,isIOS:l,isMac:c,isWindows:h,isLinux:p,platformDelimiter:d}}),define("orion/editor/textModel",["orion/editor/eventTarget","orion/editor/util"],function(e,t){function n(e,t){this._lastLineIndex=-1,this._text=[""],this._lineOffsets=[0],this.setText(e),this.setLineDelimiter(t)}return n.prototype={find:function(e){this._text.length>1&&(this._text=[this._text.join("")]);var t=e.string,n=e.regex,r=t;!n&&t&&(r=t.replace(/([\\$\^*\/+?\.\(\)|{}\[\]])/g,"\\$&"));var i=null,s;if(r){var o=e.reverse,u=e.wrap,a=e.wholeWord,f=e.caseInsensitive,l=e.start||0,c=e.end,h=e.end!==undefined,p="";p.indexOf("g")===-1&&(p+="g"),f&&p.indexOf("i")===-1&&(p+="i"),a&&(r="\\b"+r+"\\b");var d=this._text[0],v,m,g=0;h&&(d=d.substring(l,c),g=l);var y=new RegExp(r,p);o?s=function(){var e=null;y.lastIndex=0;for(;;){m=y.lastIndex,v=y.exec(d);if(m===y.lastIndex)return null;if(!v)break;if(v.index<l)e={start:v.index+g,end:y.lastIndex+g};else{if(!u||e)break;l=d.length,e={start:v.index+g,end:y.lastIndex+g}}}return e&&(l=e.start),e}:(h||(y.lastIndex=l),s=function(){for(;;){m=y.lastIndex,v=y.exec(d);if(m===y.lastIndex)return null;if(v)return{start:v.index+g,end:y.lastIndex+g};if(m!==0&&u)continue;break}return null}),i=s()}return{next:function(){var e=i;return e&&(i=s()),e},hasNext:function(){return i!==null}}},getCharCount:function(){var e=0;for(var t=0;t<this._text.length;t++)e+=this._text[t].length;return e},getLine:function(e,t){var n=this.getLineCount();if(0<=e&&e<n){var r=this._lineOffsets[e];if(e+1<n){var i=this.getText(r,this._lineOffsets[e+1]);if(t)return i;var s=i.length,o;while((o=i.charCodeAt(s-1))===10||o===13)s--;return i.substring(0,s)}return this.getText(r)}return null},getLineAtOffset:function(e){var t=this.getCharCount();if(0<=e&&e<=t){var n=this.getLineCount();if(e===t)return n-1;var r,i,s=this._lastLineIndex;if(0<=s&&s<n){r=this._lineOffsets[s],i=s+1<n?this._lineOffsets[s+1]:t;if(r<=e&&e<i)return s}var o=n,u=-1;while(o-u>1){s=Math.floor((o+u)/2),r=this._lineOffsets[s],i=s+1<n?this._lineOffsets[s+1]:t;if(e<=r)o=s;else{if(e<i){o=s;break}u=s}}return this._lastLineIndex=o,o}return-1},getLineCount:function(){return this._lineOffsets.length},getLineDelimiter:function(){return this._lineDelimiter},getLineEnd:function(e,t){var n=this.getLineCount();if(0<=e&&e<n){if(e+1<n){var r=this._lineOffsets[e+1];if(t)return r;var i=this.getText(Math.max(this._lineOffsets[e],r-2),r),s=i.length,o;while((o=i.charCodeAt(s-1))===10||o===13)s--;return r-(i.length-s)}return this.getCharCount()}return-1},getLineStart:function(e){return 0<=e&&e<this.getLineCount()?this._lineOffsets[e]:-1},getText:function(e,t){e===undefined&&(e=0),t===undefined&&(t=this.getCharCount());if(e===t)return"";var n=0,r=0,i;while(r<this._text.length){i=this._text[r].length;if(e<=n+i)break;n+=i,r++}var s=n,o=r;while(r<this._text.length){i=this._text[r].length;if(t<=n+i)break;n+=i,r++}var u=n,a=r;if(o===a)return this._text[o].substring(e-s,t-u);var f=this._text[o].substring(e-s),l=this._text[a].substring(0,t-u);return f+this._text.slice(o+1,a).join("")+l},onChanging:function(e){return this.dispatchEvent(e)},onChanged:function(e){return this.dispatchEvent(e)},setLineDelimiter:function(e,n){e==="auto"&&(e=undefined,this.getLineCount()>1&&(e=this.getText(this.getLineEnd(0),this.getLineEnd(0,!0)))),this._lineDelimiter=e?e:t.platformDelimiter;if(n){var r=this.getLineCount();if(r>1){var i=new Array(r);for(var s=0;s<r;s++)i[s]=this.getLine(s);this.setText(i.join(this._lineDelimiter))}}},setText:function(e,t,n){e===undefined&&(e=""),t===undefined&&(t=0),n===undefined&&(n=this.getCharCount());if(t===n&&e==="")return;var r=this.getLineAtOffset(t),i=this.getLineAtOffset(n),s=t,o=n-t,u=i-r,a=e.length,f=0,l=this.getLineCount(),c=0,h=0,p=0,d=[];for(;;){c!==-1&&c<=p&&(c=e.indexOf("\r",p)),h!==-1&&h<=p&&(h=e.indexOf("\n",p));if(h===-1&&c===-1)break;c!==-1&&h!==-1?c+1===h?p=h+1:p=(c<h?c:h)+1:c!==-1?p=c+1:p=h+1,d.push(t+p),f++}var v={type:"Changing",text:e,start:s,removedCharCount:o,addedCharCount:a,removedLineCount:u,addedLineCount:f};this.onChanging(v);if(d.length===0){var m=this.getLineStart(r),g;i+1<l?g=this.getLineStart(i+1):g=this.getCharCount(),t!==m&&(e=this.getText(m,t)+e,t=m),n!==g&&(e+=this.getText(n,g),n=g)}var y=a-o;for(var b=r+u+1;b<l;b++)this._lineOffsets[b]+=y;var w=[r+1,u].concat(d);Array.prototype.splice.apply(this._lineOffsets,w);var E=0,S=0,x;while(S<this._text.length){x=this._text[S].length;if(t<=E+x)break;E+=x,S++}var T=E,N=S;while(S<this._text.length){x=this._text[S].length;if(n<=E+x)break;E+=x,S++}var C=E,k=S,L=this._text[N],A=this._text[k],O=L.substring(0,t-T),M=A.substring(n-C),_=[N,k-N+1];O&&_.push(O),e&&_.push(e),M&&_.push(M),Array.prototype.splice.apply(this._text,_),this._text.length===0&&(this._text=[""]);var D={type:"Changed",start:s,removedCharCount:o,addedCharCount:a,removedLineCount:u,addedLineCount:f};this.onChanged(D)}},e.EventTarget.addMixin(n.prototype),{TextModel:n}}),define("orion/editor/keyBinding",["orion/editor/util"],function(e){function t(e,t,n,r,i){typeof e=="string"?this.keyCode=e.toUpperCase().charCodeAt(0):this.keyCode=e,this.mod1=t!==undefined&&t!==null?t:!1,this.mod2=n!==undefined&&n!==null?n:!1,this.mod3=r!==undefined&&r!==null?r:!1,this.mod4=i!==undefined&&i!==null?i:!1}return t.prototype={match:function(t){if(this.keyCode===t.keyCode){var n=e.isMac?t.metaKey:t.ctrlKey;return this.mod1!==n?!1:this.mod2!==t.shiftKey?!1:this.mod3!==t.altKey?!1:e.isMac&&this.mod4!==t.ctrlKey?!1:!0}return!1},equals:function(e){return e?this.keyCode!==e.keyCode?!1:this.mod1!==e.mod1?!1:this.mod2!==e.mod2?!1:this.mod3!==e.mod3?!1:this.mod4!==e.mod4?!1:!0:!1}},{KeyBinding:t}}),define("orion/editor/textView",["orion/editor/textModel","orion/editor/keyBinding","orion/editor/eventTarget","orion/editor/util"],function(e,t,n,r){function i(e){return e.defaultView||e.parentWindow}function s(e,t,n,r){typeof e.addEventListener=="function"?e.addEventListener(t,n,r===!0):e.attachEvent("on"+t,n)}function o(e,t,n,r){typeof e.removeEventListener=="function"?e.removeEventListener(t,n,r===!0):e.detachEvent("on"+t,n)}function u(e,t,n){if(n){t.className="";var i=t.attributes;for(var s=i.length;s-->0;)(!r.isIE||r.isIE>=9||r.isIE<9&&i[s].specified)&&t.removeAttribute(i[s].name)}if(!e)return;e.styleClass&&(t.className=e.styleClass);var o=e.style;if(o)for(var u in o)o.hasOwnProperty(u)&&(t.style[u]=o[u]);var a=e.attributes;if(a)for(var f in a)a.hasOwnProperty(f)&&t.setAttribute(f,a[f])}function a(e){return e instanceof Array?e.slice(0):e}function f(e,t){if(e===t)return!0;if(e&&!t||!e&&t)return!1;if(e&&e.constructor===String||t&&t.constructor===String)return!1;if(e instanceof Array||t instanceof Array){if(e instanceof Array&&t instanceof Array){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(!f(e[n],t[n]))return!1;return!0}return!1}if(e instanceof Object&&t instanceof Object){var r;for(r in e)if(e.hasOwnProperty(r)){if(!t.hasOwnProperty(r))return!1;if(!f(e[r],t[r]))return!1}for(r in t)if(!e.hasOwnProperty(r))return!1;return!0}return!1}function l(e,t,n){var r=0,i=0,s=0,o=e.length;while(s<o){r!==-1&&r<=s&&(r=e.indexOf("\r",s)),i!==-1&&i<=s&&(i=e.indexOf("\n",s));var u=s,a;if(i===-1&&r===-1){t(e.substring(s));break}r!==-1&&i!==-1?r+1===i?(a=r,s=i+1):(a=r<i?r:i,s=(r<i?r:i)+1):r!==-1?(a=r,s=r+1):(a=i,s=i+1),t(e.substring(u,a)),n()}}function c(e){var t,n,r,s,o=i(e.ownerDocument);if(o.getComputedStyle){var u=o.getComputedStyle(e,null);t=u.getPropertyValue("border-left-width"),n=u.getPropertyValue("border-top-width"),r=u.getPropertyValue("border-right-width"),s=u.getPropertyValue("border-bottom-width")}else e.currentStyle&&(t=e.currentStyle.borderLeftWidth,n=e.currentStyle.borderTopWidth,r=e.currentStyle.borderRightWidth,s=e.currentStyle.borderBottomWidth);return{left:parseInt(t,10)||0,top:parseInt(n,10)||0,right:parseInt(r,10)||0,bottom:parseInt(s,10)||0}}function h(e){var t,n,r,s,o=i(e.ownerDocument);if(o.getComputedStyle){var u=o.getComputedStyle(e,null);t=u.getPropertyValue("padding-left"),n=u.getPropertyValue("padding-top"),r=u.getPropertyValue("padding-right"),s=u.getPropertyValue("padding-bottom")}else e.currentStyle&&(t=e.currentStyle.paddingLeft,n=e.currentStyle.paddingTop,r=e.currentStyle.paddingRight,s=e.currentStyle.paddingBottom);return{left:parseInt(t,10)||0,top:parseInt(n,10)||0,right:parseInt(r,10)||0,bottom:parseInt(s,10)||0}}function p(e){var t=e._trim;if(!t){t=h(e);var n=c(e);t.left+=n.left,t.top+=n.top,t.right+=n.right,t.bottom+=n.bottom,e._trim=t}return t}function d(e,t,n){this.start=e,this.end=t,this.caret=n}function v(e){this.left=e.left,this.top=e.top,this.right=e.right,this.bottom=e.bottom}function m(e,t,n){this.view=e,this.lineIndex=t,this._lineDiv=n}function g(e){this._init(e)}return d.prototype={clone:function(){return new d(this.start,this.end,this.caret)},collapse:function(){this.caret?this.end=this.start:this.start=this.end},extend:function(e){this.caret?this.start=e:this.end=e;if(this.start>this.end){var t=this.start;this.start=this.end,this.end=t,this.caret=!this.caret}},setCaret:function(e){this.start=e,this.end=e,this.caret=!1},getCaret:function(){return this.caret?this.start:this.end},toString:function(){return"start="+this.start+" end="+this.end+(this.caret?" caret is at start":" caret is at end")},isEmpty:function(){return this.start===this.end},equals:function(e){return this.caret===e.caret&&this.start===e.start&&this.end===e.end}},v.prototype={toString:function(){return"{l="+this.left+", t="+this.top+", r="+this.right+", b="+this.bottom+"}"}},m.prototype={create:function(e,t){if(this._lineDiv)return;var n=this._lineDiv=this._createLine(e,t,this.lineIndex);return n._line=this,n},_createLine:function(e,t,n){var i=this.view,s=i._model,o=s.getLine(n),a=s.getLineStart(n),l={type:"LineStyle",textView:i,lineIndex:n,lineText:o,lineStart:a};o.length<2e3&&i.onLineStyle(l);var c=t||r.createElement(e.ownerDocument,"div");if(!t||!f(t.viewStyle,l.style))u(l.style,c,t),t&&(t._trim=null),c.viewStyle=l.style,c.setAttribute("role","presentation");c.lineIndex=n;var h=[],p={tabOffset:0,ranges:h};this._createRanges(l.ranges,o,0,o.length,a,p);var d=" ";!i._fullSelection&&r.isIE<9&&(d="\ufeff"),r.isWebkit&&(d="\u200c"),h.push({text:d,style:i._metrics.largestFontStyle,ignoreChars:1});var v,m,g,y,b,w,E,S=0,x=0,T,N,C;if(t){var k=t.modelChangedEvent;k&&(k.removedLineCount===0&&k.addedLineCount===0?(C=k.start-a,N=k.addedCharCount-k.removedCharCount):C=-1,t.modelChangedEvent=undefined),y=t.firstChild}for(var L=0;L<h.length;L++){v=h[L],w=v.text,S+=w.length,g=v.style;if(y){E=y.firstChild.data,b=y.viewStyle;if(E===w&&f(g,b)){x+=E.length,y._rectsCache=undefined,m=y=y.nextSibling;continue}while(y){if(C!==-1){var A=S;A>=C&&(A-=N);var O=y.firstChild.data,M=O?O.length:0;if(x+M>A)break;x+=M}T=y.nextSibling,c.removeChild(y),y=T}}m=this._createSpan(c,w,g,v.ignoreChars),y?c.insertBefore(m,y):c.appendChild(m),t&&(t.lineWidth=undefined)}if(t){var _=m?m.nextSibling:null;while(_)T=_.nextSibling,t.removeChild(_),_=T}else e.appendChild(c);return c},_createRanges:function(e,t,n,r,i,s){if(n>=r)return;if(e)for(var o=0;o<e.length;o++){var u=e[o];if(u.end<=i+n)continue;var a=Math.max(i+n,u.start)-i;if(a>=r)break;var l=Math.min(i+r,u.end)-i;if(a<l){a=Math.max(n,a),l=Math.min(r,l),n<a&&this._createRange(t,n,a,null,s);while(o+1<e.length&&e[o+1].start-i===l&&f(u.style,e[o+1].style))u=e[o+1],l=Math.min(i+r,u.end)-i,o++;this._createRange(t,a,l,u.style,s),n=l}}n<r&&this._createRange(t,n,r,null,s)},_createRange:function(e,t,n,r,i){if(t>=n)return;var s=this.view._customTabSize,o;if(s&&s!==8){var u=e.indexOf("	",t);while(u!==-1&&u<n){t<u&&(o={text:e.substring(t,u),style:r},i.ranges.push(o),i.tabOffset+=o.text.length);var a=s-i.tabOffset%s;if(a>0){var f="\u00a0";for(var l=1;l<a;l++)f+=" ";o={text:f,style:r,ignoreChars:a-1},i.ranges.push(o),i.tabOffset+=o.text.length}t=u+1,u=e.indexOf("	",t)}}t<n&&(o={text:e.substring(t,n),style:r},i.ranges.push(o),i.tabOffset+=o.text.length)},_createSpan:function(e,t,n,i){var o=n&&n.tagName==="A";o&&(e.hasLink=!0);var a=o&&this.view._linksVisible?"a":"span",f=e.ownerDocument,l=r.createElement(e.ownerDocument,a);l.appendChild(f.createTextNode(t)),u(n,l);if(a==="A"){var c=this.view,h=this._getWindow();s(l,"click",function(e){return c._handleLinkClick(e?e:h.event)},!1)}return l.viewStyle=n,i&&(l.ignoreChars=i),l},_ensureCreated:function(){return this._lineDiv?this._lineDiv:this._createdDiv=this.create(this.view._clientDiv,null)},getBoundingClientRect:function(e,t){var n=this._ensureCreated(),s=this.view;if(e===undefined)return this._getLineBoundingClientRect(n,!0);var o=s._model,u=n.ownerDocument,a=this.lineIndex,f=null;if(e<o.getLineEnd(a)){var l=o.getLineStart(a),c=n.firstChild;while(c){var h=c.firstChild,p=h.length;c.ignoreChars&&(p-=c.ignoreChars);if(l+p>e){var d=e-l,m;if(s._isRangeRects)m=u.createRange(),m.setStart(h,d),m.setEnd(h,d+1),f=new v(m.getBoundingClientRect());else if(r.isIE)m=u.body.createTextRange(),m.moveToElementText(c),m.collapse(),m.moveEnd("character",d+1),m.moveStart("character",d),f=new v(m.getBoundingClientRect());else{var g=h.data;c.removeChild(h),c.appendChild(u.createTextNode(g.substring(0,d)));var y=r.createElement(u,"span");y.appendChild(u.createTextNode(g.substring(d,d+1))),c.appendChild(y),c.appendChild(u.createTextNode(g.substring(d+1))),f=new v(y.getBoundingClientRect()),c.innerHTML="",c.appendChild(h);if(!this._createdDiv){var b=s._getSelection();(l<=b.start&&b.start<l+p||l<=b.end&&b.end<l+p)&&s._updateDOMSelection()}}if(r.isIE){var w=i(n.ownerDocument),E=w.screen.logicalXDPI/w.screen.deviceXDPI,S=w.screen.logicalYDPI/w.screen.deviceYDPI;f.left=f.left*E,f.right=f.right*E,f.top=f.top*S,f.bottom=f.bottom*S}break}l+=p,c=c.nextSibling}}var x=this.getBoundingClientRect();if(!f)if(s._wrapMode){var T=this.getClientRects();f=T[T.length-1],f.left=f.right,f.left+=x.left,f.top+=x.top,f.right+=x.left,f.bottom+=x.top}else f=new v(x),f.left=f.right;if(t||t===undefined)f.left-=x.left,f.top-=x.top,f.right-=x.left,f.bottom-=x.top;return f},_getClientRects:function(e,t){var n,r,i,s;if(!e._rectsCache){n=e.getClientRects(),r=new Array(n.length);for(s=0;s<n.length;s++)i=r[s]=new v(n[s]),i.left-=t.left,i.top-=t.top,i.right-=t.left,i.bottom-=t.top;e._rectsCache=r}n=e._rectsCache,r=[n.length];for(s=0;s<n.length;s++)r[s]=new v(n[s]);return r},getClientRects:function(e){if(!this.view._wrapMode)return[this.getBoundingClientRect()];var t=this._ensureCreated(),n=[],r=t.firstChild,i,s,o=t.getBoundingClientRect();while(r){var u=this._getClientRects(r,o);for(i=0;i<u.length;i++){var a=u[i],f;if(a.top===a.bottom)continue;var l=a.top+(a.bottom-a.top)/2;for(f=0;f<n.length;f++){s=n[f];if(s.top<=l&&l<s.bottom)break}f===n.length?n.push(a):(a.left<s.left&&(s.left=a.left),a.top<s.top&&(s.top=a.top),a.right>s.right&&(s.right=a.right),a.bottom>s.bottom&&(s.bottom=a.bottom))}r=r.nextSibling}return e!==undefined?n[e]:n},_getLineBoundingClientRect:function(e,t){var n=new v(e.getBoundingClientRect());if(!this.view._wrapMode){n.right=n.left;var r=e.lastChild;while(r&&r.ignoreChars===r.firstChild.length)r=r.previousSibling;if(r){var i=r.getBoundingClientRect();n.right=i.right+p(e).right}}if(t){var s=p(e);n.left=n.left+s.left,n.right=n.right-s.right}return n},getLineCount:function(){return this.view._wrapMode?this.getClientRects().length:1},getLineIndex:function(e){if(!this.view._wrapMode)return 0;var t=this.getClientRects(),n=this.getBoundingClientRect(e),r=n.top+(n.bottom-n.top)/2;for(var i=0;i<t.length;i++)if(t[i].top<=r&&r<t[i].bottom)return i;return t.length-1},getLineStart:function(e){if(!this.view._wrapMode||e===0)return this.view._model.getLineStart(e);var t=this.getClientRects();return this.getOffset(t[e].left+1,t[e].top+1)},getOffset:function(e,t){var n=this.view,s=n._model,o=this.lineIndex,u=s.getLineStart(o),a=s.getLineEnd(o);if(u===a)return u;var f=this._ensureCreated(),l=this.getBoundingClientRect(),c,h;if(n._wrapMode){c=this.getClientRects(),t<c[0].top&&(t=c[0].top);for(var p=0;p<c.length;p++){h=c[p];if(h.top<=t&&t<h.bottom)break}e<h.left&&(e=h.left),e>h.right&&(e=h.right-1)}else e<0&&(e=0),e>l.right-l.left&&(e=l.right-l.left);var d=f.ownerDocument,v=i(d),m=r.isIE?v.screen.logicalXDPI/v.screen.deviceXDPI:1,g=r.isIE?v.screen.logicalYDPI/v.screen.deviceYDPI:1,y=u,b=f.firstChild;e:while(b){var w=b.firstChild,E=w.length;b.ignoreChars&&(E-=b.ignoreChars);var S,x,T,N;c=this._getClientRects(b,l);for(var C=0;C<c.length;C++){h=c[C];if(h.left<=e&&e<h.right&&(!n._wrapMode||h.top<=t&&t<h.bottom)){var k,L,A;if(r.isIE||n._isRangeRects){k=n._isRangeRects?d.createRange():d.body.createTextRange();var O=E,M=-1;while(O-M>1){var _=Math.floor((O+M)/2);L=M+1,A=_===E-1&&b.ignoreChars?w.length:_+1,n._isRangeRects?(k.setStart(w,L),k.setEnd(w,A)):(k.moveToElementText(b),k.move("character",L),k.moveEnd("character",A-L)),c=k.getClientRects();var D=!1;for(var P=0;P<c.length;P++){h=c[P],S=h.left*m-l.left,T=h.right*m-l.left,x=h.top*g-l.top,N=h.bottom*g-l.top;if(S<=e&&e<T&&(!n._wrapMode||x<=t&&t<N)){D=!0;break}}D?O=_:M=_}y+=O,L=O,A=O===E-1&&b.ignoreChars?w.length:Math.min(O+1,w.length),n._isRangeRects?(k.setStart(w,L),k.setEnd(w,A)):(k.moveToElementText(b),k.move("character",L),k.moveEnd("character",A-L)),h=k.getClientRects()[0],S=h.left*m-l.left,T=h.right*m-l.left,e>S+(T-S)/2&&y++}else{var H=[];for(var B=0;B<E;B++)H.push("<span>"),B===E-1?H.push(w.data.substring(B)):H.push(w.data.substring(B,B+1)),H.push("</span>");b.innerHTML=H.join("");var j=b.firstChild;while(j){h=j.getBoundingClientRect(),S=h.left-l.left,T=h.right-l.left;if(S<=e&&e<T){e>S+(T-S)/2&&y++;break}y++,j=j.nextSibling}if(!this._createdDiv){b.innerHTML="",b.appendChild(w);var F=n._getSelection();(y<=F.start&&F.start<y+E||y<=F.end&&F.end<y+E)&&n._updateDOMSelection()}}break e}}y+=E,b=b.nextSibling}return Math.min(a,Math.max(u,y))},getNextOffset:function(e,t,n){if(t==="line"){var i=this.view,s=i._model,o=s.getLineAtOffset(e);return n>0?s.getLineEnd(o):s.getLineStart(o)}return t==="wordend"?this._getNextOffset_W3C(e,t,n):r.isIE?this._getNextOffset_IE(e,t,n):this._getNextOffset_W3C(e,t,n)},_getNextOffset_W3C:function(e,t,n){function r(e){return 33<=e&&e<=47||58<=e&&e<=64||91<=e&&e<=94||e===96||123<=e&&e<=126}function i(e){return e===32||e===9}if(t==="word"||t==="wordend"){var s=this.view,o=s._model,u=o.getLineAtOffset(e),a=o.getLine(u),f=o.getLineStart(u),l=o.getLineEnd(u),c=a.length,h=e-f,p,d,v,m,g;if(n>0){if(h===c)return l;p=a.charCodeAt(h),d=r(p),v=!d&&!i(p),h++;while(h<c){p=a.charCodeAt(h),m=r(p);if(t==="wordend"){if(!m&&d)break}else if(m&&!d)break;g=!m&&!i(p);if(t==="wordend"){if(!g&&v)break}else if(g&&!v)break;v=g,d=m,h++}}else{if(h===0)return f;h--,p=a.charCodeAt(h),d=r(p),v=!d&&!i(p);while(0<h){p=a.charCodeAt(h-1),m=r(p);if(t==="wordend"){if(m&&!d)break}else if(!m&&d)break;g=!m&&!i(p);if(t==="wordend"){if(g&&!v)break}else if(!g&&v)break;v=g,d=m,h--}}return f+h}return e+n},_getNextOffset_IE:function(e,t,n){var r=this._ensureCreated(),i=this.view,s=i._model,o=this.lineIndex,u=0,a,f,l=s.getLineStart(o),c=r.ownerDocument;if(e===s.getLineEnd(o))a=c.body.createTextRange(),a.moveToElementText(r.lastChild),f=a.text.length,a.moveEnd(t,n),u=e+a.text.length-f;else if(e===l&&n<0)u=l;else{var h=r.firstChild;while(h){var p=h.firstChild,d=p.length;h.ignoreChars&&(d-=h.ignoreChars);if(l+d>e){a=c.body.createTextRange(),e===l&&n<0?a.moveToElementText(h.previousSibling):(a.moveToElementText(h),a.collapse(),a.moveEnd("character",e-l)),f=a.text.length,a.moveEnd(t,n),u=e+a.text.length-f;break}l=d+l,h=h.nextSibling}}return u},destroy:function(){var e=this._createdDiv;e&&(e.parentNode.removeChild(e),this._createdDiv=null)}},g.prototype={addRuler:function(e,t){e.setView(this);var n=this._rulers;if(t!==undefined){var r,i;for(r=0,i=0;r<n.length&&i<t;r++)e.getLocation()===n[r].getLocation()&&i++;n.splice(i,0,e),t=i}else n.push(e);this._createRuler(e,t),this._update()},computeSize:function(){var e=0,t=0,n=this._model,i=this._clientDiv;if(!i)return{width:e,height:t};var s=i.style.width;r.isWebkit&&(i.style.width="0x7fffffffpx");var o=n.getLineCount();for(var u=0;u<o;u++){var a=this._getLine(u),f=a.getBoundingClientRect();e=Math.max(e,f.right-f.left),t+=f.bottom-f.top,a.destroy()}r.isWebkit&&(i.style.width=s);var l=this._getViewPadding();return e+=l.right+l.left,t+=l.bottom+l.top,{width:e,height:t}},convert:function(e,t,n){if(!this._clientDiv)return;var r=this._getScroll(),i=this._getViewPadding(),s=this._viewDiv.getBoundingClientRect();return t==="document"&&(e.x!==undefined&&(e.x+=-r.x+s.left+i.left),e.y!==undefined&&(e.y+=-r.y+s.top+i.top)),n==="document"&&(e.x!==undefined&&(e.x+=r.x-s.left-i.left),e.y!==undefined&&(e.y+=r.y-s.top-i.top)),e},destroy:function(){for(var e=0;e<this._rulers.length;e++)this._rulers[e].setView(null);this.rulers=null,this._destroyView();var t={type:"Destroy"};this.onDestroy(t),this._parent=null,this._model=null,this._selection=null,this._doubleClickSelection=null,this._keyBindings=null,this._actions=null},focus:function(){if(!this._clientDiv)return;this._updateDOMSelection(),r.isOpera&&this._clientDiv.blur(),this._clientDiv.focus(),this._updateDOMSelection()},hasFocus:function(){return this._hasFocus},getActionDescription:function(e){var t=this._actions[e];return t?t.actionDescription:undefined},getActions:function(e){var t=[],n=this._actions;for(var r in n)if(n.hasOwnProperty(r)){if(!e&&n[r].defaultHandler)continue;t.push(r)}return t},getBottomIndex:function(e){return this._clientDiv?this._getBottomIndex(e):0},getBottomPixel:function(){return this._clientDiv?this._getScroll().y+this._getClientHeight():0},getCaretOffset:function(){var e=this._getSelection();return e.getCaret()},getClientArea:function(){if(!this._clientDiv)return{x:0,y:0,width:0,height:0};var e=this._getScroll();return{x:e.x,y:e.y,width:this._getClientWidth(),height:this._getClientHeight()}},getHorizontalPixel:function(){return this._clientDiv?this._getScroll().x:0},getKeyBindings:function(e){var t=[],n=this._keyBindings;for(var r=0;r<n.length;r++)n[r].actionID===e&&t.push(n[r].keyBinding);return t},getLineHeight:function(e){return this._clientDiv?this._getLineHeight(e):0},getLineIndex:function(e){return this._clientDiv?this._getLineIndex(e):0},getLinePixel:function(e){return this._clientDiv?this._getLinePixel(e):0},getLocationAtOffset:function(e){if(!this._clientDiv)return{x:0,y:0};var t=this._model;e=Math.min(Math.max(0,e),t.getCharCount());var n=t.getLineAtOffset(e),r=this._getLine(n),i=r.getBoundingClientRect(e);r.destroy();var s=i.left,o=this._getLinePixel(n)+i.top;return{x:s,y:o}},getOptions:function(){var e;if(arguments.length===0)e=this._defaultOptions();else if(arguments.length===1){var t=arguments[0];if(typeof t=="string")return a(this["_"+t]);e=t}else{e={};for(var n in arguments)arguments.hasOwnProperty(n)&&(e[arguments[n]]=undefined)}for(var r in e)e.hasOwnProperty(r)&&(e[r]=a(this["_"+r]));return e},getModel:function(){return this._model},getOffsetAtLocation:function(e,t){if(!this._clientDiv)return 0;var n=this._getLineIndex(t),r=this._getLine(n),i=r.getOffset(e,t-this._getLinePixel(n));return r.destroy(),i},getRulers:function(){return this._rulers.slice(0)},getSelection:function(){var e=this._getSelection();return{start:e.start,end:e.end}},getText:function(e,t){var n=this._model;return n.getText(e,t)},getTopIndex:function(e){return this._clientDiv?this._getTopIndex(e):0},getTopPixel:function(){return this._clientDiv?this._getScroll().y:0},invokeAction:function(e,t){if(!this._clientDiv)return;var n=this._actions[e];if(n){if(!t&&n.handler&&n.handler())return;if(n.defaultHandler)return n.defaultHandler()}return!1},isDestroyed:function(){return!this._clientDiv},onContextMenu:function(e){return this.dispatchEvent(e)},onDragStart:function(e){return this.dispatchEvent(e)},onDrag:function(e){return this.dispatchEvent(e)},onDragEnd:function(e){return this.dispatchEvent(e)},onDragEnter:function(e){return this.dispatchEvent(e)},onDragOver:function(e){return this.dispatchEvent(e)},onDragLeave:function(e){return this.dispatchEvent(e)},onDrop:function(e){return this.dispatchEvent(e)},onDestroy:function(e){return this.dispatchEvent(e)},onLineStyle:function(e){return this.dispatchEvent(e)},onModelChanged:function(e){return this.dispatchEvent(e)},onModelChanging:function(e){return this.dispatchEvent(e)},onModify:function(e){return this.dispatchEvent(e)},onMouseDown:function(e){return this.dispatchEvent(e)},onMouseUp:function(e){return this.dispatchEvent(e)},onMouseMove:function(e){return this.dispatchEvent(e)},onMouseOver:function(e){return this.dispatchEvent(e)},onMouseOut:function(e){return this.dispatchEvent(e)},onSelection:function(e){return this.dispatchEvent(e)},onScroll:function(e){return this.dispatchEvent(e)},onVerify:function(e){return this.dispatchEvent(e)},onFocus:function(e){return this.dispatchEvent(e)},onBlur:function(e){return this.dispatchEvent(e)},redraw:function(){if(this._redrawCount>0)return;var e=this._model.getLineCount();this.redrawRulers(0,e),this.redrawLines(0,e)},redrawRulers:function(e,t){if(this._redrawCount>0)return;var n=this.getRulers();for(var r=0;r<n.length;r++)this.redrawLines(e,t,n[r])},redrawLines:function(e,t,n){if(this._redrawCount>0)return;e===undefined&&(e=0),t===undefined&&(t=this._model.getLineCount());if(e===t)return;var r=this._clientDiv;if(!r)return;if(n){var i=n.getLocation(),s=i==="left"?this._leftDiv:this._rightDiv,o=s.firstChild.rows[0].cells;for(var u=0;u<o.length;u++)if(o[u].firstChild._ruler===n){r=o[u].firstChild;break}}n?r.rulerChanged=!0:this._lineHeight&&this._resetLineHeight(e,t);if(!n||n.getOverview()==="page"){var a=r.firstChild;while(a){var f=a.lineIndex;e<=f&&f<t&&(a.lineChanged=!0),a=a.nextSibling}}n||this._wrapMode||e<=this._maxLineIndex&&this._maxLineIndex<t&&(this._checkMaxLineIndex=this._maxLineIndex,this._maxLineIndex=-1,this._maxLineWidth=0),this._queueUpdate()},redrawRange:function(e,t){if(this._redrawCount>0)return;var n=this._model;e===undefined&&(e=0),t===undefined&&(t=n.getCharCount());var r=n.getLineAtOffset(e),i=n.getLineAtOffset(Math.max(e,t-1))+1;this.redrawLines(r,i)},removeRuler:function(e){var t=this._rulers;for(var n=0;n<t.length;n++)if(t[n]===e){t.splice(n,1),e.setView(null),this._destroyRuler(e),this._update();break}},resize:function(){if(!this._clientDiv)return;this._handleResize(null)},setAction:function(e,t,n){if(!e)return;var r=this._actions,i=r[e];i||(i=r[e]={}),i.handler=t,i.actionDescription=n},setKeyBinding:function(e,t){var n=this._keyBindings;for(var r=0;r<n.length;r++){var i=n[r];if(i.keyBinding.equals(e)){t?i.actionID=t:i.predefined?i.actionID=null:n.splice(r,1);return}}t&&n.push({keyBinding:e,actionID:t})},setCaretOffset:function(e,t){var n=this._model.getCharCount();e=Math.max(0,Math.min(e,n));var r=new d(e,e,!1);this._setSelection(r,t===undefined||t)},setHorizontalPixel:function(e){if(!this._clientDiv)return;e=Math.max(0,e),this._scrollView(e-this._getScroll().x,0)},setRedraw:function(e){e?--this._redrawCount===0&&this.redraw():this._redrawCount++},setModel:function(e){if(!e)return;if(e===this._model)return;this._model.removeEventListener("preChanging",this._modelListener.onChanging),this._model.removeEventListener("postChanged",this._modelListener.onChanged);var t=this._model.getLineCount(),n=this._model.getCharCount(),r=e.getLineCount(),i=e.getCharCount(),s=e.getText(),o={type:"ModelChanging",text:s,start:0,removedCharCount:n,addedCharCount:i,removedLineCount:t,addedLineCount:r};this.onModelChanging(o),this._model=e,o={type:"ModelChanged",start:0,removedCharCount:n,addedCharCount:i,removedLineCount:t,addedLineCount:r},this.onModelChanged(o),this._model.addEventListener("preChanging",this._modelListener.onChanging),this._model.addEventListener("postChanged",this._modelListener.onChanged),this._reset(),this._update()},setOptions:function(e){var t=this._defaultOptions();for(var n in e)if(e.hasOwnProperty(n)){var r=e[n],i=this["_"+n];if(f(i,r))continue;var s=t[n]?t[n].update:null;if(s){s.call(this,r);continue}this["_"+n]=a(r)}},setSelection:function(e,t,n){var r=e>t;if(r){var i=e;e=t,t=i}var s=this._model.getCharCount();e=Math.max(0,Math.min(e,s)),t=Math.max(0,Math.min(t,s));var o=new d(e,t,r);this._setSelection(o,n===undefined||n)},setText:function(e,t,n){var i=t===undefined&&n===undefined;t===undefined&&(t=0),n===undefined&&(n=this._model.getCharCount()),this._modifyContent({text:e,start:t,end:n,_code:!0},!i),i&&(this._columnX=-1,this._setSelection(new d(0,0,!1),!0),r.isFirefox&&this._fixCaret())},setTopIndex:function(e){if(!this._clientDiv)return;this._scrollView(0,this._getLinePixel(Math.max(0,e))-this._getScroll().y)},setTopPixel:function(e){if(!this._clientDiv)return;this._scrollView(0,Math.max(0,e)-this._getScroll().y)},showSelection:function(){return this._showCaret(!0)},update:function(e,t){if(!this._clientDiv)return;e&&this._updateStyle(),t===undefined||t?this._update():this._queueUpdate()},_handleRootMouseDown:function(e){r.isFirefox&&e.which===1&&(this._clientDiv.contentEditable=!1,(this._overlayDiv||this._clientDiv).draggable=!0,this._ignoreBlur=!0);var t=this._overlayDiv||this._clientDiv;r.isIE<9&&(t=this._viewDiv);var n=e.target?e.target:e.srcElement;while(n){if(t===n)return;n=n.parentNode}e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation();if(!this._isW3CEvents){var i=this,s=this._getWindow();s.setTimeout(function(){i._clientDiv.focus()},0)}},_handleRootMouseUp:function(e){r.isFirefox&&e.which===1&&(this._clientDiv.contentEditable=!0,(this._overlayDiv||this._clientDiv).draggable=!1,this._fixCaret(),this._ignoreBlur=!1)},_handleBlur:function(e){if(this._ignoreBlur)return;this._hasFocus=!1;if(r.isIE<9&&!this._getSelection().isEmpty()){var t=this._rootDiv,n=r.createElement(t.ownerDocument,"div");t.appendChild(n),t.removeChild(n)}if(this._selDiv1){var i="lightgray";this._selDiv1.style.background=i,this._selDiv2.style.background=i,this._selDiv3.style.background=i;var s,o=this._getWindow(),u=this._selDiv1.ownerDocument;if(o.getSelection){var a=o.getSelection();s=a.anchorNode;while(s){if(s===this._clientDiv){a.rangeCount>0&&a.removeAllRanges();break}s=s.parentNode}}else if(u.selection){this._ignoreSelect=!1,s=u.selection.createRange().parentElement();while(s){if(s===this._clientDiv){u.selection.empty();break}s=s.parentNode}this._ignoreSelect=!0}}this._ignoreFocus||this.onBlur({type:"Blur"})},_handleContextMenu:function(e){r.isIE&&this._lastMouseButton===3&&this._updateDOMSelection();var t=!1;if(this.isListening("ContextMenu")){var n=this._createMouseEvent("ContextMenu",e);n.screenX=e.screenX,n.screenY=e.screenY,this.onContextMenu(n),t=n.defaultPrevented}if(t)return e.preventDefault&&e.preventDefault(),!1},_handleCopy:function(e){if(this._ignoreCopy)return;if(this._doCopy(e))return e.preventDefault&&e.preventDefault(),!1},_handleCut:function(e){if(this._doCut(e))return e.preventDefault&&e.preventDefault(),!1},_handleDataModified:function(e){this._startIME()},_handleDblclick:function(e){var t=e.timeStamp?e.timeStamp:(new Date).getTime();this._lastMouseTime=t,this._clickCount!==2&&(this._clickCount=2,this._handleMouse(e))},_handleDragStart:function(e){if(r.isFirefox){var t=this,n=this._getWindow();n.setTimeout(function(){t._clientDiv.contentEditable=!0,t._clientDiv.draggable=!1,t._ignoreBlur=!1},0)}if(!this.isListening("DragStart")||this._dragOffset===-1)return e.preventDefault&&e.preventDefault(),!1;this._isMouseDown=!1,this.onDragStart(this._createMouseEvent("DragStart",e)),this._dragOffset=-1},_handleDrag:function(e){this.isListening("Drag")&&this.onDrag(this._createMouseEvent("Drag",e))},_handleDragEnd:function(e){this._dropTarget=!1,this._dragOffset=-1,this.isListening("DragEnd")&&this.onDragEnd(this._createMouseEvent("DragEnd",e)),r.isFirefox&&(this._fixCaret(),e.dataTransfer.dropEffect==="none"&&!e.dataTransfer.mozUserCancelled&&this._fixCaret())},_handleDragEnter:function(e){var t=!0;this._dropTarget=!0,this.isListening("DragEnter")&&(t=!1,this.onDragEnter(this._createMouseEvent("DragEnter",e)));if(r.isWebkit||t)return e.preventDefault&&e.preventDefault(),!1},_handleDragOver:function(e){var t=!0;this.isListening("DragOver")&&(t=!1,this.onDragOver(this._createMouseEvent("DragOver",e)));if(r.isWebkit||t)return t&&(e.dataTransfer.dropEffect="none"),e.preventDefault&&e.preventDefault(),!1},_handleDragLeave:function(e){this._dropTarget=!1,this.isListening("DragLeave")&&this.onDragLeave(this._createMouseEvent("DragLeave",e))},_handleDrop:function(e){return this._dropTarget=!1,this.isListening("Drop")&&this.onDrop(this._createMouseEvent("Drop",e)),e.preventDefault&&e.preventDefault(),!1},_handleFocus:function(e){this._hasFocus=!0,r.isIOS&&this._lastTouchOffset!==undefined?(this.setCaretOffset(this._lastTouchOffset,!0),this._lastTouchOffset=undefined):this._updateDOMSelection();if(this._selDiv1){var t=this._highlightRGB;this._selDiv1.style.background=t,this._selDiv2.style.background=t,this._selDiv3.style.background=t}this._ignoreFocus||this.onFocus({type:"Focus"})},_handleKeyDown:function(e){var t=!1;switch(e.keyCode){case 16:case 17:case 18:case 91:t=!0;break;default:this._setLinksVisible(!1)}if(e.keyCode===229){if(this._readonly)return e.preventDefault&&e.preventDefault(),!1;var n=!0;r.isSafari&&r.isMac&&e.ctrlKey&&(n=!1),n&&this._startIME()}else t||this._commitIME();if((r.isMac||r.isLinux)&&r.isFirefox<4||r.isOpera)return this._keyDownEvent=e,!0;if(this._doAction(e))return e.preventDefault?(e.preventDefault(),e.stopPropagation()):(e.cancelBubble=!0,e.returnValue=!1,e.keyCode=0),!1},_handleKeyPress:function(e){if(r.isMac&&r.isWebkit)if(63232<=e.keyCode&&e.keyCode<=63487||e.keyCode===13||e.keyCode===8)return e.preventDefault&&e.preventDefault(),!1;if((r.isMac||r.isLinux)&&r.isFirefox<4||r.isOpera)if(this._doAction(this._keyDownEvent))return e.preventDefault&&e.preventDefault(),!1;var t=r.isMac?e.metaKey:e.ctrlKey;if(e.charCode!==undefined&&t)switch(e.charCode){case 99:case 118:case 120:return!0}var n=!1;if(r.isMac){if(e.ctrlKey||e.metaKey)n=!0}else if(r.isFirefox){if(e.ctrlKey||e.altKey)n=!0}else e.ctrlKey^e.altKey&&(n=!0);if(!n){var i=r.isOpera?e.which:e.charCode!==undefined?e.charCode:e.keyCode;if(i>31)return this._doContent(String.fromCharCode(i)),e.preventDefault&&e.preventDefault(),!1}},_handleKeyUp:function(e){var t=r.isMac?e.metaKey:e.ctrlKey;t||this._setLinksVisible(!1),e.keyCode===13&&this._commitIME()},_handleLinkClick:function(e){var t=r.isMac?e.metaKey:e.ctrlKey;if(!t)return e.preventDefault&&e.preventDefault(),!1},_handleMouse:function(e){var t=this._getWindow(),n=!0,i=t;if(r.isIE||r.isFirefox&&!this._overlayDiv)i=this._clientDiv;if(this._overlayDiv){this._hasFocus&&(this._ignoreFocus=!0);var s=this;t.setTimeout(function(){s.focus(),s._ignoreFocus=!1},0)}return this._clickCount===1?(n=this._setSelectionTo(e.clientX,e.clientY,e.shiftKey,!r.isOpera&&this._hasFocus&&this.isListening("DragStart")),n&&this._setGrab(i)):(this._isW3CEvents&&this._setGrab(i),this._doubleClickSelection=null,this._setSelectionTo(e.clientX,e.clientY,e.shiftKey),this._doubleClickSelection=this._getSelection()),n},_handleMouseDown:function(e){if(this._linksVisible){var t=e.target||e.srcElement;if(t.tagName==="A")return;this._setLinksVisible(!1)}this._commitIME();var n=e.which;n||(e.button===4&&(n=2),e.button===2&&(n=3),e.button===1&&(n=1));var i=n!==2&&e.timeStamp?e.timeStamp:(new Date).getTime(),s=i-this._lastMouseTime,o=Math.abs(this._lastMouseX-e.clientX),u=Math.abs(this._lastMouseY-e.clientY),a=this._lastMouseButton===n;this._lastMouseX=e.clientX,this._lastMouseY=e.clientY,this._lastMouseTime=i,this._lastMouseButton=n,n===1&&(this._isMouseDown=!0,a&&s<=this._clickTime&&o<=this._clickDist&&u<=this._clickDist?this._clickCount++:this._clickCount=1);if(this.isListening("MouseDown")){var f=this._createMouseEvent("MouseDown",e);this.onMouseDown(f);if(f.defaultPrevented){e.preventDefault();return}}n===1&&this._handleMouse(e)&&(r.isIE>=9||r.isOpera||r.isChrome||r.isSafari||r.isFirefox&&!this._overlayDiv)&&(this._hasFocus||this.focus(),e.preventDefault()),r.isFirefox&&this._lastMouseButton===3&&this._updateDOMSelection()},_handleMouseOver:function(e){this.isListening("MouseOver")&&this.onMouseOver(this._createMouseEvent("MouseOver",e))},_handleMouseOut:function(e){this.isListening("MouseOut")&&this.onMouseOut(this._createMouseEvent("MouseOut",e))},_handleMouseMove:function(e){var t=this._isClientDiv(e);this.isListening("MouseMove")&&t&&this.onMouseMove(this._createMouseEvent("MouseMove",e));if(this._dropTarget)return;var n=this._linksVisible||this._lastMouseMoveX!==e.clientX||this._lastMouseMoveY!==e.clientY;this._lastMouseMoveX=e.clientX,this._lastMouseMoveY=e.clientY,this._setLinksVisible(n&&!this._isMouseDown&&(r.isMac?e.metaKey:e.ctrlKey));if(!this._isW3CEvents){if(e.button===0)return this._setGrab(null),!0;if(!this._isMouseDown&&e.button===1&&(this._clickCount&1)!==0&&t)return this._clickCount=2,this._handleMouse(e,this._clickCount)}if(!this._isMouseDown||this._dragOffset!==-1)return;var i=e.clientX,s=e.clientY,o=this._getViewPadding(),u=this._viewDiv.getBoundingClientRect(),a=this._getClientWidth(),f=this._getClientHeight(),l=u.left+o.left,c=u.top+o.top,h=u.left+o.left+a,p=u.top+o.top+f,d=this._model,v=d.getLineAtOffset(this._getSelection().getCaret());s<c&&v!==0?this._doAutoScroll("up",i,s-c):s>p&&v!==d.getLineCount()-1?this._doAutoScroll("down",i,s-p):i<l&&!this._wrapMode?this._doAutoScroll("left",i-l,s):i>h&&!this._wrapMode?this._doAutoScroll("right",i-h,s):(this._endAutoScroll(),this._setSelectionTo(i,s,!0))},_isClientDiv:function(e){var t=this._overlayDiv||this._clientDiv,n=e.target?e.target:e.srcElement;while(n){if(t===n)return!0;n=n.parentNode}return!1},_createMouseEvent:function(e,t){var n=this.convert({x:t.clientX,y:t.clientY},"page","document");return{type:e,event:t,clickCount:this._clickCount,x:n.x,y:n.y,preventDefault:function(){this.defaultPrevented=!0}}},_handleMouseUp:function(e){var t=e.which?e.button===0:e.button===1;this.isListening("MouseUp")&&(this._isClientDiv(e)||t&&this._isMouseDown)&&this.onMouseUp(this._createMouseEvent("MouseUp",e));if(this._linksVisible)return;if(t&&this._isMouseDown){if(this._dragOffset!==-1){var n=this._getSelection();n.extend(this._dragOffset),n.collapse(),this._setSelection(n,!0,!0),this._dragOffset=-1}this._isMouseDown=!1,this._endAutoScroll(),this._isW3CEvents&&this._setGrab(null),r.isFirefox&&e.preventDefault()}},_handleMouseWheel:function(e){var t=this._getLineHeight(),n=0,i=0;if(r.isIE||r.isOpera)i=-e.wheelDelta/40*t;else if(r.isFirefox){var s;if(r.isMac)s=e.detail*3;else{var o=256;s=Math.max(-o,Math.min(o,e.detail))*t}e.axis===e.HORIZONTAL_AXIS?n=s:i=s}else if(r.isMac){var u=40,a=40;e.wheelDeltaX%120!==0&&(u=1),e.wheelDeltaY%120!==0&&(a=1),n=-e.wheelDeltaX/u,-1<n&&n<0&&(n=-1),0<n&&n<1&&(n=1),i=-e.wheelDeltaY/a,-1<i&&i<0&&(i=-1),0<i&&i<1&&(i=1)}else{n=-e.wheelDeltaX;var f=8;i=-e.wheelDeltaY/120*f*t}if(r.isSafari){var l=e.target;while(l&&l.lineIndex===undefined)l=l.parentNode;this._mouseWheelLine=l}var c=this._getScroll();this._scrollView(n,i);var h=this._getScroll();if(c.x!==h.x||c.y!==h.y)return e.preventDefault&&e.preventDefault(),!1},_handlePaste:function(e){if(this._ignorePaste)return;if(this._doPaste(e)){if(r.isIE){var t=this;this._ignoreFocus=!0;var n=this._getWindow();n.setTimeout(function(){t._updateDOMSelection(),t._ignoreFocus=!1},0)}return e.preventDefault&&e.preventDefault(),!1}},_handleResize:function(e){var t=this._parent.clientWidth,n=this._parent.clientHeight;if(this._parentWidth!==t||this._parentHeight!==n)this._parentWidth!==t&&this._resetLineHeight(),this._parentWidth=t,this._parentHeight=n,r.isIE<9?this._queueUpdate():this._update()},_handleRulerEvent:function(e){var t=e.target?e.target:e.srcElement,n=t.lineIndex,r=t;while(r&&!r._ruler)n===undefined&&r.lineIndex!==undefined&&(n=r.lineIndex),r=r.parentNode;var i=r?r._ruler:null;if(n===undefined&&i&&i.getOverview()==="document"){var s=this._getClientHeight(),o=this._model.getLineCount(),u=this._getViewPadding(),a=this._viewDiv.getBoundingClientRect(),f=s+u.top+u.bottom-2*this._metrics.scrollWidth;n=Math.floor((e.clientY-a.top-this._metrics.scrollWidth)*o/f),0<=n&&n<o||(n=undefined)}if(i)switch(e.type){case"click":i.onClick&&i.onClick(n,e);break;case"dblclick":i.onDblClick&&i.onDblClick(n,e);break;case"mousemove":i.onMouseMove&&i.onMouseMove(n,e);break;case"mouseover":i.onMouseOver&&i.onMouseOver(n,e);break;case"mouseout":i.onMouseOut&&i.onMouseOut(n,e)}},_handleScroll:function(){var e=this._getScroll(),t=this._hScroll,n=this._vScroll;if(t!==e.x||n!==e.y){this._hScroll=e.x,this._vScroll=e.y,this._commitIME(),this._update(n===e.y);var r={type:"Scroll",oldValue:{x:t,y:n},newValue:e};this.onScroll(r)}},_handleSelectStart:function(e){if(this._ignoreSelect)return e&&e.preventDefault&&e.preventDefault(),!1},_getModelOffset:function(e,t){if(!e)return;var n;e.tagName==="DIV"?n=e:n=e.parentNode.parentNode;var r=0,i=n.lineIndex;if(e.tagName!=="DIV"){var s=n.firstChild;while(s){var o=s.firstChild;if(o===e){s.ignoreChars&&(r-=s.ignoreChars),r+=t;break}s.ignoreChars&&(r-=s.ignoreChars),r+=o.data.length,s=s.nextSibling}}return Math.max(0,r)+this._model.getLineStart(i)},_updateSelectionFromDOM:function(){var e=this._getWindow(),t=e.getSelection(),n=this._getModelOffset(t.anchorNode,t.anchorOffset),r=this._getModelOffset(t.focusNode,t.focusOffset);if(n===undefined||r===undefined)return;this._setSelection(new d(n,r),!1,!1)},_handleSelectionChange:function(e){if(this._imeOffset!==-1)return;if(r.isAndroid){var t=this._getWindow();this._selTimer&&t.clearTimeout(this._selTimer);var n=this;this._selTimer=t.setTimeout(function(){if(!n._clientDiv)return;n._selTimer=null,n._updateSelectionFromDOM()},250)}else this._updateSelectionFromDOM()},_handleTextInput:function(e){this._imeOffset=-1;if(r.isAndroid){var t=this._getWindow().getSelection(),n=t.anchorNode;while(n){if(n.lineIndex!==undefined)break;n=n.parentNode}if(n){var i=this._model,s=n.lineIndex,o=i.getLine(s),u=o,a=0,f=i.getLineStart(s);if(t.rangeCount>0){t.getRangeAt(0).deleteContents();var l=n.ownerDocument.createTextNode(e.data);t.getRangeAt(0).insertNode(l);var c=this._getDOMText(n,l);u=c.text,a=c.offset,l.parentNode.removeChild(l)}n.lineRemoved=!0;var h=0;while(o.charCodeAt(h)===u.charCodeAt(h)&&h<a)h++;var p=o.length-1,d=u.length-o.length;while(o.charCodeAt(p)===u.charCodeAt(p+d)&&p+d>=a+e.data.length)p--;p++;var v=u.substring(h,p+d);h+=f,p+=f,this._modifyContent({text:v,start:h,end:p,_ignoreDOMSelection:!0},!0)}}else this._doContent(e.data);e.preventDefault()},_handleTouchStart:function(e){this._commitIME();var t=this._getWindow();this._touchScrollTimer&&(this._vScrollDiv.style.display="none",this._hScrollDiv.style.display="none",t.clearInterval(this._touchScrollTimer),this._touchScrollTimer=null);var n=e.touches;if(n.length===1){var i=n[0],s=i.clientX,o=i.clientY;this._touchStartX=s,this._touchStartY=o,r.isAndroid&&(o<i.pageY-t.pageYOffset||s<i.pageX-t.pageXOffset)&&(s=i.pageX-t.pageXOffset,o=i.pageY-t.pageYOffset);var u=this.convert({x:s,y:o},"page","document");this._lastTouchOffset=this.getOffsetAtLocation(u.x,u.y),this._touchStartTime=e.timeStamp,this._touching=!0}},_handleTouchMove:function(e){var t=e.touches;if(t.length===1){var n=t[0];this._touchCurrentX=n.clientX,this._touchCurrentY=n.clientY;var r=10;if(!this._touchScrollTimer&&e.timeStamp-this._touchStartTime<r*20){this._vScrollDiv.style.display="block",this._wrapMode||(this._hScrollDiv.style.display="block");var i=this,s=this._getWindow();this._touchScrollTimer=s.setInterval(function(){var e=0,t=0;if(i._touching)e=i._touchStartX-i._touchCurrentX,t=i._touchStartY-i._touchCurrentY,i._touchSpeedX=e/r,i._touchSpeedY=t/r,i._touchStartX=i._touchCurrentX,i._touchStartY=i._touchCurrentY;else{if(Math.abs(i._touchSpeedX)<.1&&Math.abs(i._touchSpeedY)<.1){i._vScrollDiv.style.display="none",i._hScrollDiv.style.display="none",s.clearInterval(i._touchScrollTimer),i._touchScrollTimer=null;return}e=i._touchSpeedX*r,t=i._touchSpeedY*r,i._touchSpeedX*=.95,i._touchSpeedY*=.95}i._scrollView(e,t)},r)}this._touchScrollTimer&&e.preventDefault()}},_handleTouchEnd:function(e){var t=e.touches;t.length===0&&(this._touching=!1)},_doAction:function(e){var t=this._keyBindings;for(var n=0;n<t.length;n++){var r=t[n];if(r.keyBinding.match(e)){if(r.actionID){var i=this._actions,s=i[r.actionID];if(s)if(s.handler){if(!s.handler())return s.defaultHandler?typeof s.defaultHandler()=="boolean":!1}else if(s.defaultHandler)return typeof s.defaultHandler()=="boolean"}return!0}}return!1},_doBackspace:function(e){var t=this._getSelection();if(t.isEmpty()){var n=this._model,r=t.getCaret(),i=n.getLineAtOffset(r),s=n.getLineStart(i);if(r===s)i>0&&t.extend(n.getLineEnd(i-1));else{var o=!1;if(this._expandTab&&e.unit==="character"&&(r-s)%this._tabSize===0){var u=n.getText(s,r);o=!/[^ ]/.test(u)}if(o)t.extend(r-this._tabSize);else{var a=this._getLine(i);t.extend(a.getNextOffset(r,e.unit,-1)),a.destroy()}}}return this._modifyContent({text:"",start:t.start,end:t.end},!0),!0},_doContent:function(e){var t=this._getSelection();this._modifyContent({text:e,start:t.start,end:t.end,_ignoreDOMSelection:!0},!0)},_doCopy:function(e){var t=this._getSelection();if(!t.isEmpty()){var n=this._getBaseText(t.start,t.end);return this._setClipboardText(n,e)}return!0},_doCursorNext:function(e){if(!e.select&&this._clearSelection("next"))return!0;var t=this._model,n=this._getSelection(),r=n.getCaret(),i=t.getLineAtOffset(r);if(r===t.getLineEnd(i))i+1<t.getLineCount()&&n.extend(t.getLineStart(i+1));else{var s=this._getLine(i);n.extend(s.getNextOffset(r,e.unit,1)),s.destroy()}return e.select||n.collapse(),this._setSelection(n,!0),!0},_doCursorPrevious:function(e){if(!e.select&&this._clearSelection("previous"))return!0;var t=this._model,n=this._getSelection(),r=n.getCaret(),i=t.getLineAtOffset(r);if(r===t.getLineStart(i))i>0&&n.extend(t.getLineEnd(i-1));else{var s=this._getLine(i);n.extend(s.getNextOffset(r,e.unit,-1)),s.destroy()}return e.select||n.collapse(),this._setSelection(n,!0),!0},_doCut:function(e){var t=this._getSelection();if(!t.isEmpty()){var n=this._getBaseText(t.start,t.end);return this._doContent(""),this._setClipboardText(n,e)}return!0},_doDelete:function(e){var t=this._getSelection();if(t.isEmpty()){var n=this._model,r=t.getCaret(),i=n.getLineAtOffset(r);if(r===n.getLineEnd(i))i+1<n.getLineCount()&&t.extend(n.getLineStart(i+1));else{var s=this._getLine(i);t.extend(s.getNextOffset(r,e.unit,1)),s.destroy()}}return this._modifyContent({text:"",start:t.start,end:t.end},!0),!0},_doEnd:function(e){var t=this._getSelection(),n=this._model;if(e.ctrl)t.extend(n.getCharCount());else{var r=t.getCaret(),i=n.getLineAtOffset(r);if(this._wrapMode){var s=this._getLine(i),o=s.getLineIndex(r);o===s.getLineCount()-1?r=n.getLineEnd(i):r=s.getLineStart(o+1)-1,s.destroy()}else r=n.getLineEnd(i);t.extend(r)}return e.select||t.collapse(),this._setSelection(t,!0),!0},_doEnter:function(e){var t=this._model,n=this._getSelection();return this._doContent(t.getLineDelimiter()),e&&e.noCursor&&(n.end=n.start,this._setSelection(n)),!0},_doHome:function(e){var t=this._getSelection(),n=this._model;if(e.ctrl)t.extend(0);else{var r=t.getCaret(),i=n.getLineAtOffset(r);if(this._wrapMode){var s=this._getLine(i),o=s.getLineIndex(r);r=s.getLineStart(o),s.destroy()}else r=n.getLineStart(i);t.extend(r)}return e.select||t.collapse(),this._setSelection(t,!0),!0},_doLineDown:function(e){var t=this._model,n=this._getSelection(),i=n.getCaret(),s=t.getLineAtOffset(i),o,u=this._getLine(s),a=this._columnX,f=1,l=!1;if(a===-1||e.wholeLine||e.select&&r.isIE){var c=e.wholeLine?t.getLineEnd(s+1):i;a=u.getBoundingClientRect(c).left}return(o=u.getLineIndex(i))<u.getLineCount()-1?f=u.getClientRects(o+1).top+1:(l=s===t.getLineCount()-1,s++),l?e.select&&(n.extend(t.getCharCount()),this._setSelection(n,!0,!0)):(u.lineIndex!==s&&(u.destroy(),u=this._getLine(s)),n.extend(u.getOffset(a,f)),e.select||n.collapse(),this._setSelection(n,!0,!0)),this._columnX=a,u.destroy(),!0},_doLineUp:function(e){var t=this._model,n=this._getSelection(),i=n.getCaret(),s=t.getLineAtOffset(i),o,u=this._getLine(s),a=this._columnX,f=!1,l;if(a===-1||e.wholeLine||e.select&&r.isIE){var c=e.wholeLine?t.getLineStart(s-1):i;a=u.getBoundingClientRect(c).left}return(o=u.getLineIndex(i))>0?l=u.getClientRects(o-1).top+1:(f=s===0,f||(s--,l=this._getLineHeight(s)-1)),f?e.select&&(n.extend(0),this._setSelection(n,!0,!0)):(u.lineIndex!==s&&(u.destroy(),u=this._getLine(s)),n.extend(u.getOffset(a,l)),e.select||n.collapse(),this._setSelection(n,!0,!0)),this._columnX=a,u.destroy(),!0},_doPageDown:function(e){var t=this._model,n=this._getSelection(),i=n.getCaret(),s=t.getLineAtOffset(i),o=t.getLineCount(),u=this._getScroll(),a=this._getClientHeight(),f,l;if(this._lineHeight){f=this._columnX;var c=this._getBoundsAtOffset(i);if(f===-1||e.select&&r.isIE)f=c.left;var h=this._getLineIndex(c.top+a);l=this._getLine(h);var p=this._getLinePixel(h),d=c.top+a-p;i=l.getOffset(f,d);var v=l.getBoundingClientRect(i);return l.destroy(),n.extend(i),e.select||n.collapse(),this._setSelection(n,!0,!0,v.top+p-c.top),this._columnX=f,!0}if(s<o-1){var m=this._getLineHeight(),g=Math.floor(a/m),y=Math.min(o-s-1,g);y=Math.max(1,y),f=this._columnX;if(f===-1||e.select&&r.isIE)l=this._getLine(s),f=l.getBoundingClientRect(i).left,l.destroy();l=this._getLine(s+y),n.extend(l.getOffset(f,0)),l.destroy(),e.select||n.collapse();var b=o*m,w=u.y+y*m;w+a>b&&(w=b-a),this._setSelection(n,!0,!0,w-u.y),this._columnX=f}return!0},_doPageUp:function(e){var t=this._model,n=this._getSelection(),i=n.getCaret(),s=t.getLineAtOffset(i),o=this._getScroll(),u=this._getClientHeight(),a,f;if(this._lineHeight){a=this._columnX;var l=this._getBoundsAtOffset(i);if(a===-1||e.select&&r.isIE)a=l.left;var c=this._getLineIndex(l.bottom-u);f=this._getLine(c);var h=this._getLinePixel(c),p=l.bottom-u-h;i=f.getOffset(a,p);var d=f.getBoundingClientRect(i);return f.destroy(),n.extend(i),e.select||n.collapse(),this._setSelection(n,!0,!0,d.top+h-l.top),this._columnX=a,!0}if(s>0){var v=this._getLineHeight(),m=Math.floor(u/v),g=Math.max(1,Math.min(s,m));a=this._columnX;if(a===-1||e.select&&r.isIE)f=this._getLine(s),a=f.getBoundingClientRect(i).left,f.destroy();f=this._getLine(s-g),n.extend(f.getOffset(a,this._getLineHeight(s-g)-1)),f.destroy(),e.select||n.collapse();var y=Math.max(0,o.y-g*v);this._setSelection(n,!0,!0,y-o.y),this._columnX=a}return!0},_doPaste:function(e){var t=this,n=this._getClipboardText(e,function(e){if(e){if(r.isLinux&&t._lastMouseButton===2){var n=(new Date).getTime()-t._lastMouseTime;n<=t._clickTime&&t._setSelectionTo(t._lastMouseX,t._lastMouseY)}t._doContent(e)}});return n!==null},_doScroll:function(e){var t=e.type,n=this._model,r=n.getLineCount(),i=this._getClientHeight(),s=this._getLineHeight(),o=r*s,u=this._getScroll().y,a;switch(t){case"textStart":a=0;break;case"textEnd":a=o-i;break;case"pageDown":a=u+i;break;case"pageUp":a=u-i;break;case"centerLine":var f=this._getSelection(),l=n.getLineAtOffset(f.start),c=n.getLineAtOffset(f.end),h=(c-l+1)*s;a=l*s-i/2+h/2}return a!==undefined&&(a=Math.min(Math.max(0,a),o-i),this._scrollView(0,a-u)),!0},_doSelectAll:function(e){var t=this._model,n=this._getSelection();return n.setCaret(0),n.extend(t.getCharCount()),this._setSelection(n,!1),!0},_doTab:function(e){if(!this._tabMode||this._readonly)return;var t="	";if(this._expandTab){var n=this._model,r=this._getSelection().getCaret(),i=n.getLineAtOffset(r),s=n.getLineStart(i),o=this._tabSize-(r-s)%this._tabSize;t=(new Array(o+1)).join(" ")}return this._doContent(t),!0},_doShiftTab:function(e){if(!this._tabMode||this._readonly)return;return!0},_doTabMode:function(e){return this._tabMode=!this._tabMode,!0},_doWrapMode:function(e){return this.setOptions({wrapMode:!this.getOptions("wrapMode")}),!0},_autoScroll:function(){var e=this._getSelection(),t=this.convert({x:this._autoScrollX,y:this._autoScrollY},"page","document"),n=e.getCaret(),r=this._model.getLineAtOffset(n),i,s;if(this._autoScrollDir==="up"||this._autoScrollDir==="down"){var o=this._autoScrollY/this._getLineHeight();o=o<0?Math.floor(o):Math.ceil(o),i=r,i=Math.max(0,Math.min(this._model.getLineCount()-1,i+o))}else if(this._autoScrollDir==="left"||this._autoScrollDir==="right")i=this._getLineIndex(t.y),s=this._getLine(r),t.x+=s.getBoundingClientRect(n,!1).left,s.destroy();s=this._getLine(i),e.extend(s.getOffset(t.x,t.y-this._getLinePixel(i))),s.destroy(),this._setSelection(e,!0)},_autoScrollTimer:function(){this._autoScroll();var e=this,t=this._getWindow();this._autoScrollTimerID=t.setTimeout(function(){e._autoScrollTimer()},this._AUTO_SCROLL_RATE)},_calculateLineHeightTimer:function(e){if(!this._lineHeight)return;if(this._calculateLHTimer)return;var t=this._model.getLineCount(),n=0;if(e){var r=0,i=100,s=(new Date).getTime(),o=0;while(n<t){this._lineHeight[n]||(r++,o||(o=n),this._lineHeight[n]=this._calculateLineHeight(n)),n++;if((new Date).getTime()-s>i)break}this.redrawRulers(0,t),this._queueUpdate()}var u=this._getWindow();if(n!==t){var a=this;this._calculateLHTimer=u.setTimeout(function(){a._calculateLHTimer=null,a._calculateLineHeightTimer(!0)},0);return}this._calculateLHTimer&&(u.clearTimeout(this._calculateLHTimer),this._calculateLHTimer=undefined)},_calculateLineHeight:function(e){var t=this._getLine(e),n=t.getBoundingClientRect();return t.destroy(),Math.max(1,Math.ceil(n.bottom-n.top))},_calculateMetrics:function(){var e=this._clientDiv,t=e.ownerDocument,n=" ",i=r.createElement(t,"div");i.style.lineHeight="normal";var s=this._model,o=s.getLine(0),a={type:"LineStyle",textView:this,0:0,lineText:o,lineStart:0};this.onLineStyle(a),u(a.style,i),i.style.position="fixed",i.style.left="-1000px";var f=r.createElement(t,"span");f.appendChild(t.createTextNode(n)),i.appendChild(f);var l=r.createElement(t,"span");l.style.fontStyle="italic",l.appendChild(t.createTextNode(n)),i.appendChild(l);var c=r.createElement(t,"span");c.style.fontWeight="bold",c.appendChild(t.createTextNode(n)),i.appendChild(c);var d=r.createElement(t,"span");d.style.fontWeight="bold",d.style.fontStyle="italic",d.appendChild(t.createTextNode(n)),i.appendChild(d),e.appendChild(i);var v=i.getBoundingClientRect(),m=f.getBoundingClientRect(),g=l.getBoundingClientRect(),y=c.getBoundingClientRect(),b=d.getBoundingClientRect(),w=m.bottom-m.top,E=g.bottom-g.top,S=y.bottom-y.top,x=b.bottom-b.top,T=0,N=v.bottom-v.top<=0,C=Math.max(1,v.bottom-v.top);E>w&&(T=1),S>E&&(T=2),x>S&&(T=3);var k;T!==0&&(k={style:{}},(T&1)!==0&&(k.style.fontStyle="italic"),(T&2)!==0&&(k.style.fontWeight="bold"));var L=p(i);e.removeChild(i);var A=h(this._viewDiv),O=r.createElement(t,"div");O.style.position="fixed",O.style.left="-1000px",O.style.paddingLeft=A.left+"px",O.style.paddingTop=A.top+"px",O.style.paddingRight=A.right+"px",O.style.paddingBottom=A.bottom+"px",O.style.width="100px",O.style.height="100px";var M=r.createElement(t,"div");M.style.width="100%",M.style.height="100%",O.appendChild(M),e.appendChild(O);var _=O.getBoundingClientRect(),D=M.getBoundingClientRect();O.style.overflow="hidden",M.style.height="200px";var P=O.clientWidth;O.style.overflow="scroll";var H=O.clientWidth;e.removeChild(O);var B=P-H;return A={left:D.left-_.left,top:D.top-_.top,right:_.right-D.right,bottom:_.bottom-D.bottom},{lineHeight:C,largestFontStyle:k,lineTrim:L,viewPadding:A,scrollWidth:B,invalid:N}},_clearSelection:function(e){var t=this._getSelection();return t.isEmpty()?!1:(e==="next"?t.start=t.end:t.end=t.start,this._setSelection(t,!0),!0)},_commitIME:function(){if(this._imeOffset===-1)return;this._scrollDiv.focus(),this._clientDiv.focus();var e=this._model,t=e.getLineAtOffset(this._imeOffset),n=e.getLineStart(t),r=this._getDOMText(this._getLineNode(t)).text,i=e.getLine(t),s=this._imeOffset-n,o=s+r.length-i.length;if(s!==o){var u=r.substring(s,o);this._doContent(u)}this._imeOffset=-1},_createActions:function(){var e=t.KeyBinding,n=this._keyBindings=[];n.push({actionID:"lineUp",keyBinding:new e(38),predefined:!0}),n.push({actionID:"lineDown",keyBinding:new e(40),predefined:!0}),n.push({actionID:"charPrevious",keyBinding:new e(37),predefined:!0}),n.push({actionID:"charNext",keyBinding:new e(39),predefined:!0}),r.isMac?(n.push({actionID:"scrollPageUp",keyBinding:new e(33),predefined:!0}),n.push({actionID:"scrollPageDown",keyBinding:new e(34),predefined:!0}),n.push({actionID:"pageUp",keyBinding:new e(33,null,null,!0),predefined:!0}),n.push({actionID:"pageDown",keyBinding:new e(34,null,null,!0),predefined:!0}),n.push({actionID:"lineStart",keyBinding:new e(37,!0),predefined:!0}),n.push({actionID:"lineEnd",keyBinding:new e(39,!0),predefined:!0}),n.push({actionID:"wordPrevious",keyBinding:new e(37,null,null,!0),predefined:!0}),n.push({actionID:"wordNext",keyBinding:new e(39,null,null,!0),predefined:!0}),n.push({actionID:"scrollTextStart",keyBinding:new e(36),predefined:!0}),n.push({actionID:"scrollTextEnd",keyBinding:new e(35),predefined:!0}),n.push({actionID:"textStart",keyBinding:new e(38,!0),predefined:!0}),n.push({actionID:"textEnd",keyBinding:new e(40,!0),predefined:!0}),n.push({actionID:"scrollPageUp",keyBinding:new e(38,null,null,null,!0),predefined:!0}),n.push({actionID:"scrollPageDown",keyBinding:new e(40,null,null,null,!0),predefined:!0}),n.push({actionID:"lineStart",keyBinding:new e(37,null,null,null,!0),predefined:!0}),n.push({actionID:"lineEnd",keyBinding:new e(39,null,null,null,!0),predefined:!0}),n.push({actionID:"lineStart",keyBinding:new e(38,null,null,!0),predefined:!0}),n.push({actionID:"lineEnd",keyBinding:new e(40,null,null,!0),predefined:!0})):(n.push({actionID:"pageUp",keyBinding:new e(33),predefined:!0}),n.push({actionID:"pageDown",keyBinding:new e(34),predefined:!0}),n.push({actionID:"lineStart",keyBinding:new e(36),predefined:!0}),n.push({actionID:"lineEnd",keyBinding:new e(35),predefined:!0}),n.push({actionID:"wordPrevious",keyBinding:new e(37,!0),predefined:!0}),n.push({actionID:"wordNext",keyBinding:new e(39,!0),predefined:!0}),n.push({actionID:"textStart",keyBinding:new e(36,!0),predefined:!0}),n.push({actionID:"textEnd",keyBinding:new e(35,!0),predefined:!0})),r.isFirefox&&r.isLinux&&(n.push({actionID:"lineUp",keyBinding:new e(38,!0),predefined:!0}),n.push({actionID:"lineDown",keyBinding:new e(40,!0),predefined:!0})),n.push({actionID:"selectLineUp",keyBinding:new e(38,null,!0),predefined:!0}),n.push({actionID:"selectLineDown",keyBinding:new e(40,null,!0),predefined:!0}),n.push({actionID:"selectCharPrevious",keyBinding:new e(37,null,!0),predefined:!0}),n.push({actionID:"selectCharNext",keyBinding:new e(39,null,!0),predefined:!0}),n.push({actionID:"selectPageUp",keyBinding:new e(33,null,!0),predefined:!0}),n.push({actionID:"selectPageDown",keyBinding:new e(34,null,!0),predefined:!0}),r.isMac?(n.push({actionID:"selectLineStart",keyBinding:new e(37,!0,!0),predefined:!0}),n.push({actionID:"selectLineEnd",keyBinding:new e(39,!0,!0),predefined:!0}),n.push({actionID:"selectWordPrevious",keyBinding:new e(37,null,!0,!0),predefined:!0}),n.push({actionID:"selectWordNext",keyBinding:new e(39,null,!0,!0),predefined:!0}),n.push({actionID:"selectTextStart",keyBinding:new e(36,null,!0),predefined:!0}),n.push({actionID:"selectTextEnd",keyBinding:new e(35,null,!0),predefined:!0}),n.push({actionID:"selectTextStart",keyBinding:new e(38,!0,!0),predefined:!0}),n.push({actionID:"selectTextEnd",keyBinding:new e(40,!0,!0),predefined:!0}),n.push({actionID:"selectLineStart",keyBinding:new e(37,null,!0,null,!0),predefined:!0}),n.push({actionID:"selectLineEnd",keyBinding:new e(39,null,!0,null,!0),predefined:!0}),n.push({actionID:"selectLineStart",keyBinding:new e(38,null,!0,!0),predefined:!0}),n.push({actionID:"selectLineEnd",keyBinding:new e(40,null,!0,!0),predefined:!0})):(r.isLinux&&(n.push({actionID:"selectWholeLineUp",keyBinding:new e(38,!0,!0),predefined:!0}),n.push({actionID:"selectWholeLineDown",keyBinding:new e(40,!0,!0),predefined:!0})),n.push({actionID:"selectLineStart",keyBinding:new e(36,null,!0),predefined:!0}),n.push({actionID:"selectLineEnd",keyBinding:new e(35,null,!0),predefined:!0}),n.push({actionID:"selectWordPrevious",keyBinding:new e(37,!0,!0),predefined:!0}),n.push({actionID:"selectWordNext",keyBinding:new e(39,!0,!0),predefined:!0}),n.push({actionID:"selectTextStart",keyBinding:new e(36,!0,!0),predefined:!0}),n.push({actionID:"selectTextEnd",keyBinding:new e(35,!0,!0),predefined:!0})),n.push({actionID:"undo",keyBinding:new t.KeyBinding("z",!0),predefined:!0}),r.isMac?n.push({actionID:"redo",keyBinding:new t.KeyBinding("z",!0,!0),predefined:!0}):n.push({actionID:"redo",keyBinding:new t.KeyBinding("y",!0),predefined:!0}),n.push({actionID:"deletePrevious",keyBinding:new e(8),predefined:!0}),n.push({actionID:"deletePrevious",keyBinding:new e(8,null,!0),predefined:!0}),n.push({actionID:"deleteNext",keyBinding:new e(46),predefined:!0}),n.push({actionID:"deleteWordPrevious",keyBinding:new e(8,!0),predefined:!0}),n.push({actionID:"deleteWordPrevious",keyBinding:new e(8,!0,!0),predefined:!0}),n.push({actionID:"deleteWordNext",keyBinding:new e(46,!0),predefined:!0}),n.push({actionID:"tab",keyBinding:new e(9),predefined:!0}),n.push({actionID:"shiftTab",keyBinding:new e(9,null,!0),predefined:!0}),n.push({actionID:"enter",keyBinding:new e(13),predefined:!0}),n.push({actionID:"enter",keyBinding:new e(13,null,!0),predefined:!0}),n.push({actionID:"selectAll",keyBinding:new e("a",!0),predefined:!0}),n.push({actionID:"toggleTabMode",keyBinding:new e("m",!0),predefined:!0}),r.isMac&&(n.push({actionID:"deleteNext",keyBinding:new e(46,null,!0),predefined:!0}),n.push({actionID:"deleteWordPrevious",keyBinding:new e(8,null,null,!0),predefined:!0}),n.push({actionID:"deleteWordNext",keyBinding:new e(46,null,null,!0),predefined:!0}));if(!r.isFirefox){var i=r.isMac&&r.isChrome;n.push({actionID:null,keyBinding:new e("u",!i,!1,!1,i),predefined:!0}),n.push({actionID:null,keyBinding:new e("i",!i,!1,!1,i),predefined:!0}),n.push({actionID:null,keyBinding:new e("b",!i,!1,!1,i),predefined:!0})}r.isFirefox&&(n.push({actionID:"copy",keyBinding:new e(45,!0),predefined:!0}),n.push({actionID:"paste",keyBinding:new e(45,null,!0),predefined:!0}),n.push({actionID:"cut",keyBinding:new e(46,null,!0),predefined:!0})),r.isMac&&(n.push({actionID:"lineStart",keyBinding:new e("a",!1,!1,!1,!0),predefined:!0}),n.push({actionID:"lineEnd",keyBinding:new e("e",!1,!1,!1,!0),predefined:!0}),n.push({actionID:"lineUp",keyBinding:new e("p",!1,!1,!1,!0),predefined:!0}),n.push({actionID:"lineDown",keyBinding:new e("n",!1,!1,!1,!0),predefined:!0}),n.push({actionID:"charPrevious",keyBinding:new e("b",!1,!1,!1,!0),predefined:!0}),n.push({actionID:"charNext",keyBinding:new e("f",!1,!1,!1,!0),predefined:!0}),n.push({actionID:"deletePrevious",keyBinding:new e("h",!1,!1,!1,!0),predefined:!0}),n.push({actionID:"deleteNext",keyBinding:new e("d",!1,!1,!1,!0),predefined:!0}),n.push({actionID:"deleteLineEnd",keyBinding:new e("k",!1,!1,!1,!0),predefined:!0}),r.isFirefox?(n.push({actionID:"scrollPageDown",keyBinding:new e("v",!1,!1,!1,!0),predefined:!0}),n.push({actionID:"deleteLineStart",keyBinding:new e("u",!1,!1,!1,!0),predefined:!0}),n.push({actionID:"deleteWordPrevious",keyBinding:new e("w",!1,!1,!1,!0),predefined:!0})):(n.push({actionID:"pageDown",keyBinding:new e("v",!1,!1,!1,!0),predefined:!0}),n.push({actionID:"centerLine",keyBinding:new e("l",!1,!1,!1,!0),predefined:!0}),n.push({actionID:"enterNoCursor",keyBinding:new e("o",!1,!1,!1,!0),predefined:!0})));var s=this;this._actions={lineUp:{defaultHandler:function(){return s._doLineUp({select:!1})}},lineDown:{defaultHandler:function(){return s._doLineDown({select:!1})}},lineStart:{defaultHandler:function(){return s._doHome({select:!1,ctrl:!1})}},lineEnd:{defaultHandler:function(){return s._doEnd({select:!1,ctrl:!1})}},charPrevious:{defaultHandler:function(){return s._doCursorPrevious({select:!1,unit:"character"})}},charNext:{defaultHandler:function(){return s._doCursorNext({select:!1,unit:"character"})}},pageUp:{defaultHandler:function(){return s._doPageUp({select:!1})}},pageDown:{defaultHandler:function(){return s._doPageDown({select:!1})}},scrollPageUp:{defaultHandler:function(){return s._doScroll({type:"pageUp"})}},scrollPageDown:{defaultHandler:function(){return s._doScroll({type:"pageDown"})}},wordPrevious:{defaultHandler:function(){return s._doCursorPrevious({select:!1,unit:"word"})}},wordNext:{defaultHandler:function(){return s._doCursorNext({select:!1,unit:"word"})}},textStart:{defaultHandler:function(){return s._doHome({select:!1,ctrl:!0})}},textEnd:{defaultHandler:function(){return s._doEnd({select:!1,ctrl:!0})}},scrollTextStart:{defaultHandler:function(){return s._doScroll({type:"textStart"})}},scrollTextEnd:{defaultHandler:function(){return s._doScroll({type:"textEnd"})}},centerLine:{defaultHandler:function(){return s._doScroll({type:"centerLine"})}},selectLineUp:{defaultHandler:function(){return s._doLineUp({select:!0})}},selectLineDown:{defaultHandler:function(){return s._doLineDown({select:!0})}},selectWholeLineUp:{defaultHandler:function(){return s._doLineUp({select:!0,wholeLine:!0})}},selectWholeLineDown:{defaultHandler:function(){return s._doLineDown({select:!0,wholeLine:!0})}},selectLineStart:{defaultHandler:function(){return s._doHome({select:!0,ctrl:!1})}},selectLineEnd:{defaultHandler:function(){return s._doEnd({select:!0,ctrl:!1})}},selectCharPrevious:{defaultHandler:function(){return s._doCursorPrevious({select:!0,unit:"character"})}},selectCharNext:{defaultHandler:function(){return s._doCursorNext({select:!0,unit:"character"})}},selectPageUp:{defaultHandler:function(){return s._doPageUp({select:!0})}},selectPageDown:{defaultHandler:function(){return s._doPageDown({select:!0})}},selectWordPrevious:{defaultHandler:function(){return s._doCursorPrevious({select:!0,unit:"word"})}},selectWordNext:{defaultHandler:function(){return s._doCursorNext({select:!0,unit:"word"})}},selectTextStart:{defaultHandler:function(){return s._doHome({select:!0,ctrl:!0})}},selectTextEnd:{defaultHandler:function(){return s._doEnd({select:!0,ctrl:!0})}},deletePrevious:{defaultHandler:function(){return s._doBackspace({unit:"character"})}},deleteNext:{defaultHandler:function(){return s._doDelete({unit:"character"})}},deleteWordPrevious:{defaultHandler:function(){return s._doBackspace({unit:"word"})}},deleteWordNext:{defaultHandler:function(){return s._doDelete({unit:"word"})}},deleteLineStart:{defaultHandler:function(){return s._doBackspace({unit:"line"})}},deleteLineEnd:{defaultHandler:function(){return s._doDelete({unit:"line"})}},tab:{defaultHandler:function(){return s._doTab()}},shiftTab:{defaultHandler:function(){return s._doShiftTab()}},enter:{defaultHandler:function(){return s._doEnter()}},enterNoCursor:{defaultHandler:function(){return s._doEnter({noCursor:!0})}},selectAll:{defaultHandler:function(){return s._doSelectAll()}},copy:{defaultHandler:function(){return s._doCopy()}},cut:{defaultHandler:function(){return s._doCut()}},paste:{defaultHandler:function(){return s._doPaste()}},toggleWrapMode:{defaultHandler:function(){return s._doWrapMode()}},toggleTabMode:{defaultHandler:function(){return s._doTabMode()}}}},_createRuler:function(e,t){if(!this._clientDiv)return;var n=e.getLocation(),i=n==="left"?this._leftDiv:this._rightDiv;i.style.display="block";var s=r.createElement(i.ownerDocument,"div");s._ruler=e,s.rulerChanged=!0,s.style.position="relative";var o=i.firstChild.rows[0],u=o.cells.length;t=t===undefined||t<0||t>u?u:t;var a=o.insertCell(t);a.vAlign="top",a.appendChild(s)},_createView:function(){if(this._clientDiv)return;var e=this._parent;while(e.hasChildNodes())e.removeChild(e.lastChild);var t=e.ownerDocument,n=r.createElement(t,"div");this._rootDiv=n,n.tabIndex=-1,n.style.position="relative",n.style.overflow="hidden",n.style.width="100%",n.style.height="100%",e.style.overflow="hidden",n.setAttribute("role","application"),e.appendChild(n);var i=r.createElement(t,"div");i.className="textviewLeftRuler",this._leftDiv=i,i.tabIndex=-1,i.style.overflow="hidden",i.style.MozUserSelect="none",i.style.WebkitUserSelect="none",i.style.position="absolute",i.style.cursor="default",i.style.display="none",i.setAttribute("aria-hidden","true");var s=r.createElement(t,"table");i.appendChild(s),s.cellPadding="0px",s.cellSpacing="0px",s.border="0px",s.insertRow(0),n.appendChild(i);var o=r.createElement(t,"div");o.className="textview",this._viewDiv=o,o.tabIndex=-1,o.style.overflow="auto",o.style.position="absolute",o.style.top="0px",o.style.bottom="0px",o.style.borderWidth="0px",o.style.margin="0px",o.style.outline="none",n.appendChild(o);var u=r.createElement(t,"div");u.className="textviewRightRuler",this._rightDiv=u,u.tabIndex=-1,u.style.display="none",u.style.overflow="hidden",u.style.MozUserSelect="none",u.style.WebkitUserSelect="none",u.style.position="absolute",u.style.cursor="default",u.style.right="0px",u.setAttribute("aria-hidden","true"),s=r.createElement(t,"table"),u.appendChild(s),s.cellPadding="0px",s.cellSpacing="0px",s.border="0px",s.insertRow(0),n.appendChild(u);var a=r.createElement(t,"div");this._scrollDiv=a,a.style.margin="0px",a.style.borderWidth="0px",a.style.padding="0px",o.appendChild(a);if(r.isFirefox){var f=r.createElement(t,"div");this._clipboardDiv=f,f.style.position="fixed",f.style.whiteSpace="pre",f.style.left="-1000px",n.appendChild(f)}if(!r.isIE&&!r.isIOS){var l=r.createElement(t,"div");this._clipDiv=l,l.style.position="absolute",l.style.overflow="hidden",l.style.margin="0px",l.style.borderWidth="0px",l.style.padding="0px",n.appendChild(l);var c=r.createElement(t,"div");this._clipScrollDiv=c,c.style.position="absolute",c.style.height="1px",c.style.top="-1000px",l.appendChild(c)}this._setFullSelection(this._fullSelection,!0);var h=r.createElement(t,"div");h.className="textviewContent",this._clientDiv=h,h.style.position="absolute",h.style.borderWidth="0px",h.style.margin="0px",h.style.padding="0px",h.style.outline="none",h.style.zIndex="1",h.style.WebkitUserSelect="text",h.setAttribute("spellcheck","false");if(r.isIOS||r.isAndroid)h.style.WebkitTapHighlightColor="transparent";(this._clipDiv||n).appendChild(h);if(r.isIOS||r.isAndroid){var p=r.createElement(t,"div");this._vScrollDiv=p,p.style.position="absolute",p.style.borderWidth="1px",p.style.borderColor="white",p.style.borderStyle="solid",p.style.borderRadius="4px",p.style.backgroundColor="black",p.style.opacity="0.5",p.style.margin="0px",p.style.padding="0px",p.style.outline="none",p.style.zIndex="3",p.style.width="8px",p.style.display="none",n.appendChild(p);var d=r.createElement(t,"div");this._hScrollDiv=d,d.style.position="absolute",d.style.borderWidth="1px",d.style.borderColor="white",d.style.borderStyle="solid",d.style.borderRadius="4px",d.style.backgroundColor="black",d.style.opacity="0.5",d.style.margin="0px",d.style.padding="0px",d.style.outline="none",d.style.zIndex="3",d.style.height="8px",d.style.display="none",n.appendChild(d)}if(r.isFirefox&&!h.setCapture){var v=r.createElement(t,"div");this._overlayDiv=v,v.style.position=h.style.position,v.style.borderWidth=h.style.borderWidth,v.style.margin=h.style.margin,v.style.padding=h.style.padding,v.style.cursor="text",v.style.zIndex="2",(this._clipDiv||n).appendChild(v)}h.contentEditable="true",h.setAttribute("role","textbox"),h.setAttribute("aria-multiline","true"),this._setWrapMode(this._wrapMode,!0),this._setReadOnly(this._readonly),this._setThemeClass(this._themeClass,!0),this._setTabSize(this._tabSize,!0);if(!t.getElementById("_textviewStyle")){var m="";r.isWebkit&&this._metrics.scrollWidth>0&&(m+="\n.textviewContainer ::-webkit-scrollbar-corner {background: #eeeeee;}"),r.isFirefox&&r.isMac&&this._highlightRGB&&this._highlightRGB!=="Highlight"&&(m+="\n.textviewContainer ::-moz-selection {background: "+this._highlightRGB+";}");if(m){var g=r.createElement(t,"style");g.id="_textviewStyle";var y=t.getElementsByTagName("head")[0]||t.documentElement;g.appendChild(t.createTextNode(m)),y.insertBefore(g,y.firstChild)}}this._hookEvents();var b=this._rulers;for(var w=0;w<b.length;w++)this._createRuler(b[w]);this._update()},_defaultOptions:function(){return{parent:{value:undefined,update:null},model:{value:undefined,update:this.setModel},readonly:{value:!1,update:this._setReadOnly},fullSelection:{value:!0,update:this._setFullSelection},tabMode:{value:!0,update:null},tabSize:{value:8,update:this._setTabSize},expandTab:{value:!1,update:null},wrapMode:{value:!1,update:this._setWrapMode},themeClass:{value:undefined,update:this._setThemeClass}}},_destroyRuler:function(e){var t=e.getLocation(),n=t==="left"?this._leftDiv:this._rightDiv;if(n){var r=n.firstChild.rows[0],i=r.cells;for(var s=0;s<i.length;s++){var o=i[s];if(o.firstChild._ruler===e)break}if(s===i.length)return;r.cells[s]._ruler=undefined,r.deleteCell(s),i.length===0&&(n.style.display="none")}},_destroyView:function(){var e=this._clientDiv;if(!e)return;this._setGrab(null),this._unhookEvents();var t=this._getWindow();this._autoScrollTimerID&&(t.clearTimeout(this._autoScrollTimerID),this._autoScrollTimerID=null),this._updateTimer&&(t.clearTimeout(this._updateTimer),this._updateTimer=null);var n=this._rootDiv;n.parentNode.removeChild(n),this._selDiv1=null,this._selDiv2=null,this._selDiv3=null,this._clipboardDiv=null,this._rootDiv=null,this._scrollDiv=null,this._viewDiv=null,this._clipDiv=null,this._clipScrollDiv=null,this._clientDiv=null,this._overlayDiv=null,this._leftDiv=null,this._rightDiv=null,this._vScrollDiv=null,this._hScrollDiv=null},_doAutoScroll:function(e,t,n){this._autoScrollDir=e,this._autoScrollX=t,this._autoScrollY=n,this._autoScrollTimerID||this._autoScrollTimer()},_endAutoScroll:function(){if(this._autoScrollTimerID){var e=this._getWindow();e.clearTimeout(this._autoScrollTimerID)}this._autoScrollDir=undefined,this._autoScrollTimerID=undefined},_fixCaret:function(){var e=this._clientDiv;if(e){var t=this._hasFocus;this._ignoreFocus=!0,t&&e.blur(),e.contentEditable=!1,e.contentEditable=!0,t&&e.focus(),this._ignoreFocus=!1}},_getBaseText:function(e,t){var n=this._model;return n.getBaseModel&&(e=n.mapOffset(e),t=n.mapOffset(t),n=n.getBaseModel()),n.getText(e,t)},_getBottomIndex:function(e){var t=this._bottomChild;if(e&&this._getClientHeight()>this._getLineHeight()){var n=t.getBoundingClientRect(),r=this._clientDiv.getBoundingClientRect();n.bottom>r.bottom&&(t=this._getLinePrevious(t)||t)}return t.lineIndex},_getBoundsAtOffset:function(e){var t=this._model,n=this._getLine(t.getLineAtOffset(e)),r=n.getBoundingClientRect(e),i=this._getLinePixel(n.lineIndex);return r.top+=i,r.bottom+=i,n.destroy(),r},_getClientHeight:function(){var e=this._getViewPadding();return Math.max(0,this._viewDiv.clientHeight-e.top-e.bottom)},_getClientWidth:function(){var e=this._getViewPadding();return Math.max(0,this._viewDiv.clientWidth-e.left-e.right)},_getClipboardText:function(e,t){var n=this._model.getLineDelimiter(),i,s,o=this._getWindow();if(o.clipboardData)return i=[],s=o.clipboardData.getData("Text"),l(s,function(e){i.push(e)},function(){i.push(n)}),s=i.join(""),t&&t(s),s;if(r.isFirefox){this._ignoreFocus=!0;var u=this._clipboardDiv;u.innerHTML="<pre contenteditable=''></pre>",u.firstChild.focus();var a=this,f=function(){var e=a._getTextFromElement(u);return u.innerHTML="",i=[],l(e,function(e){i.push(e)},function(){i.push(n)}),i.join("")},c=!1;this._ignorePaste=!0;if(!r.isLinux||this._lastMouseButton!==2)try{var h=u.ownerDocument;c=h.execCommand("paste",!1,null)}catch(p){c=u.childNodes.length>1||u.firstChild&&u.firstChild.childNodes.length>0}return this._ignorePaste=!1,c?(this.focus(),this._ignoreFocus=!1,s=f(),s&&t&&t(s),s):e?(o.setTimeout(function(){a.focus(),s=f(),s&&t&&t(s),a._ignoreFocus=!1},0),null):(this.focus(),this._ignoreFocus=!1,"")}return e&&e.clipboardData?(i=[],s=e.clipboardData.getData("text/plain"),l(s,function(e){i.push(e)},function(){i.push(n)}),s=i.join(""),s&&t&&t(s),s):""},_getDOMText:function(e,t){var n=e.firstChild,r="",i=0;while(n){var s;if(n.ignoreChars){s=n.lastChild;var o=0,u=[],a=-1;while(s){var f=s.data;for(var l=f.length-1;l>=0;l--){var c=f.substring(l,l+1);o<n.ignoreChars&&(c===" "||c==="\u200c"||c==="\ufeff")?o++:u.push(c==="\u00a0"?"	":c)}t===s&&(a=u.length),s=s.previousSibling}u=u.reverse().join(""),a!==-1&&(i=r.length+u.length-a),r+=u}else{s=n.firstChild;while(s)t===s&&(i=r.length),r+=s.data,s=s.nextSibling}n=n.nextSibling}return{text:r,offset:i}},_getTextFromElement:function(e){var t=e.ownerDocument,n=t.defaultView;if(!n.getSelection)return e.innerText||e.textContent;var r=t.createRange();r.selectNode(e);var i=n.getSelection(),s=[],o;for(o=0;o<i.rangeCount;o++)s.push(i.getRangeAt(o));this._ignoreSelect=!0,i.removeAllRanges(),i.addRange(r);var u=i.toString();i.removeAllRanges();for(o=0;o<s.length;o++)i.addRange(s[o]);return this._ignoreSelect=!1,u},_getViewPadding:function(){return this._metrics.viewPadding},_getLine:function(e){var t=this._getLineNode(e);return t&&!t.lineChanged&&!t.lineRemoved?t._line:new m(this,e)},_getLineHeight:function(e,t){if(e!==undefined&&this._lineHeight){var n=this._lineHeight[e];if(n)return n;if(t||t===undefined){var r=this._lineHeight[e]=this._calculateLineHeight(e);return r}}return this._metrics.lineHeight},_getLineNode:function(e){var t=this._clientDiv,n=t.firstChild;while(n){if(e===n.lineIndex)return n;n=n.nextSibling}return undefined},_getLineNext:function(e){var t=e?e.nextSibling:this._clientDiv.firstChild;while(t&&t.lineIndex===-1)t=t.nextSibling;return t},_getLinePrevious:function(e){var t=e?e.previousSibling:this._clientDiv.lastChild;while(t&&t.lineIndex===-1)t=t.previousSibling;return t},_getLinePixel:function(e){e=Math.min(Math.max(0,e),this._model.getLineCount());if(this._lineHeight){var t=this._getTopIndex(),n=-this._topIndexY+this._getScroll().y,r;if(e>t)for(r=t;r<e;r++)n+=this._getLineHeight(r);else for(r=t-1;r>=e;r--)n-=this._getLineHeight(r);return n}var i=this._getLineHeight();return i*e},_getLineIndex:function(e){var t,n=0,r=this._model.getLineCount();if(this._lineHeight){n=this._getTopIndex();var i=-this._topIndexY+this._getScroll().y;if(e!==i)if(e<i)while(e<i&&n>0)e+=this._getLineHeight(--n);else{t=this._getLineHeight(n);while(e-t>=i&&n<r-1)e-=t,t=this._getLineHeight(++n)}}else t=this._getLineHeight(),n=Math.floor(e/t);return Math.max(0,Math.min(r-1,n))},_getScroll:function(){var e=this._viewDiv;return{x:e.scrollLeft,y:e.scrollTop}},_getSelection:function(){return this._selection.clone()},_getTopIndex:function(e){var t=this._topChild;if(e&&this._getClientHeight()>this._getLineHeight()){var n=t.getBoundingClientRect(),r=this._getViewPadding(),i=this._viewDiv.getBoundingClientRect();n.top<i.top+r.top&&(t=this._getLineNext(t)||t)}return t.lineIndex},_hookEvents:function(){var e=this;this._modelListener={onChanging:function(t){e._onModelChanging(t)},onChanged:function(t){e._onModelChanged(t)}},this._model.addEventListener("preChanging",this._modelListener.onChanging),this._model.addEventListener("postChanged",this._modelListener.onChanged);var t=this._handlers=[],n=this._clientDiv,i=this._viewDiv,o=this._rootDiv,u=this._overlayDiv||n,a=n.ownerDocument,f=this._getWindow(),l=r.isIE?a:f;t.push({target:f,type:"resize",handler:function(t){return e._handleResize(t?t:f.event)}}),t.push({target:n,type:"blur",handler:function(t){return e._handleBlur(t?t:f.event)}}),t.push({target:n,type:"focus",handler:function(t){return e._handleFocus(t?t:f.event)}}),t.push({target:i,type:"focus",handler:function(e){n.focus()}}),t.push({target:i,type:"scroll",handler:function(t){return e._handleScroll(t?t:f.event)}}),t.push({target:n,type:"textInput",handler:function(t){return e._handleTextInput(t?t:f.event)}}),t.push({target:n,type:"keydown",handler:function(t){return e._handleKeyDown(t?t:f.event)}}),t.push({target:n,type:"keypress",handler:function(t){return e._handleKeyPress(t?t:f.event)}}),t.push({target:n,type:"keyup",handler:function(t){return e._handleKeyUp(t?t:f.event)}}),t.push({target:n,type:"contextmenu",handler:function(t){return e._handleContextMenu(t?t:f.event)}}),t.push({target:n,type:"copy",handler:function(t){return e._handleCopy(t?t:f.event)}}),t.push({target:n,type:"cut",handler:function(t){return e._handleCut(t?t:f.event)}}),t.push({target:n,type:"paste",handler:function(t){return e._handlePaste(t?t:f.event)}});if(r.isIOS||r.isAndroid)t.push({target:a,type:"selectionchange",handler:function(t){return e._handleSelectionChange(t?t:f.event)}}),t.push({target:n,type:"touchstart",handler:function(t){return e._handleTouchStart(t?t:f.event)}}),t.push({target:n,type:"touchmove",handler:function(t){return e._handleTouchMove(t?t:f.event)}}),t.push({target:n,type:"touchend",handler:function(t){return e._handleTouchEnd(t?t:f.event)}});else{t.push({target:n,type:"selectstart",handler:function(t){return e._handleSelectStart(t?t:f.event)}}),t.push({target:n,type:"mousedown",handler:function(t){return e._handleMouseDown(t?t:f.event)}}),t.push({target:n,type:"mouseover",handler:function(t){return e._handleMouseOver(t?t:f.event)}}),t.push({target:n,type:"mouseout",handler:function(t){return e._handleMouseOut(t?t:f.event)}}),t.push({target:l,type:"mouseup",handler:function(t){return e._handleMouseUp(t?t:f.event)}}),t.push({target:l,type:"mousemove",handler:function(t){return e._handleMouseMove(t?t:f.event)}}),t.push({target:o,type:"mousedown",handler:function(t){return e._handleRootMouseDown(t?t:f.event)}}),t.push({target:o,type:"mouseup",handler:function(t){return e._handleRootMouseUp(t?t:f.event)}}),t.push({target:u,type:"dragstart",handler:function(t){return e._handleDragStart(t?t:f.event)}}),t.push({target:u,type:"drag",handler:function(t){return e._handleDrag(t?t:f.event)}}),t.push({target:u,type:"dragend",handler:function(t){return e._handleDragEnd(t?t:f.event)}}),t.push({target:u,type:"dragenter",handler:function(t){return e._handleDragEnter(t?t:f.event)}}),t.push({target:u,type:"dragover",handler:function(t){return e._handleDragOver(t?t:f.event)}}),t.push({target:u,type:"dragleave",handler:function(t){return e._handleDragLeave(t?t:f.event)}}),t.push({target:u,type:"drop",handler:function(t){return e._handleDrop(t?t:f.event)}}),t.push({target:this._clientDiv,type:r.isFirefox?"DOMMouseScroll":"mousewheel",handler:function(t){return e._handleMouseWheel(t?t:f.event)}});if(r.isFirefox&&(!r.isWindows||r.isFirefox>=15)){var c=f.MutationObserver||f.MozMutationObserver;c?(this._mutationObserver=new c(function(t){e._handleDataModified(t)}),this._mutationObserver.observe(n,{subtree:!0,characterData:!0})):t.push({target:this._clientDiv,type:"DOMCharacterDataModified",handler:function(t){return e._handleDataModified(t?t:f.event)}})}this._overlayDiv&&(t.push({target:this._overlayDiv,type:"mousedown",handler:function(t){return e._handleMouseDown(t?t:f.event)}}),t.push({target:this._overlayDiv,type:"mouseover",handler:function(t){return e._handleMouseOver(t?t:f.event)}}),t.push({target:this._overlayDiv,type:"mouseout",handler:function(t){return e._handleMouseOut(t?t:f.event)}}),t.push({target:this._overlayDiv,type:"contextmenu",handler:function(t){return e._handleContextMenu(t?t:f.event)}})),this._isW3CEvents||t.push({target:this._clientDiv,type:"dblclick",handler:function(t){return e._handleDblclick(t?t:f.event)}})}var h=this._leftDiv,p=this._rightDiv;r.isIE&&t.push({target:h,type:"selectstart",handler:function(){return!1}}),t.push({target:h,type:r.isFirefox?"DOMMouseScroll":"mousewheel",handler:function(t){return e._handleMouseWheel(t?t:f.event)}}),t.push({target:h,type:"click",handler:function(t){e._handleRulerEvent(t?t:f.event)}}),t.push({target:h,type:"dblclick",handler:function(t){e._handleRulerEvent(t?t:f.event)}}),t.push({target:h,type:"mousemove",handler:function(t){e._handleRulerEvent(t?t:f.event)}}),t.push({target:h,type:"mouseover",handler:function(t){e._handleRulerEvent(t?t:f.event)}}),t.push({target:h,type:"mouseout",handler:function(t){e._handleRulerEvent(t?t:f.event)}}),r.isIE&&t.push({target:p,type:"selectstart",handler:function(){return!1}}),t.push({target:p,type:r.isFirefox?"DOMMouseScroll":"mousewheel",handler:function(t){return e._handleMouseWheel(t?t:f.event)}}),t.push({target:p,type:"click",handler:function(t){e._handleRulerEvent(t?t:f.event)}}),t.push({target:p,type:"dblclick",handler:function(t){e._handleRulerEvent(t?t:f.event)}}),t.push({target:p,type:"mousemove",handler:function(t){e._handleRulerEvent(t?t:f.event)}}),t.push({target:p,type:"mouseover",handler:function(t){e._handleRulerEvent(t?t:f.event)}}),t.push({target:p,type:"mouseout",handler:function(t){e._handleRulerEvent(t?t:f.event)}});for(var d=0;d<t.length;d++){var v=t[d];s(v.target,v.type,v.handler,v.capture)}},_getWindow:function(){return i(this._parent.ownerDocument)},_init:function(t){var n=t.parent;typeof n=="string"&&(n=(t.document||document).getElementById(n));if(!n)throw"no parent";t.parent=n,t.model=t.model||new e.TextModel;var i=this._defaultOptions();for(var s in i)if(i.hasOwnProperty(s)){var o;t[s]!==undefined?o=t[s]:o=i[s].value,this["_"+s]=o}this._rulers=[],this._selection=new d(0,0,!1),this._linksVisible=!1,this._redrawCount=0,this._maxLineWidth=0,this._maxLineIndex=-1,this._ignoreSelect=!0,this._ignoreFocus=!1,this._hasFocus=!1,this._columnX=-1,this._dragOffset=-1,this._isRangeRects=(!r.isIE||r.isIE>=9)&&typeof n.ownerDocument.createRange().getBoundingClientRect=="function",this._isW3CEvents=n.addEventListener,this._autoScrollX=null,this._autoScrollY=null,this._autoScrollTimerID=null,this._AUTO_SCROLL_RATE=50,this._grabControl=null,this._moseMoveClosure=null,this._mouseUpClosure=null,this._lastMouseX=0,this._lastMouseY=0,this._lastMouseTime=0,this._clickCount=0,this._clickTime=250,this._clickDist=5,this._isMouseDown=!1,this._doubleClickSelection=null,this._hScroll=0,this._vScroll=0,this._imeOffset=-1,this._createActions(),this._createView()},_modifyContent:function(e,t){if(this._readonly&&!e._code)return;e.type="Verify",this.onVerify(e);if(e.text===null||e.text===undefined)return;var n=this._model;try{e._ignoreDOMSelection&&(this._ignoreDOMSelection=!0),n.setText(e.text,e.start,e.end)}finally{e._ignoreDOMSelection&&(this._ignoreDOMSelection=!1)}if(t){var r=this._getSelection();r.setCaret(e.start+e.text.length),this._setSelection(r,!0)}this.onModify({type:"Modify"})},_onModelChanged:function(e){e.type="ModelChanged",this.onModelChanged(e),e.type="Changed";var t=e.start,n=e.addedCharCount,r=e.removedCharCount,i=e.addedLineCount,s=e.removedLineCount,o=this._getSelection();o.end>t&&(o.end>t&&o.start<t+r?o.setCaret(t+n):(o.start+=n-r,o.end+=n-r),this._setSelection(o,!1,!1));var u=this._model,a=u.getLineAtOffset(t),f=this._getLineNext();while(f){var l=f.lineIndex;a<=l&&l<=a+s&&(a===l&&!f.modelChangedEvent&&!f.lineRemoved?(f.modelChangedEvent=e,f.lineChanged=!0):(f.lineRemoved=!0,f.lineChanged=!1,f.modelChangedEvent=null)),l>a+s&&(f.lineIndex=l+i-s,f._line.lineIndex=f.lineIndex),f=this._getLineNext(f)}this._wrapMode||a<=this._maxLineIndex&&this._maxLineIndex<=a+s&&(this._checkMaxLineIndex=this._maxLineIndex,this._maxLineIndex=-1,this._maxLineWidth=0),this._update()},_onModelChanging:function(e){e.type="ModelChanging",this.onModelChanging(e),e.type="Changing"},_queueUpdate:function(){if(this._updateTimer||this._ignoreQueueUpdate)return;var e=this,t=this._getWindow();this._updateTimer=t.setTimeout(function(){e._updateTimer=null,e._update()},0)},_resetLineHeight:function(e,t){if(this._wrapMode){if(e!==undefined&&t!==undefined)for(var n=e;n<t;n++)this._lineHeight[n]=undefined;else this._lineHeight=new Array(this._model.getLineCount());this._calculateLineHeightTimer()}else this._lineHeight=null},_resetLineWidth:function(){var e=this._clientDiv;if(e){var t=e.firstChild;while(t)t.lineWidth=undefined,t=t.nextSibling}},_reset:function(){this._maxLineIndex=-1,this._maxLineWidth=0,this._columnX=-1,this._topChild=null,this._bottomChild=null,this._topIndexY=0,this._resetLineHeight(),this._setSelection(new d(0,0,!1),!1,!1),this._viewDiv&&(this._viewDiv.scrollLeft=0,this._viewDiv.scrollTop=0);var e=this._clientDiv;if(e){var t=e.firstChild;while(t)t.lineRemoved=!0,t=t.nextSibling;if(r.isFirefox){this._ignoreFocus=!1;var n=this._hasFocus;n&&e.blur(),e.contentEditable=!1,e.contentEditable=!0,n&&e.focus(),this._ignoreFocus=!1}}},_scrollView:function(e,t){this._ensureCaretVisible=!1;var n=this._viewDiv;e&&(n.scrollLeft+=e),t&&(n.scrollTop+=t)},_setClipboardText:function(e,t){var n,i=this._parent.ownerDocument,s=this._getWindow();if(s.clipboardData)return n=[],l(e,function(e){n.push(e)},function(){n.push(r.platformDelimiter)}),s.clipboardData.setData("Text",n.join(""));if(t&&t.clipboardData){n=[],l(e,function(e){n.push(e)},function(){n.push(r.platformDelimiter)});if(t.clipboardData.setData("text/plain",n.join("")))return!0}var o=r.createElement(i,"pre");o.style.position="fixed",o.style.left="-1000px",l(e,function(e){o.appendChild(i.createTextNode(e))},function(){o.appendChild(r.createElement(i,"br"))}),o.appendChild(i.createTextNode(" ")),this._clientDiv.appendChild(o);var u=i.createRange();u.setStart(o.firstChild,0),u.setEndBefore(o.lastChild);var a=s.getSelection();a.rangeCount>0&&a.removeAllRanges(),a.addRange(u);var f=this,c=function(){o&&o.parentNode===f._clientDiv&&f._clientDiv.removeChild(o),f._updateDOMSelection()},h=!1;this._ignoreCopy=!0;try{h=i.execCommand("copy",!1,null)}catch(p){}return this._ignoreCopy=!1,!h&&t?(s.setTimeout(c,0),!1):(c(),!0)},_setDOMSelection:function(e,t,n,i){var s,o,u,a,f=0,l=e.firstChild,c,h,p=this._model,d=p.getLine(e.lineIndex).length;while(l){c=l.firstChild,h=c.length,l.ignoreChars&&(h-=l.ignoreChars);if(f+h>t||f+h>=d){s=c,o=t-f,l.ignoreChars&&h>0&&o===h&&(o+=l.ignoreChars);break}f+=h,l=l.nextSibling}f=0,l=n.firstChild;var v=this._model.getLine(n.lineIndex).length;while(l){c=l.firstChild,h=c.length,l.ignoreChars&&(h-=l.ignoreChars);if(h+f>i||f+h>=v){u=c,a=i-f,l.ignoreChars&&h>0&&a===h&&(a+=l.ignoreChars);break}f+=h,l=l.nextSibling}this._setDOMFullSelection(e,t,d,n,i,v);if(!this._hasFocus)return;var m,g=this._getWindow(),y=this._parent.ownerDocument;if(g.getSelection){var b=g.getSelection();if(b.anchorNode===s&&b.anchorOffset===o&&b.focusNode===u&&b.focusOffset===a||b.anchorNode===u&&b.anchorOffset===a&&b.focusNode===s&&b.focusOffset===o)return;m=y.createRange(),m.setStart(s,o),m.setEnd(u,a),this._ignoreSelect=!1,b.rangeCount>0&&b.removeAllRanges(),b.addRange(m),this._ignoreSelect=!0}else if(y.selection){var w=y.body,E=r.createElement(y,"div");w.appendChild(E),w.removeChild(E),m=w.createTextRange(),m.moveToElementText(s.parentNode),m.moveStart("character",o);var S=w.createTextRange();S.moveToElementText(u.parentNode),S.moveStart("character",a),m.setEndPoint("EndToStart",S),this._ignoreSelect=!1,m.select(),this._ignoreSelect=!0}},_setDOMFullSelection:function(e,t,n,r,i,s){if(!this._selDiv1)return;var o=this._selDiv1;o.style.width="0px",o.style.height="0px",o=this._selDiv2,o.style.width="0px",o.style.height="0px",o=this._selDiv3,o.style.width="0px",o.style.height="0px";if(e===r&&t===i)return;var u=this._model,a=this._getViewPadding(),f=this._clientDiv.getBoundingClientRect(),l=this._viewDiv.getBoundingClientRect(),c=l.left+a.left,h=f.right,p=l.top+a.top,d=f.bottom,v=0,g=0;if(this._clipDiv){var y=this._clipDiv.getBoundingClientRect();v=y.left-this._clipDiv.scrollLeft,g=y.top}else{var b=this._rootDiv.getBoundingClientRect();v=b.left,g=b.top}this._ignoreDOMSelection=!0;var w=new m(this,e.lineIndex,e),E=w.getBoundingClientRect(u.getLineStart(e.lineIndex)+t,!1),S=E.left,x=new m(this,r.lineIndex,r),T=x.getBoundingClientRect(u.getLineStart(r.lineIndex)+i,!1),N=T.left;this._ignoreDOMSelection=!1;var C=this._selDiv1,k=Math.min(h,Math.max(c,S)),L=Math.min(d,Math.max(p,E.top)),A=h,O=Math.min(d,Math.max(p,E.bottom));C.style.left=k-v+"px",C.style.top=L-g+"px",C.style.width=Math.max(0,A-k)+"px",C.style.height=Math.max(0,O-L)+"px";if(E.top===T.top)A=Math.min(N,h),C.style.width=Math.max(0,A-k)+"px";else{var M=c,_=Math.min(d,Math.max(p,T.top)),D=Math.min(h,Math.max(c,N)),P=Math.min(d,Math.max(p,T.bottom)),H=this._selDiv3;H.style.left=M-v+"px",H.style.top=_-g+"px",H.style.width=Math.max(0,D-M)+"px",H.style.height=Math.max(0,P-_)+"px";if(_-O>0){var B=this._selDiv2;B.style.left=c-v+"px",B.style.top=O-g+"px",B.style.width=Math.max(0,h-c)+"px",B.style.height=Math.max(0,_-O)+"px"}}},_setGrab:function(e){if(e===this._grabControl)return;e?(e.setCapture&&e.setCapture(),this._grabControl=e):(this._grabControl.releaseCapture&&this._grabControl.releaseCapture(),this._grabControl=null)},_setLinksVisible:function(e){if(this._linksVisible===e)return;this._linksVisible=e,r.isIE&&e&&(this._hadFocus=this._hasFocus);var t=this._clientDiv;t.contentEditable=!e,this._hadFocus&&!e&&t.focus(),this._overlayDiv&&(this._overlayDiv.style.zIndex=e?"-1":"1");var n=this._getLineNext();while(n){if(n.hasLink){var i=n.firstChild;while(i){var s=i.nextSibling,o=i.viewStyle;o&&o.tagName==="A"&&n.replaceChild(n._line._createSpan(n,i.firstChild.data,o),i),i=s}}n=this._getLineNext(n)}},_setSelection:function(e,t,n,r){if(e){this._columnX=-1,n===undefined&&(n=!0);var i=this._selection;this._selection=e,t&&this._showCaret(!1,r),n&&this._updateDOMSelection();if(!i.equals(e)){var s={type:"Selection",oldValue:{start:i.start,end:i.end},newValue:{start:e.start,end:e.end}};this.onSelection(s)}}},_setSelectionTo:function(e,t,n,r){var i=this._model,s,o=this._getSelection(),u=this.convert({x:e,y:t},"page","document"),a=this._getLineIndex(u.y),f;if(this._clickCount===1){f=this._getLine(a),s=f.getOffset(u.x,u.y-this._getLinePixel(a)),f.destroy();if(r&&!n&&o.start<=s&&s<o.end)return this._dragOffset=s,!1;o.extend(s),n||o.collapse()}else{var l=(this._clickCount&1)===0,c,h;if(l)f=this._getLine(a),s=f.getOffset(u.x,u.y-this._getLinePixel(a)),this._doubleClickSelection?s>=this._doubleClickSelection.start?(c=this._doubleClickSelection.start,h=f.getNextOffset(s,"wordend",1)):(c=f.getNextOffset(s,"word",-1),h=this._doubleClickSelection.end):(c=f.getNextOffset(s,"word",-1),h=f.getNextOffset(c,"wordend",1)),f.destroy();else if(this._doubleClickSelection){var p=i.getLineAtOffset(this._doubleClickSelection.start);a>=p?(c=i.getLineStart(p),h=i.getLineEnd(a)):(c=i.getLineStart(a),h=i.getLineEnd(p))}else c=i.getLineStart(a),h=i.getLineEnd(a);o.setCaret(c),o.extend(h)}return this._setSelection(o,!0,!0),!0},_setFullSelection:function(e,t){this._fullSelection=e,r.isWebkit&&(this._fullSelection=!0);var n=this._clipDiv||this._rootDiv;if(!n)return;if(!this._fullSelection){this._selDiv1&&(n.removeChild(this._selDiv1),this._selDiv1=null),this._selDiv2&&(n.removeChild(this._selDiv2),this._selDiv2=null),this._selDiv3&&(n.removeChild(this._selDiv3),this._selDiv3=null);return}if(!this._selDiv1&&this._fullSelection&&!r.isIOS){var i=n.ownerDocument;this._highlightRGB=r.isWebkit?"transparent":"Highlight";var s=r.createElement(i,"div");this._selDiv1=s,s.style.position="absolute",s.style.borderWidth="0px",s.style.margin="0px",s.style.padding="0px",s.style.outline="none",s.style.background=this._highlightRGB,s.style.width="0px",s.style.height="0px",s.style.zIndex="0",n.appendChild(s);var o=r.createElement(i,"div");this._selDiv2=o,o.style.position="absolute",o.style.borderWidth="0px",o.style.margin="0px",o.style.padding="0px",o.style.outline="none",o.style.background=this._highlightRGB,o.style.width="0px",o.style.height="0px",o.style.zIndex="0",n.appendChild(o);var u=r.createElement(i,"div");this._selDiv3=u,u.style.position="absolute",u.style.borderWidth="0px",u.style.margin="0px",u.style.padding="0px",u.style.outline="none",u.style.background=this._highlightRGB,u.style.width="0px",u.style.height="0px",u.style.zIndex="0",n.appendChild(u);if(r.isFirefox&&r.isMac){var a=this._getWindow(),f=a.getComputedStyle(u,null),l=f.getPropertyValue("background-color");switch(l){case"rgb(119, 141, 168)":l="rgb(199, 208, 218)";break;case"rgb(127, 127, 127)":l="rgb(198, 198, 198)";break;case"rgb(255, 193, 31)":l="rgb(250, 236, 115)";break;case"rgb(243, 70, 72)":l="rgb(255, 176, 139)";break;case"rgb(255, 138, 34)":l="rgb(255, 209, 129)";break;case"rgb(102, 197, 71)":l="rgb(194, 249, 144)";break;case"rgb(140, 78, 184)":l="rgb(232, 184, 255)";break;default:l="rgb(180, 213, 255)"}this._highlightRGB=l,s.style.background=l,o.style.background=l,u.style.background=l}t||this._updateDOMSelection()}},_setReadOnly:function(e){this._readonly=e,this._clientDiv.setAttribute("aria-readonly",e?"true":"false")},_setTabSize:function(e,t){this._tabSize=e,this._customTabSize=undefined;var n=this._clientDiv;r.isOpera?n&&(n.style.OTabSize=this._tabSize+""):r.isWebkit>=537.1?n&&(n.style.tabSize=this._tabSize+""):r.isFirefox>=4?n&&(n.style.MozTabSize=this._tabSize+""):this._tabSize!==8&&(this._customTabSize=this._tabSize),t||(this.redrawLines(),this._resetLineWidth())},_setThemeClass:function(e,t){this._themeClass=e;var n="textviewContainer";this._themeClass&&(n+=" "+this._themeClass),this._rootDiv.className=n,this._updateStyle(t)},_setWrapMode:function(e,t){this._wrapMode=e;var n=this._clientDiv,r=this._viewDiv;e?(n.style.whiteSpace="pre-wrap",n.style.wordWrap="break-word",r.style.overflowX="hidden",r.style.overflowY="scroll"):(n.style.whiteSpace="pre",n.style.wordWrap="normal",r.style.overflowX="auto",r.style.overflowY="auto"),t||(this.redraw(),this._resetLineWidth()),this._resetLineHeight()},_showCaret:function(e,t){if(!this._clientDiv)return;var n=this._model,r=this._getSelection(),i=this._getScroll(),s=r.getCaret(),o=r.start,u=r.end,a=n.getLineAtOffset(u),f=Math.max(Math.max(o,n.getLineStart(a)),u-1),l=this._getClientWidth(),c=this._getClientHeight(),h=l/4,p=this._getBoundsAtOffset(s===o?o:f),d=p.left,v=p.right,m=p.top,g=p.bottom;e&&!r.isEmpty()&&(p=this._getBoundsAtOffset(s===u?o:f),p.top===m?s===o?v=d+Math.min(p.right-d,l):d=v-Math.min(v-p.left,l):s===o?g=m+Math.min(p.bottom-m,c):m=g-Math.min(g-p.top,c));var y=0;d<i.x&&(y=Math.min(d-i.x,-h)),v>i.x+l&&(y=Math.max(v-i.x-l,h));var b=0;return m<i.y?b=m-i.y:g>i.y+c&&(b=g-i.y-c),t&&(t>0?b>0&&(b=Math.max(b,t)):b<0&&(b=Math.min(b,t))),y!==0||b!==0?(this._scrollView(y,b),c!==this._getClientHeight()||l!==this._getClientWidth()?this._showCaret():this._ensureCaretVisible=!0,!0):!1},_startIME:function(){if(this._imeOffset!==-1)return;var e=this._getSelection();e.isEmpty()||this._modifyContent({text:"",start:e.start,end:e.end},!0),this._imeOffset=e.start},_unhookEvents:function(){this._model.removeEventListener("preChanging",this._modelListener.onChanging),this._model.removeEventListener("postChanged",this._modelListener.onChanged),this._modelListener=null;for(var e=0;e<this._handlers.length;e++){var t=this._handlers[e];o(t.target,t.type,t.handler)}this._handlers=null,this._mutationObserver&&(this._mutationObserver.disconnect(),this._mutationObserver=null)},_updateDOMSelection:function(){if(this._ignoreDOMSelection)return;if(!this._clientDiv)return;var e=this._getSelection(),t=this._model,n=t.getLineAtOffset(e.start),r=t.getLineAtOffset(e.end),i=this._getLineNext();if(!i)return;var s=this._getLinePrevious(),o,u,a,f;n<i.lineIndex?(o=i,a=0):n>s.lineIndex?(o=s,a=0):(o=this._getLineNode(n),a=e.start-t.getLineStart(n)),r<i.lineIndex?(u=i,f=0):r>s.lineIndex?(u=s,f=0):(u=this._getLineNode(r),f=e.end-t.getLineStart(r)),this._setDOMSelection(o,a,u,f)},_update:function(e){if(this._redrawCount>0)return;if(this._updateTimer){var t=this._getWindow();t.clearTimeout(this._updateTimer),this._updateTimer=null,e=!1}var n=this._clientDiv;if(!n)return;this._metrics.invalid&&(this._ignoreQueueUpdate=!0,this._updateStyle(),this._ignoreQueueUpdate=!1);var i=this._model,s=this._getScroll(),o=this._getViewPadding(),u=i.getLineCount(),a=this._getLineHeight(),f=this._getClientWidth();this._wrapMode&&(n.style.width=f+"px");var l,c,h,p,d,v,g,y,b,w=0,E=0,S;if(this._lineHeight){while(E<u){S=this._getLineHeight(E);if(w+S>s.y)break;w+=S,E++}l=E,c=Math.max(0,l-1),p=h=s.y-w,l>0&&(h+=this._getLineHeight(l-1))}else{var x=Math.max(0,s.y)/a;l=Math.floor(x),c=Math.max(0,l-1),h=Math.round((x-c)*a),p=Math.round((x-l)*a),b=u*a}this._topIndexY=p;var T=this._parent,N=T.clientWidth,C=T.clientHeight;g=this._getClientHeight();if(e){d=0,this._leftDiv&&(v=this._leftDiv.getBoundingClientRect(),d=v.right-v.left),y=f,this._wrapMode||(y=Math.max(this._maxLineWidth,y));while(E<u)S=this._getLineHeight(E,!1),w+=S,E++;b=w}else{var k=this._viewDiv,L=Math.floor((g+p)/a),A=Math.min(l+L,u-1),O=Math.min(A+1,u-1),M,_,D=n.firstChild;while(D){M=D.lineIndex;var P=D.nextSibling;if(!(c<=M&&M<=O)||D.lineRemoved||D.lineIndex===-1)this._mouseWheelLine===D?(D.style.display="none",D.lineIndex=-1):n.removeChild(D);D=P}D=this._getLineNext();var H=k.ownerDocument,B=H.createDocumentFragment();for(M=c;M<=O;M++)!D||D.lineIndex>M?(new m(this,M)).create(B,null):(B.firstChild&&(n.insertBefore(B,D),B=H.createDocumentFragment()),D&&D.lineChanged&&(D=(new m(this,M)).create(B,D),D.lineChanged=!1),D=this._getLineNext(D));B.firstChild&&n.insertBefore(B,D),r.isWebkit&&!this._wrapMode&&(n.style.width="0x7fffffffpx");var j;D=this._getLineNext();var F=g+h,I=!1;while(D)_=D.lineWidth,_===undefined&&(j=D._line.getBoundingClientRect(),_=D.lineWidth=Math.ceil(j.right-j.left),this._lineHeight&&(this._lineHeight[D.lineIndex]=Math.ceil(j.bottom-j.top))),this._lineHeight&&!I&&(F-=this._lineHeight[D.lineIndex],F<0&&(A=D.lineIndex,I=!0)),this._wrapMode||(_>=this._maxLineWidth&&(this._maxLineWidth=_,this._maxLineIndex=D.lineIndex),this._checkMaxLineIndex===D.lineIndex&&(this._checkMaxLineIndex=-1)),D.lineIndex===l&&(this._topChild=D),D.lineIndex===A&&(this._bottomChild=D),D=this._getLineNext(D);if(this._checkMaxLineIndex!==-1){M=this._checkMaxLineIndex,this._checkMaxLineIndex=-1;if(0<=M&&M<u){var q=new m(this,M);j=q.getBoundingClientRect(),_=j.right-j.left,_>=this._maxLineWidth&&(this._maxLineWidth=_,this._maxLineIndex=M),q.destroy()}}while(E<u)S=this._getLineHeight(E,E<=A),w+=S,E++;b=w,this._updateRuler(this._leftDiv,l,A),this._updateRuler(this._rightDiv,l,A),d=0,this._leftDiv&&(v=this._leftDiv.getBoundingClientRect(),d=v.right-v.left);var R=0;if(this._rightDiv){var U=this._rightDiv.getBoundingClientRect();R=U.right-U.left}k.style.left=d+"px",k.style.right=R+"px";var z=this._scrollDiv;z.style.height=b+"px",f=this._getClientWidth();var W=f;this._wrapMode||(W=Math.max(this._maxLineWidth,W)),y=W,(!r.isIE||r.isIE>=9)&&this._maxLineWidth>f&&(W+=o.right+o.left),z.style.width=W+"px",this._clipScrollDiv&&(this._clipScrollDiv.style.width=W+"px"),s=this._getScroll();var X=g+o.top+o.bottom;this._updateRulerSize(this._leftDiv,X),this._updateRulerSize(this._rightDiv,X)}if(this._vScrollDiv){var V=g-8,$=Math.max(15,Math.ceil(Math.min(1,V/(b+o.top+o.bottom))*V));this._vScrollDiv.style.left=d+f-8+"px",this._vScrollDiv.style.top=Math.floor(Math.max(0,s.y*V/b))+"px",this._vScrollDiv.style.height=$+"px"}if(!this._wrapMode&&this._hScrollDiv){var J=f-8,K=Math.max(15,Math.ceil(Math.min(1,J/(this._maxLineWidth+o.left+o.right))*J));this._hScrollDiv.style.left=d+Math.floor(Math.max(0,Math.floor(s.x*J/this._maxLineWidth)))+"px",this._hScrollDiv.style.top=g-9+"px",this._hScrollDiv.style.width=K+"px"}var Q=s.x,G=this._clipDiv,Y=this._overlayDiv,Z,et;if(G){G.scrollLeft=Q,Z=d+o.left,et=o.top;var tt=f,nt=g,rt=0,it=-h;s.x===0&&(Z-=o.left,tt+=o.left,rt=o.left),s.x+f===y&&(tt+=o.right),s.y===0&&(et-=o.top,nt+=o.top,it+=o.top),s.y+g===b&&(nt+=o.bottom),G.style.left=Z+"px",G.style.top=et+"px",G.style.right=N-tt-Z+"px",G.style.bottom=C-nt-et+"px",n.style.left=rt+"px",n.style.top=it+"px",n.style.width=y+"px",n.style.height=g+h+"px",Y&&(Y.style.left=n.style.left,Y.style.top=n.style.top,Y.style.width=n.style.width,Y.style.height=n.style.height)}else{Z=Q,et=h;var st=Q+f,ot=h+g;Z===0&&(Z-=o.left),et===0&&(et-=o.top),st===y&&(st+=o.right),s.y+g===b&&(ot+=o.bottom),n.style.clip="rect("+et+"px,"+st+"px,"+ot+"px,"+Z+"px)",n.style.left=-Q+d+o.left+"px",n.style.width=(r.isWebkit?y:f+Q)+"px",e||(n.style.top=-h+o.top+"px",n.style.height=g+h+"px"),Y&&(Y.style.clip=n.style.clip,Y.style.left=n.style.left,Y.style.width=n.style.width,e||(Y.style.top=n.style.top,Y.style.height=n.style.height))}this._updateDOMSelection();var ut=this._ensureCaretVisible;this._ensureCaretVisible=!1,g!==this._getClientHeight()&&(this._update(),ut&&this._showCaret())},_updateRulerSize:function(e,t){if(!e)return;var n=this._topIndexY,r=this._getLineHeight(),i=e.firstChild.rows[0].cells;for(var s=0;s<i.length;s++){var o=i[s].firstChild,u=r;o._ruler.getOverview()==="page"&&(u+=n),o.style.top=-u+"px",o.style.height=t+u+"px",o=o.nextSibling}e.style.height=t+"px"},_updateRuler:function(e,t,n){if(!e)return;var i=e.firstChild.rows[0].cells,s=this._parent.ownerDocument,o=this._getLineHeight(),a=this._getViewPadding();for(var f=0;f<i.length;f++){var l=i[f].firstChild,c=l._ruler;l.rulerChanged&&u(c.getRulerStyle(),l);var h,p=l.firstChild;p?(h=p,p=p.nextSibling):(h=r.createElement(s,"div"),h.style.visibility="hidden",l.appendChild(h));var d,v;l.rulerChanged&&h&&(d=-1,v=c.getWidestAnnotation(),v&&(u(v.style,h),v.html&&(h.innerHTML=v.html)),h.lineIndex=d,h.style.height=o+a.top+"px");var m=c.getOverview(),g,y,b;if(m==="page"){b=c.getAnnotations(t,n+1);while(p){d=p.lineIndex;var w=p.nextSibling;(!(t<=d&&d<=n)||p.lineChanged)&&l.removeChild(p),p=w}p=l.firstChild.nextSibling,y=s.createDocumentFragment();for(d=t;d<=n;d++)!p||p.lineIndex>d?(g=r.createElement(s,"div"),v=b[d],v&&(u(v.style,g),v.html&&(g.innerHTML=v.html),g.annotation=v),g.lineIndex=d,g.style.height=this._getLineHeight(d)+"px",y.appendChild(g)):(y.firstChild&&(l.insertBefore(y,p),y=s.createDocumentFragment()),p&&(p=p.nextSibling));y.firstChild&&l.insertBefore(y,p)}else{var E=this._getClientHeight(),S=this._model.getLineCount(),x=o*S,T=E+a.top+a.bottom-2*this._metrics.scrollWidth,N;x<T?N=o:N=T/S;if(l.rulerChanged){var C=l.childNodes.length;while(C>1)l.removeChild(l.lastChild),C--;b=c.getAnnotations(0,S),y=s.createDocumentFragment();for(var k in b){d=k>>>0;if(d<0)continue;g=r.createElement(s,"div"),v=b[k],u(v.style,g),g.style.position="absolute",g.style.top=this._metrics.scrollWidth+o+Math.floor(d*N)+"px",v.html&&(g.innerHTML=v.html),g.annotation=v,g.lineIndex=d,y.appendChild(g)}l.appendChild(y)}else if(l._oldTrackHeight!==T){g=l.firstChild?l.firstChild.nextSibling:null;while(g)g.style.top=this._metrics.scrollWidth+o+Math.floor(g.lineIndex*N)+"px",g=g.nextSibling}l._oldTrackHeight=T}l.rulerChanged=!1,l=l.nextSibling}},_updateStyle:function(e){!e&&r.isIE&&(this._rootDiv.style.lineHeight="normal");var t=this._metrics=this._calculateMetrics();r.isIE?this._rootDiv.style.lineHeight=t.lineHeight-(t.lineTrim.top+t.lineTrim.bottom)+"px":this._rootDiv.style.lineHeight="normal",e||(this.redraw(),this._resetLineWidth())}},n.EventTarget.addMixin(g.prototype),{TextView:g}}),define("orion/editor/projectionTextModel",["orion/editor/textModel","orion/editor/eventTarget"],function(e,t){function n(e){this._model=e,this._projections=[]}return n.prototype={addProjection:function(t){if(!t)return;var n=this._model,r=this._projections;t._lineIndex=n.getLineAtOffset(t.start),t._lineCount=n.getLineAtOffset(t.end)-t._lineIndex;var i=t.text;i||(i=""),typeof i=="string"?t._model=new e.TextModel(i,n.getLineDelimiter()):t._model=i;var s=this.mapOffset(t.start,!0),o=t.end-t.start,u=t._lineCount,a=t._model.getCharCount(),f=t._model.getLineCount()-1,l={type:"Changing",text:t._model.getText(),start:s,removedCharCount:o,addedCharCount:a,removedLineCount:u,addedLineCount:f};this.onChanging(l);var c=this._binarySearch(r,t.start);r.splice(c,0,t);var h={type:"Changed",start:s,removedCharCount:o,addedCharCount:a,removedLineCount:u,addedLineCount:f};this.onChanged(h)},getProjections:function(){return this._projections.slice(0)},getBaseModel:function(){return this._model},mapOffset:function(e,t){var n=this._projections,r=0,i,s;if(t){for(i=0;i<n.length;i++){s=n[i];if(s.start>e)break;if(s.end>e)return-1;r+=s._model.getCharCount()-(s.end-s.start)}return e+r}for(i=0;i<n.length;i++){s=n[i];if(s.start>e-r)break;var o=s._model.getCharCount();if(s.start+o>e-r)return-1;r+=o-(s.end-s.start)}return e-r},removeProjection:function(e){var t,n=0;for(t=0;t<this._projections.length;t++){var r=this._projections[t];if(r===e){e=r;break}n+=r._model.getCharCount()-(r.end-r.start)}if(t<this._projections.length){var i=this._model,s=e.start+n,o=e.end-e.start,u=e._lineCount,a=e._model.getCharCount(),f=e._model.getLineCount()-1,l={type:"Changing",text:i.getText(e.start,e.end),start:s,removedCharCount:a,addedCharCount:o,removedLineCount:f,addedLineCount:u};this.onChanging(l),this._projections.splice(t,1);var c={type:"Changed",start:s,removedCharCount:a,addedCharCount:o,removedLineCount:f,addedLineCount:u};this.onChanged(c)}},_binarySearch:function(e,t){var n=e.length,r=-1,i;while(n-r>1)i=Math.floor((n+r)/2),t<=e[i].start?n=i:r=i;return n},getCharCount:function(){var e=this._model.getCharCount(),t=this._projections;for(var n=0;n<t.length;n++){var r=t[n];e+=r._model.getCharCount()-(r.end-r.start)}return e},getLine:function(e,t){if(e<0)return null;var n=this._model,r=this._projections,i=0,s=[],o=0,u,a,f;for(u=0;u<r.length;u++){f=r[u];if(f._lineIndex>=e-i)break;a=f._model.getLineCount()-1;if(f._lineIndex+a>=e-i){var l=e-(f._lineIndex+i);if(l<a)return f._model.getLine(l,t);s.push(f._model.getLine(a))}o=f.end,i+=a-f._lineCount}o=Math.max(o,n.getLineStart(e-i));for(;u<r.length;u++){f=r[u];if(f._lineIndex>e-i)break;s.push(n.getText(o,f.start)),a=f._model.getLineCount()-1;if(f._lineIndex+a>e-i)return s.push(f._model.getLine(0,t)),s.join("");s.push(f._model.getText()),o=f.end,i+=a-f._lineCount}var c=n.getLineEnd(e-i,t);return o<c&&s.push(n.getText(o,c)),s.join("")},getLineAtOffset:function(e){var t=this._model,n=this._projections,r=0,i=0;for(var s=0;s<n.length;s++){var o=n[s];if(o.start>e-r)break;var u=o._model.getCharCount();if(o.start+u>e-r){var a=e-(o.start+r);i+=o._model.getLineAtOffset(a),r+=a;break}i+=o._model.getLineCount()-1-o._lineCount,r+=u-(o.end-o.start)}return t.getLineAtOffset(e-r)+i},getLineCount:function(){var e=this._model,t=this._projections,n=e.getLineCount();for(var r=0;r<t.length;r++){var i=t[r];n+=i._model.getLineCount()-1-i._lineCount}return n},getLineDelimiter:function(){return this._model.getLineDelimiter()},getLineEnd:function(e,t){if(e<0)return-1;var n=this._model,r=this._projections,i=0,s=0;for(var o=0;o<r.length;o++){var u=r[o];if(u._lineIndex>e-i)break;var a=u._model.getLineCount()-1;if(u._lineIndex+a>e-i){var f=e-(u._lineIndex+i);return u._model.getLineEnd(f,t)+u.start+s}s+=u._model.getCharCount()-(u.end-u.start),i+=a-u._lineCount}return n.getLineEnd(e-i,t)+s},getLineStart:function(e){if(e<0)return-1;var t=this._model,n=this._projections,r=0,i=0;for(var s=0;s<n.length;s++){var o=n[s];if(o._lineIndex>=e-r)break;var u=o._model.getLineCount()-1;if(o._lineIndex+u>=e-r){var a=e-(o._lineIndex+r);return o._model.getLineStart(a)+o.start+i}i+=o._model.getCharCount()-(o.end-o.start),r+=u-o._lineCount}return t.getLineStart(e-r)+i},getText:function(e,t){e===undefined&&(e=0);var n=this._model,r=this._projections,i=0,s=[],o,u,a;for(o=0;o<r.length;o++){u=r[o];if(u.start>e-i)break;a=u._model.getCharCount();if(u.start+a>e-i){if(t!==undefined&&u.start+a>t-i)return u._model.getText(e-(u.start+i),t-(u.start+i));s.push(u._model.getText(e-(u.start+i))),e=u.end+i+a-(u.end-u.start)}i+=a-(u.end-u.start)}var f=e-i;if(t!==undefined){for(;o<r.length;o++){u=r[o];if(u.start>t-i)break;s.push(n.getText(f,u.start)),a=u._model.getCharCount();if(u.start+a>t-i)return s.push(u._model.getText(0,t-(u.start+i))),s.join("");s.push(u._model.getText()),f=u.end,i+=a-(u.end-u.start)}s.push(n.getText(f,t-i))}else{for(;o<r.length;o++)u=r[o],s.push(n.getText(f,u.start)),s.push(u._model.getText()),f=u.end;s.push(n.getText(f))}return s.join("")},_onChanging:function(e,t,n,r,i,s){var o=this._model,u=this._projections,a,f,l=0,c,h=t+n;for(;a<u.length;a++){f=u[a];if(f.start>t)break;l+=f._model.getCharCount()-(f.end-f.start)}var p=t+l,d=a;for(;a<u.length;a++){f=u[a];if(f.start>h)break;l+=f._model.getCharCount()-(f.end-f.start),c+=f._model.getLineCount()-1-f._lineCount}var v=h+l,m=a;this.onChanging(p,v-p,r,i+c,s),u.splice(u,m-d);var g=e.length-(v-p);for(;a<u.length;a++)f=u[a],f.start+=g,f.end+=g,f._lineIndex=o.getLineAtOffset(f.start)},onChanging:function(e){return this.dispatchEvent(e)},onChanged:function(e){return this.dispatchEvent(e)},setLineDelimiter:function(e){this._model.setLineDelimiter(e)},setText:function(e,t,n){e===undefined&&(e=""),t===undefined&&(t=0);var r=t,i=n,s=this._model,o=this._projections,u=0,a=0,f,l,c,h,p,d=0;for(f=0;f<o.length;f++){l=o[f];if(l.start>t-u)break;c=l._model.getCharCount();if(l.start+c>t-u){if(n!==undefined&&l.start+c>n-u){l._model.setText(e,t-(l.start+u),n-(l.start+u));return}d=l._model.getLineCount()-1-l._model.getLineAtOffset(t-(l.start+u)),h={projection:l,start:t-(l.start+u)},t=l.end+u+c-(l.end-l.start)}a+=l._model.getLineCount()-1-l._lineCount,u+=c-(l.end-l.start)}var v=t-u,m=f,g=s.getLineAtOffset(v)+a-d;if(n!==undefined)for(;f<o.length;f++){l=o[f];if(l.start>n-u)break;c=l._model.getCharCount();if(l.start+c>n-u){a+=l._model.getLineAtOffset(n-(l.start+u)),c=n-(l.start+u),n=l.end+u,p={projection:l,end:c};break}a+=l._model.getLineCount()-1-l._lineCount,u+=c-(l.end-l.start)}else{for(;f<o.length;f++)l=o[f],a+=l._model.getLineCount()-1-l._lineCount,u+=l._model.getCharCount()-(l.end-l.start);n=i=s.getCharCount()+u}var y=n-u,b=f,w=s.getLineAtOffset(y)+a,E=i-r,S=w-g,x=e.length,T=0,N=0,C=0,k=0;for(;;){N!==-1&&N<=k&&(N=e.indexOf("\r",k)),C!==-1&&C<=k&&(C=e.indexOf("\n",k));if(C===-1&&N===-1)break;N!==-1&&C!==-1?N+1===C?k=C+1:k=(N<C?N:C)+1:N!==-1?k=N+1:k=C+1,T++}var L={type:"Changing",text:e,start:r,removedCharCount:E,addedCharCount:x,removedLineCount:S,addedLineCount:T};this.onChanging(L),s.setText(e,v,y),h&&(l=h.projection,l._model.setText("",h.start)),p&&(l=p.projection,l._model.setText("",0,p.end),l.start=l.end,l._lineCount=0),o.splice(m,b-m);var A=e.length-(y-v);for(f=b;f<o.length;f++)l=o[f],l.start+=A,l.end+=A,l._lineIndex=s.getLineAtOffset(l.start);var O={type:"Changed",start:r,removedCharCount:E,addedCharCount:x,removedLineCount:S,addedLineCount:T};this.onChanged(O)}},t.EventTarget.addMixin(n.prototype),{ProjectionTextModel:n}}),function(){function n(e,t,n,r,i,s){t[e]&&(n.push(e),(t[e]===!0||t[e]===1)&&r.push(i+e+"/"+s))}function r(e,t,n,r,i){var s=r+t+"/"+i;require._fileExists(e.toUrl(s))&&n.push(s)}function i(e,n,r){for(var i in n)!(i in t)&&(!(i in e)||r)&&(e[i]=n[i])}var e=/(^.*(^|\/)nls(\/|$))([^\/]*)\/?([^\/]*)/,t={};define("i18n",{version:"1.0.0",load:function(t,s,o,u){u=u||{};var a,f=e.exec(t),l=f[1],c=f[4],h=f[5],p=c.split("-"),d=[],v={},m,g,y="";f[5]?(l=f[1],a=l+h):(a=t,h=f[4],c=u.locale||(u.locale=typeof navigator=="undefined"?"root":(navigator.language||navigator.userLanguage||"root").toLowerCase()),p=c.split("-"));if(u.isBuild){d.push(a),r(s,"root",d,l,h);for(m=0;g=p[m];m++)y+=(y?"-":"")+g,r(s,y,d,l,h);s(d,function(){o()})}else s([a],function(e){var t=[];n("root",e,t,d,l,h);for(m=0;g=p[m];m++)y+=(y?"-":"")+g,n(y,e,t,d,l,h);s(d,function(){var n,r;for(n=t.length-1;n>-1&&(g=t[n]);n--){r=e[g];if(r===!0||r===1)r=s(l+g+"/"+h);i(v,r)}o(v)})})}})}(),define("orion/editor/i18n",{load:function(e,t,n,r){t.specified&&t.specified("orion/bootstrap")?t(["orion/i18n!"+e],function(e){n(e)}):n({})}}),define("orion/editor/nls/root/messages",{multipleAnnotations:"Multiple annotations:",line:"Line: ${0}",breakpoint:"Breakpoint",bookmark:"Bookmark",task:"Task",error:"Error",warning:"Warning",matchingSearch:"Matching Search",currentSearch:"Current Search",currentLine:"Current Line",matchingBracket:"Matching Bracket",currentBracket:"Current Bracket",Comment:"Comment","Flat outline":"Flat outline",incrementalFind:"Incremental find: ${0}",incrementalFindNotFound:"Incremental find: ${0} (not found)",find:"Find...",undo:"Undo",redo:"Redo",cancelMode:"Cancel Current Mode",findNext:"Find Next Occurrence",findPrevious:"Find Previous Occurrence",incrementalFindKey:"Incremental Find",indentLines:"Indent Lines",unindentLines:"Unindent Lines",moveLinesUp:"Move Lines Up",moveLinesDown:"Move Lines Down",copyLinesUp:"Copy Lines Up",copyLinesDown:"Copy Lines Down",deleteLines:"Delete Lines",gotoLine:"Goto Line...",gotoLinePrompty:"Goto Line:",nextAnnotation:"Next Annotation",prevAnnotation:"Previous Annotation",expand:"Expand",collapse:"Collapse",expandAll:"Expand All",collapseAll:"Collapse All",lastEdit:"Last Edit Location",toggleLineComment:"Toggle Line Comment",addBlockComment:"Add Block Comment",removeBlockComment:"Remove Block Comment",linkedModeEntered:"Linked Mode entered",linkedModeExited:"Linked Mode exited",syntaxError:"Syntax Error",contentAssist:"Content Assist",lineColumn:"Line ${0} : Col ${1}"}),define("orion/editor/nls/messages",["orion/editor/i18n!orion/editor/nls/messages","orion/editor/nls/root/messages"],function(e,t){var n={root:t};return Object.keys(e).forEach(function(t){typeof n[t]=="undefined"&&(n[t]=e[t])}),n}),define("orion/editor/annotations",["i18n!orion/editor/nls/messages","orion/editor/eventTarget"],function(e,t){function n(e,t,n){this.start=e,this.end=t,this._projectionModel=n,this.html=this._expandedHTML,this.style=this._expandedStyle,this.expanded=!0}function r(){}function s(t,n){var i=t.lastIndexOf("."),s=t.substring(i+1),o={title:e[s],style:{styleClass:"annotation "+s},html:"<div class='annotationHTML "+s+"'></div>",overviewStyle:{styleClass:"annotationOverview "+s}};n?o.lineStyle={styleClass:"annotationLine "+s}:o.rangeStyle={styleClass:"annotationRange "+s},r.registerType(t,o)}function o(){}function u(e){this._annotations=[];var t=this;this._listener={onChanged:function(e){t._onChanged(e)}},this.setTextModel(e)}function a(e,t){this._view=e,this._annotationModel=t;var n=this;this._listener={onDestroy:function(e){n._onDestroy(e)},onLineStyle:function(e){n._onLineStyle(e)},onChanged:function(e){n._onAnnotationModelChanged(e)}},e.addEventListener("Destroy",this._listener.onDestroy),e.addEventListener("postLineStyle",this._listener.onLineStyle),t.addEventListener("Changed",this._listener.onChanged)}n.prototype={_expandedHTML:"<div class='annotationHTML expanded'></div>",_expandedStyle:{styleClass:"annotation expanded"},_collapsedHTML:"<div class='annotationHTML collapsed'></div>",_collapsedStyle:{styleClass:"annotation collapsed"},collapse:function(){if(!this.expanded)return;this.expanded=!1,this.html=this._collapsedHTML,this.style=this._collapsedStyle;var e=this._projectionModel,t=e.getBaseModel();this._projection={start:t.getLineStart(t.getLineAtOffset(this.start)+1),end:t.getLineEnd(t.getLineAtOffset(this.end),!0)},e.addProjection(this._projection)},expand:function(){if(this.expanded)return;this.expanded=!0,this.html=this._expandedHTML,this.style=this._expandedStyle,this._projectionModel.removeProjection(this._projection)}},r.ANNOTATION_ERROR="orion.annotation.error",r.ANNOTATION_WARNING="orion.annotation.warning",r.ANNOTATION_TASK="orion.annotation.task",r.ANNOTATION_BREAKPOINT="orion.annotation.breakpoint",r.ANNOTATION_BOOKMARK="orion.annotation.bookmark",r.ANNOTATION_FOLDING="orion.annotation.folding",r.ANNOTATION_CURRENT_BRACKET="orion.annotation.currentBracket",r.ANNOTATION_MATCHING_BRACKET="orion.annotation.matchingBracket",r.ANNOTATION_CURRENT_LINE="orion.annotation.currentLine",r.ANNOTATION_CURRENT_SEARCH="orion.annotation.currentSearch",r.ANNOTATION_MATCHING_SEARCH="orion.annotation.matchingSearch",r.ANNOTATION_READ_OCCURRENCE="orion.annotation.readOccurrence",r.ANNOTATION_WRITE_OCCURRENCE="orion.annotation.writeOccurrence";var i={};return r.registerType=function(e,t){var n=t;return typeof n!="function"&&(n=function(e,t,n){this.start=e,this.end=t,n&&(this.title=n)},n.prototype=t),n.prototype.type=e,i[e]=n,e},r.createAnnotation=function(e,t,n,r){return new(this.getType(e))(t,n,r)},r.getType=function(e){return i[e]},s(r.ANNOTATION_ERROR),s(r.ANNOTATION_WARNING),s(r.ANNOTATION_TASK),s(r.ANNOTATION_BREAKPOINT),s(r.ANNOTATION_BOOKMARK),s(r.ANNOTATION_CURRENT_BRACKET),s(r.ANNOTATION_MATCHING_BRACKET),s(r.ANNOTATION_CURRENT_SEARCH),s(r.ANNOTATION_MATCHING_SEARCH),s(r.ANNOTATION_READ_OCCURRENCE),s(r.ANNOTATION_WRITE_OCCURRENCE),s(r.ANNOTATION_CURRENT_LINE,!0),r.registerType(r.ANNOTATION_FOLDING,n),o.addMixin=function(e){var t=o.prototype;for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},o.prototype={addAnnotationType:function(e){this._annotationTypes||(this._annotationTypes=[]),this._annotationTypes.push(e)},getAnnotationTypePriority:function(e){if(this._annotationTypes)for(var t=0;t<this._annotationTypes.length;t++)if(this._annotationTypes[t]===e)return t+1;return 0},getAnnotationsByType:function(e,t,n){var r=e.getAnnotations(t,n),i,s=[];while(r.hasNext()){i=r.next();var o=this.getAnnotationTypePriority(i.type);if(o===0)continue;s.push(i)}var u=this;return s.sort(function(e,t){return u.getAnnotationTypePriority(e.type)-u.getAnnotationTypePriority(t.type)}),s},isAnnotationTypeVisible:function(e){return this.getAnnotationTypePriority(e)!==0},removeAnnotationType:function(e){if(!this._annotationTypes)return;for(var t=0;t<this._annotationTypes.length;t++)if(this._annotationTypes[t]===e){this._annotationTypes.splice(t,1);break}}},u.prototype={addAnnotation:function(e){if(!e)return;var t=this._annotations,n=this._binarySearch(t,e.start);t.splice(n,0,e);var r={type:"Changed",added:[e],removed:[],changed:[]};this.onChanged(r)},getTextModel:function(){return this._model},getAnnotations:function(e,t){var n=this._annotations,r,i=0,s=function(){while(i<n.length){var r=n[i++];if(e===r.start||(e>r.start?e<r.end:r.start<t))return r;if(r.start>=t)break}return null};return r=s(),{next:function(){var e=r;return e&&(r=s()),e},hasNext:function(){return r!==null}}},modifyAnnotation:function(e){if(!e)return;var t=this._getAnnotationIndex(e);if(t<0)return;var n={type:"Changed",added:[],removed:[],changed:[e]};this.onChanged(n)},onChanged:function(e){return this.dispatchEvent(e)},removeAnnotations:function(e){var t=this._annotations,n,r;if(e){n=[];for(r=t.length-1;r>=0;r--){var i=t[r];i.type===e&&t.splice(r,1),n.splice(0,0,i)}}else n=t,t=[];var s={type:"Changed",removed:n,added:[],changed:[]};this.onChanged(s)},removeAnnotation:function(e){if(!e)return;var t=this._getAnnotationIndex(e);if(t<0)return;var n={type:"Changed",removed:this._annotations.splice(t,1),added:[],changed:[]};this.onChanged(n)},replaceAnnotations:function(e,t){var n=this._annotations,r,i,s,o=[];if(e)for(r=e.length-1;r>=0;r--){s=e[r],i=this._getAnnotationIndex(s);if(i<0)continue;n.splice(i,1),o.splice(0,0,s)}t||(t=[]);for(r=0;r<t.length;r++)s=t[r],i=this._binarySearch(n,s.start),n.splice(i,0,s);var u={type:"Changed",removed:o,added:t,changed:[]};this.onChanged(u)},setTextModel:function(e){this._model&&this._model.removeEventListener("Changed",this._listener.onChanged),this._model=e,this._model&&this._model.addEventListener("Changed",this._listener.onChanged)},_binarySearch:function(e,t){var n=e.length,r=-1,i;while(n-r>1)i=Math.floor((n+r)/2),t<=e[i].start?n=i:r=i;return n},_getAnnotationIndex:function(e){var t=this._annotations,n=this._binarySearch(t,e.start);while(n<t.length&&t[n].start===e.start){if(t[n]===e)return n;n++}return-1},_onChanged:function(e){var t=e.start,n=e.addedCharCount,r=e.removedCharCount,i=this._annotations,s=t+r,o=0;if(!(0<=o&&o<i.length))return;var u={type:"Changed",added:[],removed:[],changed:[],textModelChangedEvent:e},a=n-r,f;for(f=o;f<i.length;f++){var l=i[f];l.start>=s?(l.start+=a,l.end+=a,u.changed.push(l)):l.end<=t||(l.start<t&&s<l.end?(l.end+=a,u.changed.push(l)):(i.splice(f,1),u.removed.push(l),f--))}(u.added.length>0||u.removed.length>0||u.changed.length>0)&&this.onChanged(u)}},t.EventTarget.addMixin(u.prototype),a.prototype={destroy:function(){var e=this._view;e&&(e.removeEventListener("Destroy",this._listener.onDestroy),e.removeEventListener("LineStyle",this._listener.onLineStyle),this.view=null);var t=this._annotationModel;t&&(t.removeEventListener("Changed",this._listener.onChanged),t=null)},_mergeStyle:function(e,t){if(t){e||(e={}),e.styleClass&&t.styleClass&&e.styleClass!==t.styleClass?e.styleClass+=" "+t.styleClass:e.styleClass=t.styleClass;var n;if(t.style){e.style||(e.style={});for(n in t.style)e.style[n]||(e.style[n]=t.style[n])}if(t.attributes){e.attributes||(e.attributes={});for(n in t.attributes)e.attributes[n]||(e.attributes[n]=t.attributes[n])}}return e},_mergeStyleRanges:function(e,t){e||(e=[]);var n,r;for(r=0;r<e.length&&t;r++){var i=e[r];if(t.end<=i.start)break;if(t.start>=i.end)continue;n=this._mergeStyle({},i.style),n=this._mergeStyle(n,t.style);var s=[];s.push(r,1),t.start<i.start&&s.push({start:t.start,end:i.start,style:t.style}),t.start>i.start&&s.push({start:i.start,end:t.start,style:i.style}),s.push({start:Math.max(i.start,t.start),end:Math.min(i.end,t.end),style:n}),t.end<i.end&&s.push({start:t.end,end:i.end,style:i.style}),t.end>i.end?t={start:i.end,end:t.end,style:t.style}:t=null,Array.prototype.splice.apply(e,s)}return t&&(n=this._mergeStyle({},t.style),e.splice(r,0,{start:t.start,end:t.end,style:n})),e},_onAnnotationModelChanged:function(e){function i(e){for(var i=0;i<e.length;i++){if(!n.isAnnotationTypeVisible(e[i].type))continue;var s=e[i].start,o=e[i].end;r.getBaseModel&&(s=r.mapOffset(s,!0),o=r.mapOffset(o,!0)),s!==-1&&o!==-1&&t.redrawRange(s,o)}}if(e.textModelChangedEvent)return;var t=this._view;if(!t)return;var n=this,r=t.getModel();i(e.added),i(e.removed),i(e.changed)},_onDestroy:function(e){this.destroy()},_onLineStyle:function(e){var t=this._annotationModel,n=e.textView.getModel(),r=t.getTextModel(),i=e.lineStart,s=e.lineStart+e.lineText.length;r!==n&&(i=n.mapOffset(i),s=n.mapOffset(s));var o=t.getAnnotations(i,s);while(o.hasNext()){var u=o.next();if(!this.isAnnotationTypeVisible(u.type))continue;if(u.rangeStyle){var a=u.start,f=u.end;r!==n&&(a=n.mapOffset(a,!0),f=n.mapOffset(f,!0)),e.ranges=this._mergeStyleRanges(e.ranges,{start:a,end:f,style:u.rangeStyle})}u.lineStyle&&(e.style=this._mergeStyle({},e.style),e.style=this._mergeStyle(e.style,u.lineStyle))}}},o.addMixin(a.prototype),{FoldingAnnotation:n,AnnotationType:r,AnnotationTypeList:o,AnnotationModel:u,AnnotationStyler:a}}),define("orion/editor/tooltip",["i18n!orion/editor/nls/messages","orion/editor/textView","orion/editor/textModel","orion/editor/projectionTextModel","orion/editor/util"],function(e,t,n,r,i){function s(e){this._view=e,this._create(e.getOptions("parent").ownerDocument),e.addEventListener("Destroy",this,this.destroy)}return s.getTooltip=function(e){return e._tooltip||(e._tooltip=new s(e)),e._tooltip},s.prototype={_create:function(e){if(this._tooltipDiv)return;var t=this._tooltipDiv=i.createElement(e,"div");t.className="textviewTooltip",t.setAttribute("aria-live","assertive"),t.setAttribute("aria-atomic","true");var n=this._tooltipContents=i.createElement(e,"div");t.appendChild(n),e.body.appendChild(t),this.hide()},_getWindow:function(){var e=this._tooltipDiv.ownerDocument;return e.defaultView||e.parentWindow},destroy:function(){if(!this._tooltipDiv)return;this.hide();var e=this._tooltipDiv.parentNode;e&&e.removeChild(this._tooltipDiv),this._tooltipDiv=null},hide:function(){this._contentsView&&(this._contentsView.destroy(),this._contentsView=null),this._tooltipContents&&(this._tooltipContents.innerHTML=""),this._tooltipDiv&&(this._tooltipDiv.style.visibility="hidden");var e=this._getWindow();this._showTimeout&&(e.clearTimeout(this._showTimeout),this._showTimeout=null),this._hideTimeout&&(e.clearTimeout(this._hideTimeout),this._hideTimeout=null),this._fadeTimeout&&(e.clearInterval(this._fadeTimeout),this._fadeTimeout=null)},isVisible:function(){return this._tooltipDiv&&this._tooltipDiv.style.visibility==="visible"},setTarget:function(e,t){if(this.target===e)return;this._target=e,this.hide();if(e){var n=this;if(t===0)n.show(!0);else{var r=this._getWindow();n._showTimeout=r.setTimeout(function(){n.show(!0)},t?t:500)}}},show:function(e){if(!this._target)return;var n=this._target.getTooltipInfo();if(!n)return;var i=this._tooltipDiv,s=this._tooltipContents;i.style.left=i.style.right=i.style.width=i.style.height=s.style.width=s.style.height="auto";var o=n.contents;o instanceof Array&&(o=this._getAnnotationContents(o));if(typeof o=="string")s.innerHTML=o;else if(this._isNode(o))s.appendChild(o);else{if(!(o instanceof r.ProjectionTextModel))return;var u=this._view,a=u.getOptions();a.wrapMode=!1,a.parent=s;var f="tooltip",l=a.themeClass;l?(l=l.replace(f,""),l&&(l=" "+l),l=f+l):l=f,a.themeClass=l;var c=this._contentsView=new t.TextView(a);c._clientDiv.contentEditable=!1;var h={onLineStyle:function(e){u.onLineStyle(e)}};c.addEventListener("LineStyle",h.onLineStyle),c.setModel(o);var p=c.computeSize();s.style.width=p.width+20+"px",s.style.height=p.height+"px",c.resize()}var d=i.ownerDocument.documentElement;if(n.anchor==="right"){var v=d.clientWidth-n.x;i.style.right=v+"px",i.style.maxWidth=d.clientWidth-v-10+"px"}else{var m=parseInt(this._getNodeStyle(i,"padding-left","0"),10);m+=parseInt(this._getNodeStyle(i,"border-left-width","0"),10),m=n.x-m,i.style.left=m+"px",i.style.maxWidth=d.clientWidth-m-10+"px"}var g=parseInt(this._getNodeStyle(i,"padding-top","0"),10);g+=parseInt(this._getNodeStyle(i,"border-top-width","0"),10),g=n.y-g,i.style.top=g+"px",i.style.maxHeight=d.clientHeight-g-10+"px",i.style.opacity="1",i.style.visibility="visible";if(e){var y=this,b=this._getWindow();y._hideTimeout=b.setTimeout(function(){var e=parseFloat(y._getNodeStyle(i,"opacity","1"));y._fadeTimeout=b.setInterval(function(){if(i.style.visibility==="visible"&&e>0){e-=.1,i.style.opacity=e;return}y.hide()},50)},5e3)}},_getAnnotationContents:function(t){function o(e,t){var n=s.getLineStart(s.getLineAtOffset(e)),r=s.getLineEnd(s.getLineAtOffset(t),!0);return s.getText(n,r)}function u(e){var t=e.title;if(t==="")return null;var n="<div>";return e.html&&(n+=e.html+"&nbsp;"),t||(t=o(e.start,e.end)),t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;"),n+="<span style='vertical-align:middle;'>"+t+"</span><div>",n}if(t.length===0)return null;var n=this._view.getModel(),i,s=n.getBaseModel?n.getBaseModel():n;if(t.length===1){i=t[0];if(i.title!==undefined)return u(i);var a=new r.ProjectionTextModel(s),f=s.getLineStart(s.getLineAtOffset(i.start)),l=s.getCharCount();return i.end!==l&&a.addProjection({start:i.end,end:l}),f>0&&a.addProjection({start:0,end:f}),a}var c="<div><em>"+e.multipleAnnotations+"</em></div>";for(var h=0;h<t.length;h++){i=t[h];var p=u(i);p&&(c+=p)}return c},_getNodeStyle:function(e,t,n){var r;if(e){r=e.style[t];if(!r)if(e.currentStyle){var i=0,s=t;while((i=s.indexOf("-",i))!==-1)s=s.substring(0,i)+s.substring(i+1,i+2).toUpperCase()+s.substring(i+2);r=e.currentStyle[s]}else{var o=e.ownerDocument.defaultView.getComputedStyle(e,null);r=o?o.getPropertyValue(t):null}}return r||n},_isNode:function(e){return typeof Node=="object"?e instanceof Node:e&&typeof e=="object"&&typeof e.nodeType=="number"&&typeof e.nodeName=="string"}},{Tooltip:s}}),define("orion/editor/rulers",["i18n!orion/editor/nls/messages","orion/editor/annotations","orion/editor/tooltip","orion/editor/util"],function(e,t,n,r){function i(e,t,n,r){this._location=t||"left",this._overview=n||"page",this._rulerStyle=r,this._view=null;var i=this;this._listener={onTextModelChanged:function(e){i._onTextModelChanged(e)},onAnnotationModelChanged:function(e){i._onAnnotationModelChanged(e)}},this.setAnnotationModel(e)}function s(e,t,n,r,s){i.call(this,e,t,"page",n),this._oddStyle=r||{style:{backgroundColor:"white"}},this._evenStyle=s||{style:{backgroundColor:"white"}},this._numOfDigits=0}function o(e,t,n){i.call(this,e,t,"page",n)}function u(e,t,n){i.call(this,e,t,"document",n)}function a(e,t,n){o.call(this,e,t,n)}return i.prototype={getAnnotations:function(e,t){var n=this._annotationModel;if(!n)return[];var r=this._view.getModel(),i=r.getLineStart(e),s=r.getLineEnd(t-1),o=r;r.getBaseModel&&(o=r.getBaseModel(),i=r.mapOffset(i),s=r.mapOffset(s));var u=[],a=this.getAnnotationsByType(n,i,s);for(var f=0;f<a.length;f++){var l=a[f],c=o.getLineAtOffset(l.start),h=o.getLineAtOffset(Math.max(l.start,l.end-1));for(var p=c;p<=h;p++){var d=p;if(r!==o){var v=o.getLineStart(p);v=r.mapOffset(v,!0);if(v===-1)continue;d=r.getLineAtOffset(v)}if(!(e<=d&&d<t))continue;var m=this._mergeAnnotation(u[d],l,p-c,h-c+1);m&&(u[d]=m)}}if(!this._multiAnnotation&&this._multiAnnotationOverlay)for(var g in u)u[g]._multiple&&(u[g].html=u[g].html+this._multiAnnotationOverlay.html);return u},getAnnotationModel:function(){return this._annotationModel},getLocation:function(){return this._location},getOverview:function(){return this._overview},getRulerStyle:function(){return this._rulerStyle},getView:function(){return this._view},getWidestAnnotation:function(){return null},setAnnotationModel:function(e){this._annotationModel&&this._annotationModel.removEventListener("Changed",this._listener.onAnnotationModelChanged),this._annotationModel=e,this._annotationModel&&this._annotationModel.addEventListener("Changed",this._listener.onAnnotationModelChanged)},setMultiAnnotation:function(e){this._multiAnnotation=e},setMultiAnnotationOverlay:function(e){this._multiAnnotationOverlay=e},setView:function(e){this._onTextModelChanged&&this._view&&this._view.removeEventListener("ModelChanged",this._listener.onTextModelChanged),this._view=e,this._onTextModelChanged&&this._view&&this._view.addEventListener("ModelChanged",this._listener.onTextModelChanged)},onClick:function(e,t){},onDblClick:function(e,t){},onMouseMove:function(e,t){var r=n.Tooltip.getTooltip(this._view);if(!r)return;if(r.isVisible()&&this._tooltipLineIndex===e)return;this._tooltipLineIndex=e;var i=this;r.setTarget({y:t.clientY,getTooltipInfo:function(){return i._getTooltipInfo(i._tooltipLineIndex,this.y)}})},onMouseOver:function(e,t){this.onMouseMove(e,t)},onMouseOut:function(e,t){var r=n.Tooltip.getTooltip(this._view);if(!r)return;r.setTarget(null)},_getTooltipInfo:function(e,t){if(e===undefined)return;var n=this._view,r=n.getModel(),i=this._annotationModel,s=[];if(i){var o=r.getLineStart(e),u=r.getLineEnd(e);r.getBaseModel&&(o=r.mapOffset(o),u=r.mapOffset(u)),s=this.getAnnotationsByType(i,o,u)}var a=this._getTooltipContents(e,s);if(!a)return null;var f={contents:a,anchor:this.getLocation()},l=n.getClientArea();return this.getOverview()==="document"?l.y=n.convert({y:t},"view","document").y:l.y=n.getLocationAtOffset(r.getLineStart(e)).y,n.convert(l,"document","page"),f.x=l.x,f.y=l.y,f.anchor==="right"&&(f.x+=l.width),f},_getTooltipContents:function(e,t){return t},_onAnnotationModelChanged:function(e){function u(e){for(var i=0;i<e.length;i++){if(!r.isAnnotationTypeVisible(e[i].type))continue;var s=e[i].start,o=e[i].end;n.getBaseModel&&(s=n.mapOffset(s,!0),o=n.mapOffset(o,!0)),s!==-1&&o!==-1&&t.redrawLines(n.getLineAtOffset(s),n.getLineAtOffset(Math.max(s,o-1))+1,r)}}var t=this._view;if(!t)return;var n=t.getModel(),r=this,i=n.getLineCount();if(e.textModelChangedEvent){var s=e.textModelChangedEvent.start;n.getBaseModel&&(s=n.mapOffset(s,!0));var o=n.getLineAtOffset(s);t.redrawLines(o,i,r);return}u(e.added),u(e.removed),u(e.changed)},_mergeAnnotation:function(e,t,n,r){return e||(e={}),n===0&&(e.html&&t.html?(t.html!==e.html&&!e._multiple&&this._multiAnnotation&&(e.html=this._multiAnnotation.html),e._multiple=!0):e.html=t.html),e.style=this._mergeStyle(e.style,t.style),e},_mergeStyle:function(e,t){if(t){e||(e={}),e.styleClass&&t.styleClass&&e.styleClass!==t.styleClass?e.styleClass+=" "+t.styleClass:e.styleClass=t.styleClass;var n;if(t.style){e.style||(e.style={});for(n in t.style)e.style[n]||(e.style[n]=t.style[n])}if(t.attributes){e.attributes||(e.attributes={});for(n in t.attributes)e.attributes[n]||(e.attributes[n]=t.attributes[n])}}return e}},t.AnnotationTypeList.addMixin(i.prototype),s.prototype=new i,s.prototype.getAnnotations=function(e,t){var n=i.prototype.getAnnotations.call(this,e,t),r=this._view.getModel();for(var s=e;s<t;s++){var o=s&1?this._oddStyle:this._evenStyle,u=s;if(r.getBaseModel){var a=r.getLineStart(u);u=r.getBaseModel().getLineAtOffset(r.mapOffset(a))}n[s]||(n[s]={}),n[s].html=u+1+"",n[s].style||(n[s].style=o)}return n},s.prototype.getWidestAnnotation=function(){var e=this._view.getModel().getLineCount();return this.getAnnotations(e-1,e)[e-1]},s.prototype._onTextModelChanged=function(e){var t=e.start,n=this._view.getModel(),r=n.getBaseModel?n.getBaseModel().getLineCount():n.getLineCount(),i=(r+"").length;if(this._numOfDigits!==i){this._numOfDigits=i;var s=n.getLineAtOffset(t);this._view.redrawLines(s,n.getLineCount(),this)}},o.prototype=new i,u.prototype=new i,u.prototype.getRulerStyle=function(){var e={style:{lineHeight:"1px",fontSize:"1px"}};return e=this._mergeStyle(e,this._rulerStyle),e},u.prototype.onClick=function(e,t){if(e===undefined)return;this._view.setTopIndex(e)},u.prototype._getTooltipContents=function(t,n){if(n.length===0){var s=this._view.getModel(),o=t;if(s.getBaseModel){var u=s.getLineStart(o);o=s.getBaseModel().getLineAtOffset(s.mapOffset(u))}return r.formatMessage(e.line,o+1)}return i.prototype._getTooltipContents.call(this,t,n)},u.prototype._mergeAnnotation=function(e,t,n,r){if(n!==0)return undefined;var i=e;if(!i){var s=3*r;i={html:"&nbsp;",style:{style:{height:s+"px"}}},i.style=this._mergeStyle(i.style,t.overviewStyle)}return i},a.prototype=new o,a.prototype.onClick=function(e,t){if(e===undefined)return;var r=this._annotationModel;if(!r)return;var i=this._view,s=i.getModel(),o=s.getLineStart(e),u=s.getLineEnd(e,!0);s.getBaseModel&&(o=s.mapOffset(o),u=s.mapOffset(u),s=s.getBaseModel());var a,f=r.getAnnotations(o,u);while(!a&&f.hasNext()){var l=f.next();if(!this.isAnnotationTypeVisible(l.type))continue;a=l}if(a&&s.getLineAtOffset(a.start)===s.getLineAtOffset(o)){var c=n.Tooltip.getTooltip(this._view);c&&c.setTarget(null),a.expanded?a.collapse():a.expand(),this._annotationModel.modifyAnnotation(a)}},a.prototype._getTooltipContents=function(e,t){return t.length===1&&t[0].expanded?null:o.prototype._getTooltipContents.call(this,e,t)},a.prototype._onAnnotationModelChanged=function(e){function a(e){for(i=0;i<e.length;i++){if(!r.isAnnotationTypeVisible(e[i].type))continue;var t=e[i].start;n.getBaseModel&&(t=n.mapOffset(t,!0)),t!==-1&&(u=Math.min(u,n.getLineAtOffset(t)))}}if(e.textModelChangedEvent){o.prototype._onAnnotationModelChanged.call(this,e);return}var t=this._view;if(!t)return;var n=t.getModel(),r=this,i,s=n.getLineCount(),u=s;a(e.added),a(e.removed),a(e.changed);var f=t.getRulers();for(i=0;i<f.length;i++)t.redrawLines(u,s,f[i])},{Ruler:i,AnnotationRuler:o,LineNumberRuler:s,OverviewRuler:u,FoldingRuler:a}}),define("orion/editor/undoStack",[],function(){function e(e,t,n){this.offset=e,this.text=t,this.previousText=n}function t(){this.changes=[]}function n(e,t){this.view=e,this.size=t!==undefined?t:100,this.reset();var n=e.getModel();n.getBaseModel&&(n=n.getBaseModel()),this.model=n;var r=this;this._listener={onChanging:function(e){r._onChanging(e)},onDestroy:function(e){r._onDestroy(e)}},n.addEventListener("Changing",this._listener.onChanging),e.addEventListener("Destroy",this._listener.onDestroy)}return e.prototype={undo:function(e,t){this._doUndoRedo(this.offset,this.previousText,this.text,e,t)},redo:function(e,t){this._doUndoRedo(this.offset,this.text,this.previousText,e,t)},_doUndoRedo:function(e,t,n,r,i){var s=r.getModel();if(s.mapOffset&&r.annotationModel){var o=s.mapOffset(e,!0);if(o<0){var u=r.annotationModel,a=u.getAnnotations(e,e+1);while(a.hasNext()){var f=a.next();if(f.type==="orion.annotation.folding"){f.expand(),o=s.mapOffset(e,!0);break}}}if(o<0)return;e=o}r.setText(t,e,e+n.length),i&&r.setSelection(e,e+t.length)}},t.prototype={add:function(e){this.changes.push(e)},end:function(e){this.endSelection=e.getSelection(),this.endCaret=e.getCaretOffset()},undo:function(e,t){for(var n=this.changes.length-1;n>=0;n--)this.changes[n].undo(e,!1);if(t){var r=this.startSelection.start,i=this.startSelection.end;e.setSelection(this.startCaret?r:i,this.startCaret?i:r)}},redo:function(e,t){for(var n=0;n<this.changes.length;n++)this.changes[n].redo(e,!1);if(t){var r=this.endSelection.start,i=this.endSelection.end;e.setSelection(this.endCaret?r:i,this.endCaret?i:r)}},start:function(e){this.startSelection=e.getSelection(),this.startCaret=e.getCaretOffset()}},n.prototype={add:function(e){if(this.compoundChange)this.compoundChange.add(e);else{var t=this.stack.length;this.stack.splice(this.index,t-this.index,e),this.index++,this.stack.length>this.size&&(this.stack.shift(),this.index--,this.cleanIndex--)}},markClean:function(){this.endCompoundChange(),this._commitUndo(),this.cleanIndex=this.index},isClean:function(){return this.cleanIndex===this.getSize().undo},canUndo:function(){return this.getSize().undo>0},canRedo:function(){return this.getSize().redo>0},endCompoundChange:function(){this.compoundChange&&this.compoundChange.end(this.view),this.compoundChange=undefined},getSize:function(){var e=this.index,t=this.stack.length;return this._undoStart!==undefined&&e++,{undo:e,redo:t-e}},undo:function(){this._commitUndo();if(this.index<=0)return!1;var e=this.stack[--this.index];return this._ignoreUndo=!0,e.undo(this.view,!0),this._ignoreUndo=!1,!0},redo:function(){this._commitUndo();if(this.index>=this.stack.length)return!1;var e=this.stack[this.index++];return this._ignoreUndo=!0,e.redo(this.view,!0),this._ignoreUndo=!1,!0},reset:function(){this.index=this.cleanIndex=0,this.stack=[],this._undoStart=undefined,this._undoText="",this._undoType=0,this._ignoreUndo=!1,this._compoundChange=undefined},startCompoundChange:function(){this._commitUndo();var e=new t;this.add(e),this.compoundChange=e,this.compoundChange.start(this.view)},_commitUndo:function(){this._undoStart!==undefined&&(this._undoType===-1?this.add(new e(this._undoStart,"",this._undoText)):this.add(new e(this._undoStart,this._undoText,"")),this._undoStart=undefined,this._undoText="",this._undoType=0)},_onDestroy:function(e){this.model.removeEventListener("Changing",this._listener.onChanging),this.view.removeEventListener("Destroy",this._listener.onDestroy)},_onChanging:function(t){var n=t.text,r=t.start,i=t.removedCharCount,s=t.addedCharCount;if(this._ignoreUndo)return;this._undoStart!==undefined&&(s!==1||i!==0||this._undoType!==1||r!==this._undoStart+this._undoText.length)&&(s!==0||i!==1||this._undoType!==-1||r+1!==this._undoStart&&r!==this._undoStart)&&this._commitUndo();if(!this.compoundChange){if(s===1&&i===0){this._undoStart===undefined&&(this._undoStart=r),this._undoText=this._undoText+n,this._undoType=1;return}if(s===0&&i===1){var o=this._undoText.length>0&&this._undoStart===r;this._undoStart=r,this._undoType=-1,o?this._undoText=this._undoText+this.model.getText(r,r+i):this._undoText=this.model.getText(r,r+i)+this._undoText;return}}this.add(new e(r,n,this.model.getText(r,r+i)))}},{UndoStack:n}}),define("orion/editor/textDND",[],function(){function e(e,t){this._view=e,this._undoStack=t,this._dragSelection=null,this._dropOffset=-1,this._dropText=null;var n=this;this._listener={onDragStart:function(e){n._onDragStart(e)},onDragEnd:function(e){n._onDragEnd(e)},onDragEnter:function(e){n._onDragEnter(e)},onDragOver:function(e){n._onDragOver(e)},onDrop:function(e){n._onDrop(e)},onDestroy:function(e){n._onDestroy(e)}},e.addEventListener("DragStart",this._listener.onDragStart),e.addEventListener("DragEnd",this._listener.onDragEnd),e.addEventListener("DragEnter",this._listener.onDragEnter),e.addEventListener("DragOver",this._listener.onDragOver),e.addEventListener("Drop",this._listener.onDrop),e.addEventListener("Destroy",this._listener.onDestroy)}return e.prototype={destroy:function(){var e=this._view;if(!e)return;e.removeEventListener("DragStart",this._listener.onDragStart),e.removeEventListener("DragEnd",this._listener.onDragEnd),e.removeEventListener("DragEnter",this._listener.onDragEnter),e.removeEventListener("DragOver",this._listener.onDragOver),e.removeEventListener("Drop",this._listener.onDrop),e.removeEventListener("Destroy",this._listener.onDestroy),this._view=null},_onDestroy:function(e){this.destroy()},_onDragStart:function(e){var t=this._view,n=t.getSelection(),r=t.getModel();r.getBaseModel&&(n.start=r.mapOffset(n.start),n.end=r.mapOffset(n.end),r=r.getBaseModel());var i=r.getText(n.start,n.end);i&&(this._dragSelection=n,e.event.dataTransfer.effectAllowed="copyMove",e.event.dataTransfer.setData("Text",i))},_onDragEnd:function(e){var t=this._view;if(this._dragSelection){this._undoStack&&this._undoStack.startCompoundChange();var n=e.event.dataTransfer.dropEffect==="move";n&&t.setText("",this._dragSelection.start,this._dragSelection.end);if(this._dropText){var r=this._dropText,i=this._dropOffset;n&&(i>=this._dragSelection.end?i-=this._dragSelection.end-this._dragSelection.start:i>=this._dragSelection.start&&(i=this._dragSelection.start)),t.setText(r,i,i),t.setSelection(i,i+r.length),this._dropText=null,this._dropOffset=-1}this._undoStack&&this._undoStack.endCompoundChange()}this._dragSelection=null},_onDragEnter:function(e){this._onDragOver(e)},_onDragOver:function(e){var t=e.event.dataTransfer.types;if(t){var n=!this._view.getOptions("readonly");n&&(n=t.contains?t.contains("text/plain"):t.indexOf("text/plain")!==-1),n||(e.event.dataTransfer.dropEffect="none")}},_onDrop:function(e){var t=this._view,n=e.event.dataTransfer.getData("Text");if(n){var r=t.getOffsetAtLocation(e.x,e.y);this._dragSelection?(this._dropOffset=r,this._dropText=n):(t.setText(n,r,r),t.setSelection(r,r+n.length))}}},{TextDND:e}}),define("orion/editor/editor",["i18n!orion/editor/nls/messages","orion/editor/keyBinding","orion/editor/eventTarget","orion/editor/tooltip","orion/editor/annotations","orion/editor/util"],function(e,t,n,r,i,s){function a(e){this._textViewFactory=e.textViewFactory,this._undoStackFactory=e.undoStackFactory,this._textDNDFactory=e.textDNDFactory,this._annotationFactory=e.annotationFactory,this._foldingRulerFactory=e.foldingRulerFactory,this._lineNumberRulerFactory=e.lineNumberRulerFactory,this._contentAssistFactory=e.contentAssistFactory,this._keyBindingFactory=e.keyBindingFactory,this._statusReporter=e.statusReporter,this._domNode=e.domNode,this._annotationStyler=null,this._annotationModel=null,this._annotationRuler=null,this._lineNumberRuler=null,this._overviewRuler=null,this._foldingRuler=null,this._dirty=!1,this._contentAssist=null,this._title=null,this._keyModes=[]}function f(e){var t=this,n=Array.prototype.slice.call(arguments,1);return n.length?function(){return arguments.length?t.apply(e,n.concat(Array.prototype.slice.call(arguments))):t.apply(e,n)}:function(){return arguments.length?t.apply(e,arguments):t.call(e)}}var o,u="orion.annotation.highlightError";return a.prototype={destroy:function(){this.uninstallTextView(),this._textViewFactory=this._undoStackFactory=this._textDNDFactory=this._annotationFactory=this._foldingRulerFactory=this._lineNumberRulerFactory=this._contentAssistFactory=this._keyBindingFactory=this._statusReporter=this._domNode=null},getAnnotationModel:function(){return this._annotationModel},getAnnotationRuler:function(){return this._annotationRuler},getAnnotationStyler:function(){return this._annotationStyler},getFoldingRuler:function(){return this._foldingRuler},getLineNumberRuler:function(){return this._lineNumberRuler},getModel:function(){var e=this._textView.getModel();return e.getBaseModel&&(e=e.getBaseModel()),e},getOverviewRuler:function(){return this._overviewRuler},getTextView:function(){return this._textView},getTitle:function(){return this._title},getKeyModes:function(){return this._keyModes},isDirty:function(){return this._dirty},setAnnotationRulerVisible:function(e){if(this._annotationRulerVisible===e)return;this._annotationRulerVisible=e;if(!this._annotationRuler)return;var t=this._textView;e?t.addRuler(this._annotationRuler,0):t.removeRuler(this._annotationRuler)},setFoldingRulerVisible:function(e){if(this._foldingRulerVisible===e)return;this._foldingRulerVisible=e;if(!this._foldingRuler)return;var t=this._textView;if(!t.getModel().getBaseModel)return;e?t.addRuler(this._foldingRuler,100):t.removeRuler(this._foldingRuler)},setDirty:function(e){if(this._dirty===e)return;this._dirty=e,this.onDirtyChanged({type:"DirtyChanged"})},setLineNumberRulerVisible:function(e){if(this._lineNumberRulerVisible===e)return;this._lineNumberRulerVisible=e;if(!this._lineNumberRuler)return;var t=this._textView;e?t.addRuler(this._lineNumberRuler,1):t.removeRuler(this._lineNumberRuler)},setOverviewRulerVisible:function(e){if(this._overviewRulerVisible===e)return;this._overviewRulerVisible=e;if(!this._overviewRuler)return;var t=this._textView;e?t.addRuler(this._overviewRuler):t.removeRuler(this._overviewRuler)},mapOffset:function(e,t){var n=this._textView,r=n.getModel();return r.getBaseModel&&(e=r.mapOffset(e,t)),e},getCaretOffset:function(){return this.mapOffset(this._textView.getCaretOffset())},getSelection:function(){var e=this._textView,t=e.getSelection(),n=e.getModel();return n.getBaseModel&&(t.start=n.mapOffset(t.start),t.end=n.mapOffset(t.end)),t},getText:function(e,t){var n=this._textView,r=n.getModel();return r.getBaseModel&&(r=r.getBaseModel()),r.getText(e,t)},_expandOffset:function(e){var t=this._textView.getModel(),n=this._annotationModel;if(!n||!t.getBaseModel)return;var r=n.getAnnotations(e,e+1);while(r.hasNext()){var s=r.next();s.type===i.AnnotationType.ANNOTATION_FOLDING&&s.expand&&(s.expand(),n.modifyAnnotation(s))}},setCaretOffset:function(e){var t=this._textView,n=t.getModel();n.getBaseModel&&(this._expandOffset(e),e=n.mapOffset(e,!0)),t.setCaretOffset(e)},setText:function(e,t,n){var r=this._textView,i=r.getModel();i.getBaseModel&&(t!==undefined&&(this._expandOffset(t),t=i.mapOffset(t,!0)),n!==undefined&&(this._expandOffset(n),n=i.mapOffset(n,!0))),r.setText(e,t,n)},setFoldingEnabled:function(e){this.setFoldingRulerVisible(e)},setSelection:function(e,t,n){var r=this._textView,i=r.getModel();i.getBaseModel&&(this._expandOffset(e),this._expandOffset(t),e=i.mapOffset(e,!0),t=i.mapOffset(t,!0)),r.setSelection(e,t,n)},moveSelection:function(e,t,n,r){t=t||e;var i=this._textView;this.setSelection(e,t,!1);var s=i.getTopPixel(),u=i.getBottomPixel(),a=this.getModel(),f=a.getLineAtOffset(e),l=i.getLinePixel(f);if(l<s||l>u){var c=u-s,h=Math.max(0,l-Math.floor((l<s?3:1)*c/4)),p=new o({node:i,duration:300,curve:[s,h],onAnimate:function(e){i.setTopPixel(Math.floor(e))},onEnd:function(){i.showSelection(),(r===undefined||r)&&i.focus(),n&&n()}});p.play()}else i.showSelection(),(r===undefined||r)&&i.focus(),n&&n()},checkDirty:function(){this.setDirty(!this._undoStack.isClean())},reportStatus:function(e,t,n){this._statusReporter&&this._statusReporter(e,t,n)},_getTooltipInfo:function(e,t){var n=this._textView,r=this.getAnnotationModel();if(!r)return null;var i=this._annotationStyler;if(!i)return null;var s=n.getOffsetAtLocation(e,t);if(s===-1)return null;s=this.mapOffset(s);var o=i.getAnnotationsByType(r,s,s+1),u=[];for(var a=0;a<o.length;a++)o[a].rangeStyle&&u.push(o[a]);if(u.length===0)return null;var f=n.convert({x:e,y:t},"document","page"),l={contents:u,anchor:"left",x:f.x+10,y:f.y+20};return l},_highlightCurrentLine:function(e,t){var n=this._annotationModel;if(!n)return;var r=this._textView,s=r.getModel(),o=t?s.getLineAtOffset(t.start):-1,u=s.getLineAtOffset(e.start),a=e.start===e.end,f=!t||t.start===t.end,l=s.getLineStart(u),c=s.getLineEnd(u);s.getBaseModel&&(l=s.mapOffset(l),c=s.mapOffset(c));var h=this._currentLineAnnotation;if(o===u&&f&&a&&h&&h.start===l&&h.end===c)return;var p=h?[h]:null,d;if(a){var v=i.AnnotationType.ANNOTATION_CURRENT_LINE;h=i.AnnotationType.createAnnotation(v,l,c),d=[h]}this._currentLineAnnotation=h,n.replaceAnnotations(p,d)},installTextView:function(){this._textView=this._textViewFactory(),this._undoStackFactory&&(this._undoStack=this._undoStackFactory.createUndoStack(this)),this._textDNDFactory&&(this._textDND=this._textDNDFactory.createTextDND(this,this._undoStack));if(this._contentAssistFactory){var n=this._contentAssistFactory.createContentAssistMode(this);this._keyModes.push(n),this._contentAssist=n.getContentAssist()}var s=this,o=this._textView,a=this;this._listener={onModelChanged:function(e){a.checkDirty()},onMouseOver:function(e){a._listener.onMouseMove(e)},onMouseMove:function(e){var t=r.Tooltip.getTooltip(o);if(!t)return;t.setTarget({x:e.x,y:e.y,getTooltipInfo:function(){return a._getTooltipInfo(this.x,this.y)}})},onMouseOut:function(e,t){var n=r.Tooltip.getTooltip(o);if(!n)return;n.setTarget(null)},onSelection:function(e){a._updateCursorStatus(),a._highlightCurrentLine(e.newValue,e.oldValue)}},o.addEventListener("ModelChanged",this._listener.onModelChanged),o.addEventListener("Selection",this._listener.onSelection),o.addEventListener("MouseOver",this._listener.onMouseOver),o.addEventListener("MouseOut",this._listener.onMouseOut),o.addEventListener("MouseMove",this._listener.onMouseMove),this._keyBindingFactory&&this._keyBindingFactory(this,this._keyModes,this._undoStack,this._contentAssist),o.setKeyBinding(new t.KeyBinding(27),"cancelMode"),o.setAction("cancelMode",function(){var e=!1;for(var t=0;t<this._keyModes.length;t++)this._keyModes[t].isActive()&&(e=this._keyModes[t].cancel()||e);return e}.bind(this),{name:e.cancelMode}),o.setAction("lineUp",function(){for(var e=0;e<this._keyModes.length;e++)if(this._keyModes[e].isActive())return this._keyModes[e].lineUp();return!1}.bind(this)),o.setAction("lineDown",function(){for(var e=0;e<this._keyModes.length;e++)if(this._keyModes[e].isActive())return this._keyModes[e].lineDown();return!1}.bind(this)),o.setAction("enter",function(){for(var e=0;e<this._keyModes.length;e++)if(this._keyModes[e].isActive())return this._keyModes[e].enter();return!1}.bind(this));var f=function(e,t){if(e===undefined)return;if(e===-1)return;var n=this.getView(),r=n.getModel(),o=this.getAnnotationModel(),u=s.mapOffset(r.getLineStart(e)),a=s.mapOffset(r.getLineEnd(e)),f=o.getAnnotations(u,a),l=null;while(f.hasNext()){var c=f.next();if(c.type===i.AnnotationType.ANNOTATION_BOOKMARK){l=c;break}}l?o.removeAnnotation(l):(l=i.AnnotationType.createAnnotation(i.AnnotationType.ANNOTATION_BOOKMARK,u,a),l.title=undefined,o.addAnnotation(l))};if(this._annotationFactory){var l=o.getModel();l.getBaseModel&&(l=l.getBaseModel()),this._annotationModel=this._annotationFactory.createAnnotationModel(l);if(this._annotationModel){var c=this._annotationStyler=this._annotationFactory.createAnnotationStyler(o,this._annotationModel);c&&(c.addAnnotationType(i.AnnotationType.ANNOTATION_CURRENT_SEARCH),c.addAnnotationType(i.AnnotationType.ANNOTATION_MATCHING_SEARCH),c.addAnnotationType(i.AnnotationType.ANNOTATION_ERROR),c.addAnnotationType(i.AnnotationType.ANNOTATION_WARNING),c.addAnnotationType(i.AnnotationType.ANNOTATION_MATCHING_BRACKET),c.addAnnotationType(i.AnnotationType.ANNOTATION_CURRENT_BRACKET),c.addAnnotationType(i.AnnotationType.ANNOTATION_CURRENT_LINE),c.addAnnotationType(i.AnnotationType.ANNOTATION_READ_OCCURRENCE),c.addAnnotationType(i.AnnotationType.ANNOTATION_WRITE_OCCURRENCE),c.addAnnotationType(u))}o.annotationModel=this._annotationModel;var h=this._annotationFactory.createAnnotationRulers(this._annotationModel),p=this._annotationRuler=h.annotationRuler;p&&(p.onClick=function(e,t){if(e===undefined)return;if(e===-1)return;var n=this.getView(),r=n.getModel(),i=this.getAnnotationModel(),o=s.mapOffset(r.getLineStart(e)),u=s.mapOffset(r.getLineEnd(e)),a=i.getAnnotations(o,u);while(a.hasNext()){var f=a.next();if(!this.isAnnotationTypeVisible(f.type))continue;var l=s.getModel();s.onGotoLine(l.getLineAtOffset(o),f.start-o,f.end-o);break}},p.onDblClick=f,p.setMultiAnnotationOverlay({html:"<div class='annotationHTML overlay'></div>"}),p.addAnnotationType(i.AnnotationType.ANNOTATION_ERROR),p.addAnnotationType(i.AnnotationType.ANNOTATION_WARNING),p.addAnnotationType(i.AnnotationType.ANNOTATION_TASK),p.addAnnotationType(i.AnnotationType.ANNOTATION_BOOKMARK)),this.setAnnotationRulerVisible(!0),p=this._overviewRuler=h.overviewRuler,p&&(p.onClick=function(e,t){if(e===undefined)return;var n=o.getModel().getLineStart(e);s.moveSelection(s.mapOffset(n))},p.addAnnotationType(i.AnnotationType.ANNOTATION_CURRENT_SEARCH),p.addAnnotationType(i.AnnotationType.ANNOTATION_MATCHING_SEARCH),p.addAnnotationType(i.AnnotationType.ANNOTATION_ERROR),p.addAnnotationType(i.AnnotationType.ANNOTATION_WARNING),p.addAnnotationType(i.AnnotationType.ANNOTATION_TASK),p.addAnnotationType(i.AnnotationType.ANNOTATION_BOOKMARK),p.addAnnotationType(i.AnnotationType.ANNOTATION_MATCHING_BRACKET),p.addAnnotationType(i.AnnotationType.ANNOTATION_CURRENT_BRACKET),p.addAnnotationType(i.AnnotationType.ANNOTATION_CURRENT_LINE),p.addAnnotationType(i.AnnotationType.ANNOTATION_READ_OCCURRENCE),p.addAnnotationType(i.AnnotationType.ANNOTATION_WRITE_OCCURRENCE)),this.setOverviewRulerVisible(!0)}this._lineNumberRulerFactory&&(this._lineNumberRuler=this._lineNumberRulerFactory.createLineNumberRuler(this._annotationModel),this._lineNumberRuler.onDblClick=f,this.setLineNumberRulerVisible(!0)),this._foldingRulerFactory&&(this._foldingRuler=this._foldingRulerFactory.createFoldingRuler(this._annotationModel),this._foldingRuler.addAnnotationType(i.AnnotationType.ANNOTATION_FOLDING),this.setFoldingRulerVisible(!1));var d={type:"TextViewInstalled",textView:o};this.dispatchEvent(d)},uninstallTextView:function(){var e=this._textView;if(!e)return;e.destroy(),this._textView=this._undoStack=this._textDND=this._contentAssist=this._listener=this._annotationModel=this._annotationStyler=this._annotationRuler=this._overviewRuler=this._lineNumberRuler=this._foldingRuler=this._currentLineAnnotation=this._title=null,this._dirty=!1,this._keyModes=[];var t={type:"TextViewUninstalled",textView:e};this.dispatchEvent(t)},_updateCursorStatus:function(){var t=this.getModel(),n=this.getCaretOffset(),r=t.getLineAtOffset(n),i=t.getLineStart(r),o=n-i;for(var u=0;u<this._keyModes.length;u++){var a=this._keyModes[u];if(a.isActive()&&a.isStatusActive&&a.isStatusActive())return}this.reportStatus(s.formatMessage(e.lineColumn,r+1,o+1))},showProblems:function(e){var t=this._annotationModel;if(!t)return;var n=[],r=[],s=t.getTextModel(),o=t.getAnnotations(0,s.getCharCount()),u;while(o.hasNext())u=o.next(),(u.type===i.AnnotationType.ANNOTATION_ERROR||u.type===i.AnnotationType.ANNOTATION_WARNING)&&n.push(u);if(e)for(var a=0;a<e.length;a++){var f=e[a];if(f){var l=f.description.replace(/'/g,"&#39;").replace(/"/g,"&#34;"),c=f.line-1,h=s.getLineStart(c),p=f.severity,d=p==="error"?i.AnnotationType.ANNOTATION_ERROR:i.AnnotationType.ANNOTATION_WARNING,v=h+f.start-1,m=h+f.end;u=i.AnnotationType.createAnnotation(d,v,m,l),r.push(u)}}t.replaceAnnotations(n,r)},showOccurrences:function(e){var t=this._annotationModel;if(!t)return;var n=[],r=[],s=t.getTextModel(),o=t.getAnnotations(0,s.getCharCount()),u;while(o.hasNext())u=o.next(),(u.type===i.AnnotationType.ANNOTATION_READ_OCCURRENCE||u.type===i.AnnotationType.ANNOTATION_WRITE_OCCURRENCE)&&n.push(u);if(e)for(var a=0;a<e.length;a++){var f=e[a];if(f){var l=f.line-1,c=s.getLineStart(l),h=c+f.start-1,p=c+f.end,d=f.readAccess===!0?i.AnnotationType.ANNOTATION_READ_OCCURRENCE:i.AnnotationType.ANNOTATION_WRITE_OCCURRENCE,v=f.description;u=i.AnnotationType.createAnnotation(d,h,p,v),r.push(u)}}t.replaceAnnotations(n,r)},showSelection:function(e,t,n,r,i){if(typeof e=="number")typeof t!="number"&&(t=e),this.moveSelection(e,t);else if(typeof n=="number"){var s=this.getModel(),o=s.getLineStart(n-1);typeof r=="number"&&(o+=r),typeof i!="number"&&(i=0),this.moveSelection(o,o+i)}},setInput:function(e,t,n,r){this._title=e,this._textView&&(r?(this._undoStack.markClean(),this.checkDirty()):(t?this._textView.setText(t):n!==null&&n!==undefined&&(this._textView.setText(n),this._textView.getModel().setLineDelimiter("auto"),this._highlightCurrentLine(this._textView.getSelection())),this._undoStack.reset(),this.checkDirty(),this._textView.focus())),this.onInputChanged({type:"InputChanged",title:e,message:t,contents:n,contentsSaved:r})},onInputChanged:function(e){return this.dispatchEvent(e)},onGotoLine:function(e,t,n){if(this._textView){var r=this.getModel(),i=r.getLineStart(e),s=0;n===undefined&&(n=0);if(typeof t=="string"){var o=r.getLine(e).indexOf(t);o!==-1&&(s=o,n=s+t.length)}else{s=t;var u=r.getLineEnd(e)-i;s=Math.min(s,u),n=Math.min(n,u)}this.moveSelection(i+s,i+n)}},onDirtyChanged:function(e){return this.dispatchEvent(e)}},n.EventTarget.addMixin(a.prototype),o=function(){function e(e){this.options=e}return e.prototype.play=function(){function c(){l=l===-1?(new Date).getTime():l;var t=(new Date).getTime(),o=(t-l)/e;if(o<1){var c=n(o);a=s+c*u,r(a)}else clearInterval(f),i()}var e=typeof this.options.duration=="number"?this.options.duration:350,t=typeof this.options.rate=="number"?this.options.rate:20,n=this.options.easing||this.defaultEasing,r=this.options.onAnimate||function(){},i=this.options.onEnd||function(){},s=this.options.curve[0],o=this.options.curve[1],u=o-s,a,f,l=-1;f=setInterval(c,t)},e.prototype.defaultEasing=function(e){return Math.sin(e*(Math.PI/2))},e}(),Function.prototype.bind||(Function.prototype.bind=f),{Editor:a,util:{bind:f}}}),define("orion/editor/regex",[],function(){function e(e){return e.replace(/([\\$\^*\/+?\.\(\)|{}\[\]])/g,"\\$&")}function t(e){var t=/^\s*\/(.+)\/([gim]{0,3})\s*$/.exec(e);return t?{pattern:t[1],flags:t[2]}:null}return{escape:e,parse:t}}),define("orion/editor/editorFeatures",["i18n!orion/editor/nls/messages","orion/editor/undoStack","orion/editor/keyBinding","orion/editor/rulers","orion/editor/annotations","orion/editor/tooltip","orion/editor/textDND","orion/editor/regex","orion/editor/util"],function(e,t,n,r,i,s,o,u,a){function f(){}function l(){}function c(){}function h(){}function p(){}function d(e,t,n){this.editor=e,this.textView=e.getTextView(),this.undoStack=t,this._incrementalFindActive=!1,this._incrementalFindSuccess=!0,this._incrementalFindIgnoreSelection=!1,this._incrementalFindPrefix="",this._searcher=n,this._lastEditLocation=null,this.init()}function v(e,t,n,r){this.editor=e,this.textView=e.getTextView(),this.undoStack=t,this.contentAssist=n,this.linkedMode=r,this.contentAssist&&this.contentAssist.addEventListener("ProposalApplied",this.contentAssistProposalApplied.bind(this)),this.init()}function m(e){this.editor=e,this.textView=e.getTextView(),this.linkedModeActive=!1,this.linkedModePositions=[],this.linkedModeCurrentPositionIndex=0,this.linkedModeEscapePosition=0,this.linkedModeListener={onVerify:function(e){var t=!1,n=0;for(var r=0;r<this.linkedModePositions.length;++r){var i=this.linkedModePositions[r];if(t)i.offset+=n;else if(e.start>=i.offset&&e.end<=i.offset+i.length){var s=i.length;i.length=e.start-i.offset+e.text.length+(i.offset+i.length-e.end),n=i.length-s,t=!0}}t?this.linkedModeEscapePosition+=n:this.cancel()}.bind(this)}}return f.prototype={createUndoStack:function(n){var r=n.getTextView(),i=new t.UndoStack(r,200);return r.setAction("undo",function(){return i.undo(),!0},{name:e.undo}),r.setAction("redo",function(){return i.redo(),!0},{name:e.redo}),i}},l.prototype={createLineNumberRuler:function(e){return new r.LineNumberRuler(e,"left",{styleClass:"ruler lines"},{styleClass:"rulerLines odd"},{styleClass:"rulerLines even"})}},c.prototype={createFoldingRuler:function(e){return new r.FoldingRuler(e,"left",{styleClass:"ruler folding"})}},h.prototype={createAnnotationModel:function(e){return new i.AnnotationModel(e)},createAnnotationStyler:function(e,t){return new i.AnnotationStyler(e,t)},createAnnotationRulers:function(e){var t=new r.AnnotationRuler(e,"left",{styleClass:"ruler annotations"}),n=new r.OverviewRuler(e,"right",{styleClass:"ruler overview"});return{annotationRuler:t,overviewRuler:n}}},p.prototype={createTextDND:function(e,t){return new o.TextDND(e.getTextView(),t)}},d.prototype={init:function(){var t=this;this._incrementalFindListener={onVerify:function(n){var r=t.editor,i=r.getModel(),s=r.mapOffset(n.start),o=r.mapOffset(n.end),f=i.getText(s,o),l=t._incrementalFindPrefix,c=l.match(new RegExp("^"+u.escape(f),"i"));if(c&&c.length>0){l=t._incrementalFindPrefix+=n.text,t.editor.reportStatus(a.formatMessage(e.incrementalFind,l));var h=r.getSelection().start,p=r.getModel().find({string:l,start:h,caseInsensitive:l.toLowerCase()===l}).next();p?(t._incrementalFindSuccess=!0,t._incrementalFindIgnoreSelection=!0,r.moveSelection(p.start,p.end),t._incrementalFindIgnoreSelection=!1):(r.reportStatus(a.formatMessage(e.incrementalFindNotFound,l),"error"),t._incrementalFindSuccess=!1),n.text=null}},onSelection:function(){t._incrementalFindIgnoreSelection||t.toggleIncrementalFind()}},this._lastEditListener={onModelChanged:function(e){t.editor.isDirty()&&(t._lastEditLocation=e.start+e.addedCharCount)}},this.textView.addEventListener("ModelChanged",this._lastEditListener.onModelChanged),this.textView.setKeyBinding(new n.KeyBinding("k",!0),"findNext"),this.textView.setAction("findNext",function(){if(this._searcher){var e=this.textView.getSelection();return e.start<e.end?this._searcher.findNext(!0,this.textView.getText(e.start,e.end)):this._searcher.findNext(!0),!0}return!1}.bind(this),{name:e.findNext}),this.textView.setKeyBinding(new n.KeyBinding("k",!0,!0),"findPrevious"),this.textView.setAction("findPrevious",function(){if(this._searcher){var e=this.textView.getSelection();return e.start<e.end?this._searcher.findNext(!1,this.textView.getText(e.start,e.end)):this._searcher.findNext(!1),!0}return!1}.bind(this),{name:e.findPrevious}),this.textView.setKeyBinding(new n.KeyBinding("j",!0),"incrementalFind"),this.textView.setAction("incrementalFind",function(){if(this._searcher&&this._searcher.visible())return!0;var t=this.editor;if(!this._incrementalFindActive)t.setCaretOffset(t.getCaretOffset()),this.toggleIncrementalFind();else{var n=this._incrementalFindPrefix;if(n.length!==0){var r,i=0;this._incrementalFindSuccess&&(i=t.getSelection().start+1),r=t.getModel().find({string:n,start:i,caseInsensitive:n.toLowerCase()===n}).next(),r?(this._incrementalFindSuccess=!0,this._incrementalFindIgnoreSelection=!0,t.moveSelection(r.start,r.end),this._incrementalFindIgnoreSelection=!1,t.reportStatus(a.formatMessage(e.incrementalFind,n))):(t.reportStatus(a.formatMessage(e.incrementalFindNotFound,n),"error"),this._incrementalFindSuccess=!1)}}return!0}.bind(this),{name:e.incrementalFindKey}),this.textView.setAction("deletePrevious",function(){if(this._incrementalFindActive){var t=this.editor,n=this._incrementalFindPrefix;n=this._incrementalFindPrefix=n.substring(0,n.length-1);if(n.length===0)return this._incrementalFindSuccess=!0,this._incrementalFindIgnoreSelection=!0,t.setCaretOffset(t.getSelection().start),this._incrementalFindIgnoreSelection=!1,this.toggleIncrementalFind(),!0;t.reportStatus(a.formatMessage(e.incrementalFind,n));var r=t.getModel().find({string:n,start:t.getCaretOffset()-n.length-1,reverse:!0,caseInsensitive:n.toLowerCase()===n}).next();return r?(this._incrementalFindSuccess=!0,this._incrementalFindIgnoreSelection=!0,t.moveSelection(r.start,r.end),this._incrementalFindIgnoreSelection=!1):t.reportStatus(a.formatMessage(e.incrementalFindNotFound,n),"error"),!0}return!1}.bind(this)),this.textView.setAction("tab",function(){if(this.textView.getOptions("readonly"))return!1;if(!this.textView.getOptions("tabMode"))return;var e=this.editor,t=e.getModel(),n=e.getSelection(),r=t.getLineAtOffset(n.start),i=t.getLineAtOffset(n.end>n.start?n.end-1:n.end);if(r!==i){var s=[];s.push("");for(var o=r;o<=i;o++)s.push(t.getLine(o,!0));var u=t.getLineStart(r),a=t.getLineEnd(i,!0),f=this.textView.getOptions("tabSize","expandTab"),l=f.expandTab?(new Array(f.tabSize+1)).join(" "):"	";return e.setText(s.join(l),u,a),e.setSelection(u===n.start?n.start:n.start+l.length,n.end+(i-r+1)*l.length),!0}var c=e.getKeyModes();for(var h=0;h<c.length;h++)if(c[h].isActive())return c[h].tab();return!1}.bind(this)),this.textView.setAction("shiftTab",function(){if(this.textView.getOptions("readonly"))return!1;if(!this.textView.getOptions("tabMode"))return;var e=this.editor,t=e.getModel(),n=e.getSelection(),r=t.getLineAtOffset(n.start),i=t.getLineAtOffset(n.end>n.start?n.end-1:n.end),s=this.textView.getOptions("tabSize"),o=(new Array(s+1)).join(" "),u=[],a=0,f=0;for(var l=r;l<=i;l++){var c=t.getLine(l,!0);if(t.getLineStart(l)!==t.getLineEnd(l))if(c.indexOf("	")===0)c=c.substring(1),a++;else{if(c.indexOf(o)!==0)return!0;c=c.substring(s),a+=s}l===r&&(f=a),u.push(c)}var h=t.getLineStart(r),p=t.getLineEnd(i,!0),d=t.getLineStart(i);e.setText(u.join(""),h,p);var v=h===n.start?n.start:n.start-f,m=Math.max(v,n.end-a+(n.end===d+1&&n.start!==n.end?1:0));return e.setSelection(v,m),!0}.bind(this),{name:e.unindentLines}),this.textView.setKeyBinding(new n.KeyBinding(38,!1,!1,!0),"moveLinesUp"),this.textView.setAction("moveLinesUp",function(){if(this.textView.getOptions("readonly"))return!1;var e=this.editor,t=e.getModel(),n=e.getSelection(),r=t.getLineAtOffset(n.start);if(r===0)return!0;var i=t.getLineAtOffset(n.end>n.start?n.end-1:n.end),s=t.getLineCount(),o=t.getLineStart(r-1),u=t.getLineStart(r),a=t.getLineEnd(i,!0),f=t.getText(u,a),l=0;if(i===s-1){var c=t.getLineEnd(r-1),h=t.getLineEnd(r-1,!0);f+=t.getText(c,h),u=c,l=h-c}return this.startUndo(),e.setText("",u,a),e.setText(f,o,o),e.setSelection(o,o+f.length-l),this.endUndo(),!0}.bind(this),{name:e.moveLinesUp}),this.textView.setKeyBinding(new n.KeyBinding(40,!1,!1,!0),"moveLinesDown"),this.textView.setAction("moveLinesDown",function(){if(this.textView.getOptions("readonly"))return!1;var e=this.editor,t=e.getModel(),n=e.getSelection(),r=t.getLineAtOffset(n.start),i=t.getLineAtOffset(n.end>n.start?n.end-1:n.end),s=t.getLineCount();if(i===s-1)return!0;var o=t.getLineStart(r),u=t.getLineEnd(i,!0),a=t.getLineEnd(i+1,!0)-(u-o),f,l=0;if(i!==s-2)f=t.getText(o,u);else{var c=t.getLineEnd(i);f=t.getText(c,u)+t.getText(o,c),l+=u-c}return this.startUndo(),e.setText("",o,u),e.setText(f,a,a),e.setSelection(a+l,a+l+f.length),this.endUndo(),!0}.bind(this),{name:e.moveLinesDown}),this.textView.setKeyBinding(new n.KeyBinding(38,!0,!1,!0),"copyLinesUp"),this.textView.setAction("copyLinesUp",function(){if(this.textView.getOptions("readonly"))return!1;var e=this.editor,t=e.getModel(),n=e.getSelection(),r=t.getLineAtOffset(n.start),i=t.getLineAtOffset(n.end>n.start?n.end-1:n.end),s=t.getLineStart(r),o=t.getLineEnd(i,!0),u=t.getLineCount(),a="",f=t.getText(s,o);i===u-1&&(f+=a=t.getLineDelimiter());var l=s;return e.setText(f,l,l),e.setSelection(l,l+f.length-a.length),!0}.bind(this),{name:e.copyLinesUp}),this.textView.setKeyBinding(new n.KeyBinding(40,!0,!1,!0),"copyLinesDown"),this.textView.setAction("copyLinesDown",function(){if(this.textView.getOptions("readonly"))return!1;var e=this.editor,t=e.getModel(),n=e.getSelection(),r=t.getLineAtOffset(n.start),i=t.getLineAtOffset(n.end>n.start?n.end-1:n.end),s=t.getLineStart(r),o=t.getLineEnd(i,!0),u=t.getLineCount(),a="",f=t.getText(s,o);i===u-1&&(f=(a=t.getLineDelimiter())+f);var l=o;return e.setText(f,l,l),e.setSelection(l+a.length,l+f.length),!0}.bind(this),{name:e.copyLinesDown}),this.textView.setKeyBinding(new n.KeyBinding("d",!0,!1,!1),"deleteLines"),this.textView.setAction("deleteLines",function(){if(this.textView.getOptions("readonly"))return!1;var e=this.editor,t=e.getSelection(),n=e.getModel(),r=n.getLineAtOffset(t.start),i=n.getLineAtOffset(t.end>t.start?t.end-1:t.end),s=n.getLineStart(r),o=n.getLineEnd(i,!0);return e.setText("",s,o),!0}.bind(this),{name:e.deleteLines}),this.textView.setKeyBinding(new n.KeyBinding("l",!0),"gotoLine"),this.textView.setAction("gotoLine",function(){var t=this.editor,n=t.getModel(),r=n.getLineAtOffset(t.getCaretOffset());return r=prompt(e.gotoLinePrompty,r+1),r&&(r=parseInt(r,10),t.onGotoLine(r-1,0)),!0}.bind(this),{name:e.gotoLine}),this.textView.setKeyBinding(new n.KeyBinding(190,!0),"nextAnnotation"),this.textView.setAction("nextAnnotation",function(){var e=this.editor,t=e.getAnnotationModel();if(!t)return!0;var n=e.getModel(),r=e.getCaretOffset(),o=t.getAnnotations(r,n.getCharCount());while(o.hasNext()){var u=o.next();if(u.start<=r)continue;if(u.type!==i.AnnotationType.ANNOTATION_ERROR&&u.type!==i.AnnotationType.ANNOTATION_WARNING&&u.type!==i.AnnotationType.ANNOTATION_TASK&&u.type!==i.AnnotationType.ANNOTATION_BOOKMARK)continue;var a=s.Tooltip.getTooltip(this.textView);if(!a)return e.moveSelection(u.start),!0;var f=n.getLineAtOffset(u.start),l=this.textView,c=function(){setTimeout(function(){a.setTarget({getTooltipInfo:function(){var e=l.convert({x:l.getLocationAtOffset(u.start).x,y:l.getLocationAtOffset(n.getLineStart(f)).y},"document","page");return{contents:[u],x:e.x,y:e.y+Math.floor(l.getLineHeight(f)*1.33)}}},0)},0)};e.moveSelection(u.start,u.start,c);break}return!0}.bind(this),{name:e.nextAnnotation}),this.textView.setKeyBinding(new n.KeyBinding(188,!0),"previousAnnotation"),this.textView.setAction("previousAnnotation",function(){var e=this.editor,t=e.getAnnotationModel();if(!t)return!0;var n=e.getModel(),r=e.getCaretOffset(),o=t.getAnnotations(0,r),u=null;while(o.hasNext()){var a=o.next();if(a.start>=r)continue;if(a.type!==i.AnnotationType.ANNOTATION_ERROR&&a.type!==i.AnnotationType.ANNOTATION_WARNING&&a.type!==i.AnnotationType.ANNOTATION_TASK&&a.type!==i.AnnotationType.ANNOTATION_BOOKMARK)continue;u=a}if(u){var f=n.getLineAtOffset(u.start),l=s.Tooltip.getTooltip(this.textView);if(!l)return e.moveSelection(u.start),!0;var c=this.textView,h=function(){setTimeout(function(){l.setTarget({getTooltipInfo:function(){var e=c.convert({x:c.getLocationAtOffset(u.start).x,y:c.getLocationAtOffset(n.getLineStart(f)).y},"document","page");return{contents:[u],x:e.x,y:e.y+Math.floor(c.getLineHeight(f)*1.33)}}},0)},0)};e.moveSelection(u.start,u.start,h)}return!0}.bind(this),{name:e.prevAnnotation}),this.textView.setKeyBinding(new n.KeyBinding("e",!0,!1,!0,!1),"expand"),this.textView.setAction("expand",function(){var e=this.editor,t=e.getAnnotationModel();if(!t)return!0;var n=e.getModel(),r=e.getCaretOffset(),s=n.getLineAtOffset(r),o=n.getLineStart(s),u=n.getLineEnd(s,!0);n.getBaseModel&&(o=n.mapOffset(o),u=n.mapOffset(u),n=n.getBaseModel());var a,f=t.getAnnotations(o,u);while(!a&&f.hasNext()){var l=f.next();if(l.type!==i.AnnotationType.ANNOTATION_FOLDING)continue;if(l.expanded)continue;a=l}return a&&!a.expanded&&(a.expand(),t.modifyAnnotation(a)),!0}.bind(this),{name:e.expand}),this.textView.setKeyBinding(new n.KeyBinding("c",!0,!1,!0,!1),"collapse"),this.textView.setAction("collapse",function(){var e=this.editor,t=e.getAnnotationModel();if(!t)return!0;var n=e.getModel(),r=e.getCaretOffset(),s=n.getLineAtOffset(r),o=n.getLineStart(s),u=n.getLineEnd(s,!0);n.getBaseModel&&(o=n.mapOffset(o),u=n.mapOffset(u),n=n.getBaseModel());var a,f=t.getAnnotations(o,u);while(!a&&f.hasNext()){var l=f.next();if(l.type!==i.AnnotationType.ANNOTATION_FOLDING)continue;a=l}return a&&a.expanded&&(e.setCaretOffset(a.start),a.collapse(),t.modifyAnnotation(a)),!0}.bind(this),{name:e.collapse}),this.textView.setKeyBinding(new n.KeyBinding("e",!0,!0,!0,!1),"expandAll"),this.textView.setAction("expandAll",function(){var e=this.editor,t=e.getAnnotationModel();if(!t)return!0;var n=e.getModel(),r,s=t.getAnnotations(0,n.getCharCount());this.textView.setRedraw(!1);while(s.hasNext()){r=s.next();if(r.type!==i.AnnotationType.ANNOTATION_FOLDING)continue;r.expanded||(r.expand(),t.modifyAnnotation(r))}return this.textView.setRedraw(!0),!0}.bind(this),{name:e.expandAll}),this.textView.setKeyBinding(new n.KeyBinding("c",!0,!0,!0,!1),"collapseAll"),this.textView.setAction("collapseAll",function(){var e=this.editor,t=e.getAnnotationModel();if(!t)return!0;var n=e.getModel(),r,s=t.getAnnotations(0,n.getCharCount());this.textView.setRedraw(!1);while(s.hasNext()){r=s.next();if(r.type!==i.AnnotationType.ANNOTATION_FOLDING)continue;r.expanded&&(r.collapse(),t.modifyAnnotation(r))}return this.textView.setRedraw(!0),!0}.bind(this),{name:e.collapseAll}),this.textView.setKeyBinding(new n.KeyBinding("q",!a.isMac,!1,!1,a.isMac),"lastEdit"),this.textView.setAction("lastEdit",function(){return typeof this._lastEditLocation=="number"&&this.editor.showSelection(this._lastEditLocation),!0}.bind(this),{name:e.lastEdit})},toggleIncrementalFind:function(){this._incrementalFindActive=!this._incrementalFindActive,this._incrementalFindActive?(this.editor.reportStatus(a.formatMessage(e.incrementalFind,this._incrementalFindPrefix)),this.textView.addEventListener("Verify",this._incrementalFindListener.onVerify),this.textView.addEventListener("Selection",this._incrementalFindListener.onSelection)):(this._incrementalFindPrefix="",this.editor.reportStatus(""),this.textView.removeEventListener("Verify",this._incrementalFindListener.onVerify),this.textView.removeEventListener("Selection",this._incrementalFindListener.onSelection),this.textView.setCaretOffset(this.textView.getCaretOffset()))},startUndo:function(){this.undoStack&&this.undoStack.startCompoundChange()},endUndo:function(){this.undoStack&&this.undoStack.endCompoundChange()},cancel:function(){this.toggleIncrementalFind()},isActive:function(){return this._incrementalFindActive},isStatusActive:function(){return this._incrementalFindActive},lineUp:function(){if(this._incrementalFindActive){var t=this._incrementalFindPrefix;if(t.length===0)return!1;var n=this.editor,r=n.getModel(),i;this._incrementalFindSuccess?i=n.getCaretOffset()-t.length-1:i=r.getCharCount()-1;var s=n.getModel().find({string:t,start:i,reverse:!0,caseInsensitive:t.toLowerCase()===t}).next();return s?(this._incrementalFindSuccess=!0,this._incrementalFindIgnoreSelection=!0,n.moveSelection(s.start,s.end),this._incrementalFindIgnoreSelection=!1,n.reportStatus(a.formatMessage(e.incrementalFind,t))):(n.reportStatus(a.formatMessage(e.incrementalFindNotFound,t),"error"),this._incrementalFindSuccess=!1),!0}return!1},lineDown:function(){if(this._incrementalFindActive){var t=this._incrementalFindPrefix;if(t.length===0)return!1;var n=this.editor,r=0;this._incrementalFindSuccess&&(r=n.getSelection().start+1);var i=n.getModel().find({string:t,start:r,caseInsensitive:t.toLowerCase()===t}).next();return i?(this._incrementalFindSuccess=!0,this._incrementalFindIgnoreSelection=!0,n.moveSelection(i.start,i.end),this._incrementalFindIgnoreSelection=!1,n.reportStatus(a.formatMessage(e.incrementalFind,t))):(n.reportStatus(a.formatMessage(e.incrementalFindNotFound,t),"error"),this._incrementalFindSuccess=!1),!0}return!1},enter:function(){return!1}},v.prototype={startUndo:function(){this.undoStack&&this.undoStack.startCompoundChange()},endUndo:function(){this.undoStack&&this.undoStack.endCompoundChange()},init:function(){function t(e,t,n){var r="/*",i="*/",s=e.getLineAtOffset(t),o=e.getLineAtOffset(n),u,a,f,l,c,h,p;for(u=s;u>=0;u--){a=e.getLine(u),f=u===s?t-e.getLineStart(s):a.length,l=a.lastIndexOf(r,f),c=a.lastIndexOf(i,f);if(c>l)break;if(l!==-1){h=e.getLineStart(u)+l;break}}for(u=o;u<e.getLineCount();u++){a=e.getLine(u),f=u===o?n-e.getLineStart(o):0,l=a.indexOf(r,f),c=a.indexOf(i,f);if(l!==-1&&l<c)break;if(c!==-1){p=e.getLineStart(u)+c;break}}return{commentStart:h,commentEnd:p}}this.textView.setAction("lineStart",function(){var e=this.editor,t=e.getModel(),n=e.getCaretOffset(),r=t.getLineAtOffset(n),i=t.getLineStart(r),s=t.getLine(r),o;for(o=0;o<s.length;o++){var u=s.charCodeAt(o);if(u!==32&&u!==9)break}return o+=i,n!==o?(e.setSelection(o,o),!0):!1}.bind(this)),this.textView.setKeyBinding(new n.KeyBinding(191,!0),"toggleLineComment"),this.textView.setAction("toggleLineComment",function(){if(this.textView.getOptions("readonly"))return!1;var e=this.editor,t=e.getModel(),n=e.getSelection(),r=t.getLineAtOffset(n.start),i=t.getLineAtOffset(n.end>n.start?n.end-1:n.end),s=!0,o=[],u,a;for(var f=r;f<=i;f++){u=t.getLine(f,!0),o.push(u);if(!s||(a=u.indexOf("//"))===-1)s=!1;else if(a!==0){var l;for(l=0;l<a;l++){var c=u.charCodeAt(l);if(c!==32&&c!==9)break}s=l===a}}var h,p,d,v=t.getLineStart(r),m=t.getLineEnd(i,!0);if(s){for(var g=0;g<o.length;g++)u=o[g],a=u.indexOf("//"),o[g]=u.substring(0,a)+u.substring(a+2);h=o.join("");var y=t.getLineStart(i);p=v===n.start?n.start:n.start-2,d=n.end-2*(i-r+1)+(n.end===y+1?2:0)}else o.splice(0,0,""),h=o.join("//"),p=v===n.start?n.start:n.start+2,d=n.end+2*(i-r+1);return e.setText(h,v,m),e.setSelection(p,d),!0}.bind(this),{name:e.toggleLineComment}),this.textView.setKeyBinding(new n.KeyBinding(191,!0,!a.isMac,!1,a.isMac),"addBlockComment"),this.textView.setAction("addBlockComment",function(){if(this.textView.getOptions("readonly"))return!1;var e=this.editor,n=e.getModel(),r=e.getSelection(),i="/*",s="*/",o=new RegExp("/\\*|\\*/","g"),u=t(n,r.start,r.end);if(u.commentStart!==undefined&&u.commentEnd!==undefined)return!0;var a=n.getText(r.start,r.end);if(a.length===0)return!0;var f=a.length;a=a.replace(o,"");var l=a.length;return e.setText(i+a+s,r.start,r.end),e.setSelection(r.start+i.length,r.end+i.length+(l-f)),!0}.bind(this),{name:e.addBlockComment}),this.textView.setKeyBinding(new n.KeyBinding(220,!0,!a.isMac,!1,a.isMac),"removeBlockComment"),this.textView.setAction("removeBlockComment",function(){if(this.textView.getOptions("readonly"))return!1;var e=this.editor,n=e.getModel(),r=e.getSelection(),i="/*",s="*/",o=n.getText(r.start,r.end),u,a,f;for(f=0;f<o.length;f++)if(o.substring(f,f+i.length)===i){u=r.start+f;break}for(;f<o.length;f++)if(o.substring(f,f+s.length)===s){a=r.start+f;break}if(u!==undefined&&a!==undefined)e.setText(n.getText(u+i.length,a),u,a+s.length),e.setSelection(u,a);else{var l=t(n,r.start,r.end);if(l.commentStart===undefined||l.commentEnd===undefined)return!0;var c=n.getText(l.commentStart+i.length,l.commentEnd);e.setText(c,l.commentStart,l.commentEnd+s.length),e.setSelection(r.start-i.length,r.end-s.length)}return!0}.bind(this),{name:e.removeBlockComment})},contentAssistProposalApplied:function(e){var t=e.data.proposal;if(t.positions&&this.linkedMode){var n=[];for(var r=0;r<t.positions.length;++r)n[r]={positions:[{offset:t.positions[r].offset,length:t.positions[r].length}]};var i={groups:n,escapePosition:t.escapePosition};this.linkedMode.enterLinkedMode(i)}else t.escapePosition&&this.textView.setCaretOffset(t.escapePosition);return!0},cancel:function(){return!1},isActive:function(){return!0},isStatusActive:function(){return!1},lineUp:function(){return!1},lineDown:function(){return!1},enter:function(){if(this.textView.getOptions("readonly"))return!1;var e=this.editor,t=e.getSelection();if(t.start===t.end){var n=e.getModel(),r=n.getLineAtOffset(t.start),i=n.getLine(r,!0),s=n.getLineStart(r),o=0,u=t.start-s,a;while(o<u&&((a=i.charCodeAt(o))===32||a===9))o++;if(o>0){var f=i.substring(0,o);o=u;while(o<i.length&&((a=i.charCodeAt(o++))===32||a===9))t.end++;return e.setText(n.getLineDelimiter()+f,t.start,t.end),!0}}return!1},tab:function(){return!1}},m.prototype={enterLinkedMode:function(t){if(this.linkedModeActive)return;this.linkedModeActive=!0,this.linkedModePositions=[];for(var r=0;r<t.groups.length;++r){var i=t.groups[r];this.linkedModePositions[r]={offset:i.positions[0].offset,length:i.positions[0].length}}this.linkedModeEscapePosition=t.escapePosition,this.linkedModeCurrentPositionIndex=0,this.selectTextForLinkedModePosition(this.linkedModePositions[this.linkedModeCurrentPositionIndex]),this.textView.addEventListener("Verify",this.linkedModeListener.onVerify),this.textView.setKeyBinding(new n.KeyBinding(9),"nextLinkedModePosition"),this.textView.setAction("nextLinkedModePosition",function(){return this.linkedModeCurrentPositionIndex=++this.linkedModeCurrentPositionIndex%this.linkedModePositions.length,this.selectTextForLinkedModePosition(this.linkedModePositions[this.linkedModeCurrentPositionIndex]),!0}.bind(this)),this.textView.setKeyBinding(new n.KeyBinding(9,!1,!0),"previousLinkedModePosition"),this.textView.setAction("previousLinkedModePosition",function(){return this.linkedModeCurrentPositionIndex=this.linkedModeCurrentPositionIndex>0?this.linkedModeCurrentPositionIndex-1:this.linkedModePositions.length-1,this.selectTextForLinkedModePosition(this.linkedModePositions[this.linkedModeCurrentPositionIndex]),!0}.bind(this)),this.editor.reportStatus(e.linkedModeEntered,null,!0)},isActive:function(){return this.linkedModeActive},isStatusActive:function(){return this.linkedModeActive},enter:function(){return this.cancel(),!0},cancel:function(t){if(!this.linkedModeActive)return;this.linkedModeActive=!1,this.textView.removeEventListener("Verify",this.linkedModeListener.onVerify),this.textView.setKeyBinding(new n.KeyBinding(9),"tab"),this.textView.setKeyBinding(new n.KeyBinding(9,!1,!0),"shiftTab"),t||this.textView.setCaretOffset(this.linkedModeEscapePosition,!1),this.editor.reportStatus(e.linkedModeExited,null,!0)},lineUp:function(){return this.cancel(!0),!1},lineDown:function(){return this.cancel(!0),!1},selectTextForLinkedModePosition:function(e){this.textView.setSelection(e.offset,e.offset+e.length)}},{UndoFactory:f,LineNumberRulerFactory:l,FoldingRulerFactory:c,AnnotationFactory:h,TextDNDFactory:p,TextActions:d,SourceCodeActions:v,LinkedMode:m}}),function(e,t){typeof define=="function"&&define.amd?define("orion/editor/Deferred",t):typeof exports=="object"?module.exports=t():(e.orion=e.orion||{},e.orion.Deferred=t())}(this,function(){function s(s){while(s)s(),n&&(e?t.next=n:e=n,t=r),e?(n=e.next,r=t,s=e.fn,e=t=null):s=null;i=!1}function o(n,r){if(i){e?(t.next={fn:n,next:null},t=t.next):(e={fn:n,next:null},t=e);return}i=!0,r?setTimeout(s.bind(null,n),0):s(n)}function u(e){return function(){e.apply(null,arguments)}}function a(e){var t=typeof e=="string"?new Error(e):new Error;return typeof e=="object"&&Object.keys(e).forEach(function(n){t[n]=e[n]}),t.canceled=!0,t.name="OperationCanceled",t}function f(){function s(e){n?r.next=e:n=e,r=e}function l(e){if(n===e){n=e.next||null,n===null&&(r=null);return}var t=n;while(t.next){if(t.next===e){e.next?t.next=e.next:(t.next=null,r=t);return}t=t.next}}function c(){while(n){var i=n;n=n.next;var s=i.deferred,o=t==="resolved"?"resolve":"reject";if(typeof i[o]=="function")try{var a=i[o](e);a&&typeof a.then=="function"?a.then(u(s.resolve),u(s.reject),s.progress):s.resolve(a)}catch(f){s.reject(f)}else s[o](e)}n=r=null}function h(e){if(t){if(e)throw new Error("already "+t);return!0}return!1}var e,t,n,r,i=this;this.reject=function(r,s){return h(s)||(t="rejected",e=r,n&&o(c)),i.promise},this.resolve=function(r,s){return h(s)||(t="resolved",e=r,n&&o(c)),i.promise},this.progress=function(e,t){if(!h(t)){var r=n;while(r)r.progress&&r.progress(e),r=r.next}return i.promise},this.cancel=function(e,t){h(t)||i.reject(a(e))},this.then=function(e,n,r){var i={resolve:e,reject:n,progress:r,deferred:new f};s(i),t&&o(c,!0);var h=i.deferred.promise;return h.cancel=function(e){if(t)return;l(i);var r=i.deferred;if(typeof n=="function")try{var s=n(a(e));s&&typeof s.then=="function"?s.then(u(r.resolve),u(r.reject),r.progress):r.resolve(s)}catch(o){r.reject(o)}else r.cancel(e)},h},this.promise={then:this.then,cancel:this.cancel}}var e,t,n,r,i=!1;return f.all=function(e,t){function o(e,t){i||(r[e]=t,--n===0&&s.resolve(r))}function u(e,n){if(!i){if(t)try{o(e,t(n));return}catch(r){n=r}s.reject(n)}}var n=e.length,r=[],i=!1,s=new f;return s.then(null,function(){i=!0,e.forEach(function(e){e.cancel&&e.cancel()})}),n===0?s.resolve(r):e.forEach(function(e,t){e.then(o.bind(null,t),u.bind(null,t))}),s.promise},f.when=function(e,t,n,r){var i,s;return e&&typeof e.then=="function"?i=e:(s=new f,s.resolve(e),i=s.promise),i.then(t,n,r)},f}),define("orion/editor/contentAssist",["i18n!orion/editor/nls/messages","orion/editor/keyBinding","orion/editor/eventTarget","orion/editor/Deferred","orion/editor/util"],function(e,t,n,r,i){function u(n){this.textView=n,this.state=s.INACTIVE,this.providers=[];var r=this;this.contentAssistListener={onModelChanging:function(e){r.isDeactivatingChange(e)?r.setState(s.INACTIVE):r.state===s.ACTIVE&&r.setState(s.FILTERING)},onScroll:function(e){r.setState(s.INACTIVE)},onSelection:function(e){var t=r.state;if(t===s.ACTIVE||t===s.FILTERING)r.computeProposals(),r.setState(s.FILTERING)}},n.setKeyBinding(i.isMac?new t.KeyBinding(" ",!1,!1,!1,!0):new t.KeyBinding(" ",!0),"contentAssist"),n.setAction("contentAssist",function(){return r.activate(),!0},{name:e.contentAssist})}function a(e,t){this.contentAssist=e,this.widget=t,this.proposals=[];var n=this;this.contentAssist.addEventListener("ProposalsComputed",function(e){n.proposals=e.data.proposals,n.selectedIndex=n.proposals.length?0:-1})}function f(e,t){this.contentAssist=e,this.textView=this.contentAssist.getTextView(),this.textViewListenerAdded=!1,this.isShowing=!1;var n=this.textView.getOptions("parent").ownerDocument;this.parentNode=typeof t=="string"?n.getElementById(t):t;if(!this.parentNode){this.parentNode=i.createElement(n,"div"),this.parentNode.className="contentassist";var r=n.getElementsByTagName("body")[0];if(!r)throw new Error("parentNode is required");r.appendChild(this.parentNode)}var s=this;this.textViewListener={onMouseDown:function(e){e.event.target.parentElement!==s.parentNode&&s.contentAssist.deactivate()}},this.contentAssist.addEventListener("ProposalsComputed",function(e){s.setProposals(e.data.proposals),s.show(),s.textViewListenerAdded||(s.textView.addEventListener("MouseDown",s.textViewListener.onMouseDown),s.textViewListenerAdded=!0)}),this.contentAssist.addEventListener("Deactivating",function(e){s.setProposals([]),s.hide(),s.textViewListenerAdded&&(s.textView.removeEventListener("MouseDown",s.textViewListener.onMouseDown),s.textViewListenerAdded=!1),s.textViewListenerAdded=!1}),this.scrollListener=function(e){s.isShowing&&s.position()},n.addEventListener("scroll",this.scrollListener)}var s={INACTIVE:1,ACTIVE:2,FILTERING:3},o={selected:" selected",hr:"proposal-hr",emphasis:"proposal-emphasis",noemphasis:"proposal-noemphasis",dfault:"proposal-default"};return u.prototype={apply:function(e){if(!e)return!1;var t=this.textView.getCaretOffset(),n={proposal:e,start:t,end:t};this.setState(s.INACTIVE);var r=e.proposal||e;return this.textView.setText(r,t,t),this.dispatchEvent({type:"ProposalApplied",data:n}),!0},activate:function(){this.state===s.INACTIVE&&this.setState(s.ACTIVE)},deactivate:function(){this.setState(s.INACTIVE)},getTextView:function(){return this.textView},isActive:function(){return this.state===s.ACTIVE||this.state===s.FILTERING},isDeactivatingChange:function(e){var t=e.removedCharCount>0&&e.addedCharCount===0,n=this.textView,r=e.start+1<=n.getModel().getCharCount()&&/^\s*$/.test(n.getText(e.start,e.start+1));return e.removedLineCount>0||e.addedLineCount>0||t&&r},setState:function(e){var t;e===s.ACTIVE?t="Activating":e===s.INACTIVE&&(t="Deactivating"),t&&this.dispatchEvent({type:t}),this.state=e,this.onStateChange(e)},onStateChange:function(e){e===s.INACTIVE?this.listenerAdded&&(this.textView.removeEventListener("ModelChanging",this.contentAssistListener.onModelChanging),this.textView.removeEventListener("Scroll",this.contentAssistListener.onScroll),this.textView.removeEventListener("Selection",this.contentAssistListener.onSelection),this.listenerAdded=!1):e===s.ACTIVE&&(this.listenerAdded||(this.textView.addEventListener("ModelChanging",this.contentAssistListener.onModelChanging),this.textView.addEventListener("Scroll",this.contentAssistListener.onScroll),this.textView.addEventListener("Selection",this.contentAssistListener.onSelection),this.listenerAdded=!0),this.computeProposals())},computeProposals:function(){var e=this,t=this.textView.getCaretOffset();this._computeProposals(t).then(function(t){e.dispatchEvent({type:"ProposalsComputed",data:{proposals:t}})})},getPrefixStart:function(e){var t=e;while(t>0&&/[A-Za-z0-9_]/.test(this.textView.getText(t-1,t)))t--;return t},handleError:function(e){typeof console!="undefined"&&(console.log("Error retrieving content assist proposals"),console.log(e))},_computeProposals:function(e){var t=this.providers,n=this.textView,i=n.getModel(),s=n.getText(),o={line:i.getLine(i.getLineAtOffset(e)),prefix:n.getText(this.getPrefixStart(e),e),selection:n.getSelection()},u=this,a=t.map(function(t){var n=t.computeProposals||t.getProposals,i;try{typeof n=="function"&&(i=u.progress?u.progress.progress(n.apply(t,[s,e,o]),"Generating content assist proposal"):n.apply(t,[s,e,o]))}catch(a){u.handleError(a)}return r.when(i)});return r.all(a,this.handleError).then(function(e){return e.reduce(function(e,t){return t instanceof Array?e.concat(t):e},[])})},setProviders:function(e){this.providers=e.slice(0)},setProgress:function(e){this.progress=e}},n.EventTarget.addMixin(u.prototype),a.prototype={cancel:function(){this.getContentAssist().deactivate()},getContentAssist:function(){return this.contentAssist},isActive:function(){return this.getContentAssist().isActive()},lineUp:function(){var e=this.selectedIndex===0?this.proposals.length-1:this.selectedIndex-1;while(this.proposals[e].unselectable&&e>0)e--;return this.selectedIndex=e,this.widget&&this.widget.setSelectedIndex(this.selectedIndex),!0},lineDown:function(){var e=this.selectedIndex===this.proposals.length-1?0:this.selectedIndex+1;while(this.proposals[e].unselectable&&e<this.proposals.length-1)e++;return this.selectedIndex=e,this.widget&&this.widget.setSelectedIndex(this.selectedIndex),!0},enter:function(){var e=this.proposals[this.selectedIndex]||null;return this.contentAssist.apply(e)},tab:function(){return this.widget?(this.widget.createAccessible(this),this.widget.parentNode.focus(),!0):!1}},f.prototype={onClick:function(e){this.contentAssist.apply(this.getProposal(e.target)),this.textView.focus()},createDiv:function(e,t,n,r){var s=n.ownerDocument,o=i.createElement(s,"div");o.id="contentoption"+r,o.setAttribute("role","option");var u;e.style==="hr"?u=i.createElement(s,"hr"):(o.className=this.calculateClasses(e.style,t),u=s.createTextNode(this.getDisplayString(e)),t&&this.parentNode.setAttribute("aria-activedescendant",o.id)),o.appendChild(u,o),n.appendChild(o)},createAccessible:function(e){this._isAccessible||this.parentNode.addEventListener("keydown",function(t){return t.preventDefault(),t.keyCode===27?e.cancel():t.keyCode===38?e.lineUp():t.keyCode===40?e.lineDown():t.keyCode===13?e.enter():!1}),this._isAccessible=!0},calculateClasses:function(e,t){var n=o[e];return n||(n=o.dfault),t?n+o.selected:n},getDisplayString:function(e){return typeof e=="string"?e:e.description&&typeof e.description=="string"?e.description:e.proposal},getProposal:function(e){var t=0;for(var n=this.parentNode.firstChild;n!==null;n=n.nextSibling){if(n===e)return this.proposals[t]||null;t++}return null},setSelectedIndex:function(e){this.selectedIndex=e,this.selectNode(this.parentNode.childNodes[this.selectedIndex])},selectNode:function(e){var t=this.parentNode.childNodes;for(var n=0;n<t.length;n++){var r=t[n],i=r.className.indexOf(o.selected);i>=0&&(r.className=r.className.substring(0,i)+r.className.substring(i+o.selected.length)),r===e&&(r.className=r.className+o.selected,this.parentNode.setAttribute("aria-activedescendant",r.id),r.focus(),r.offsetTop<this.parentNode.scrollTop?r.scrollIntoView(!0):r.offsetTop+r.offsetHeight>this.parentNode.scrollTop+this.parentNode.clientHeight&&r.scrollIntoView(!1))}},setProposals:function(e){this.proposals=e},show:function(){if(this.proposals.length===0){this.hide();return}this.parentNode.innerHTML="";for(var e=0;e<this.proposals.length;e++)this.createDiv(this.proposals[e],e===0,this.parentNode,e);this.position(),this.parentNode.onclick=this.onClick.bind(this),this.isShowing=!0},hide:function(){this.parentNode.ownerDocument.activeElement===this.parentNode&&this.textView.focus(),this.parentNode.style.display="none",this.parentNode.onclick=null,this.isShowing=!1},position:function(){var e=this.textView.getLocationAtOffset(this.textView.getCaretOffset());e.y+=this.textView.getLineHeight(),this.textView.convert(e,"document","page"),this.parentNode.style.position="fixed",this.parentNode.style.left=e.x+"px",this.parentNode.style.top=e.y+"px",this.parentNode.style.display="block",this.parentNode.scrollTop=0;var t=this.parentNode.ownerDocument,n=t.documentElement.clientWidth,r=t.documentElement.clientHeight;e.y+this.parentNode.offsetHeight>r&&(this.parentNode.style.top=e.y-this.parentNode.offsetHeight-this.textView.getLineHeight()+"px"),e.x+this.parentNode.offsetWidth>n&&(this.parentNode.style.left=n-this.parentNode.offsetWidth+"px")}},{ContentAssist:u,ContentAssistMode:a,ContentAssistWidget:f}}),define("orion/editor/cssContentAssist",[],function(){function t(e,t){var n=t;while(n&&/[A-Za-z\-]/.test(e.charAt(n-1)))n--;return n?e.substring(n,t):""}function n(){}var e=["alignment-adjust","alignment-baseline","animation","animation-delay","animation-direction","animation-duration","animation-iteration-count","animation-name","animation-play-state","animation-timing-function","appearance","azimuth","backface-visibility","background","background-attachment","background-clip","background-color","background-image","background-origin","background-position","background-repeat","background-size","baseline-shift","binding","bleed","bookmark-label","bookmark-level","bookmark-state","bookmark-target","border","border-bottom","border-bottom-color","border-bottom-left-radius","border-bottom-right-radius","border-bottom-style","border-bottom-width","border-collapse","border-color","border-image","border-image-outset","border-image-repeat","border-image-slice","border-image-source","border-image-width","border-left","border-left-color","border-left-style","border-left-width","border-radius","border-right","border-right-color","border-right-style","border-right-width","border-spacing","border-style","border-top","border-top-color","border-top-left-radius","border-top-right-radius","border-top-style","border-top-width","border-width","bottom","box-align","box-decoration-break","box-direction","box-flex","box-flex-group","box-lines","box-ordinal-group","box-orient","box-pack","box-shadow","box-sizing","break-after","break-before","break-inside","caption-side","clear","clip","color","color-profile","column-count","column-fill","column-gap","column-rule","column-rule-color","column-rule-style","column-rule-width","column-span","column-width","columns","content","counter-increment","counter-reset","crop","cue","cue-after","cue-before","cursor","direction","display","dominant-baseline","drop-initial-after-adjust","drop-initial-after-align","drop-initial-before-adjust","drop-initial-before-align","drop-initial-size","drop-initial-value","elevation","empty-cells","fit","fit-position","flex-align","flex-flow","flex-inline-pack","flex-order","flex-pack","float","float-offset","font","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","grid-columns","grid-rows","hanging-punctuation","height","hyphenate-after","hyphenate-before","hyphenate-character","hyphenate-lines","hyphenate-resource","hyphens","icon","image-orientation","image-rendering","image-resolution","inline-box-align","left","letter-spacing","line-height","line-stacking","line-stacking-ruby","line-stacking-shift","line-stacking-strategy","list-style","list-style-image","list-style-position","list-style-type","margin","margin-bottom","margin-left","margin-right","margin-top","mark","mark-after","mark-before","marker-offset","marks","marquee-direction","marquee-loop","marquee-play-count","marquee-speed","marquee-style","max-height","max-width","min-height","min-width","move-to","nav-down","nav-index","nav-left","nav-right","nav-up","opacity","orphans","outline","outline-color","outline-offset","outline-style","outline-width","overflow","overflow-style","overflow-x","overflow-y","padding","padding-bottom","padding-left","padding-right","padding-top","page","page-break-after","page-break-before","page-break-inside","page-policy","pause","pause-after","pause-before","perspective","perspective-origin","phonemes","pitch","pitch-range","play-during","position","presentation-level","punctuation-trim","quotes","rendering-intent","resize","rest","rest-after","rest-before","richness","right","rotation","rotation-point","ruby-align","ruby-overhang","ruby-position","ruby-span","size","speak","speak-header","speak-numeral","speak-punctuation","speech-rate","stress","string-set","table-layout","target","target-name","target-new","target-position","text-align","text-align-last","text-decoration","text-emphasis","text-height","text-indent","text-justify","text-outline","text-shadow","text-transform","text-wrap","top","transform","transform-origin","transform-style","transition","transition-delay","transition-duration","transition-property","transition-timing-function","unicode-bidi","vertical-align","visibility","voice-balance","voice-duration","voice-family","voice-pitch","voice-pitch-range","voice-rate","voice-stress","voice-volume","volume","white-space","white-space-collapse","widows","width","word-break","word-spacing","word-wrap","z-index"];return n.prototype={computeProposals:function(n,r,i){var s=t(n,r),o=[];for(var u=0;u<e.length;u++){var a=e[u];a.indexOf(s)===0&&o.push({proposal:a.substring(s.length),description:a})}return o}},{CssContentAssistProvider:n}}),define("orion/editor/htmlContentAssist",[],function(){function e(){}return e.prototype={leadingWhitespace:function(e,t){var n="";t-=1;while(t>0){var r=e.charAt(t--);if(r==="\n"||r==="\r")break;/\s/.test(r)?n=r.concat(n):n=""}return n},computeProposals:function(e,t,n){function r(e){return e.substring(n.prefix.length)}var i=[];if(e.length===0){var s='<!DOCTYPE html>\n<html lang="en">\n	<head>\n		<meta charset=utf-8>\n		<title>My Document</title>\n	</head>\n	<body>\n		<h1>A basic HTML document</h1>\n		<p>\n			\n		</p>\n	</body>\n</html>';return i.push({proposal:s,description:"Simple HTML document",escapePosition:t+152}),i}var o=n.prefix,u=e.charAt(t-o.length-1);if(u!=="<")return i;var a,f,l,c,h=["abbr","b","button","canvas","cite","command","dd","del","dfn","dt","em","embed","font","h1","h2","h3","h4","h5","h6","i","ins","kbd","label","li","mark","meter","object","option","output","progress","q","rp","rt","samp","small","strong","sub","sup","td","time","title","tt","u","var"];for(var p=0;p<h.length;p++)a=h[p],a.indexOf(o)===0&&(f=a+"></"+a+">",c=t+a.length-o.length+1,i.push({proposal:r(f),description:"<"+f,escapePosition:c}));var d=["address","article","aside","audio","bdo","blockquote","body","caption","code","colgroup","datalist","details","div","fieldset","figure","footer","form","head","header","hgroup","iframe","legend","map","menu","nav","noframes","noscript","optgroup","p","pre","ruby","script","section","select","span","style","tbody","textarea","tfoot","th","thead","tr","video"],v=this.leadingWhitespace(e,t);for(p=0;p<d.length;p++)a=d[p],a.indexOf(o)===0&&(f=a+">\n"+v+"	\n"+v+"</"+a+">",c=t+a.length-o.length+v.length+3,i.push({proposal:r(f),description:"<"+f,escapePosition:c}));var m=["area","base","br","col","hr","input","link","meta","param","keygen","source"];for(p=0;p<m.length;p++)a=m[p],a.indexOf(o)===0&&(f=a+"/>",c=t+a.length-o.length+2,i.push({proposal:r(f),description:"<"+f,escapePosition:c}));return"img".indexOf(o)===0&&(f='img src="" alt="Image"/>',i.push({proposal:r(f),description:"<"+f,escapePosition:t+9-o.length})),o==="a"&&i.push({proposal:r('a href=""></a>'),description:"<a></a> - HTML anchor element",escapePosition:t+7}),"ul".indexOf(o)===0&&(f="ul>\n"+v+"	<li></li>\n"+v+"</ul>",l="<ul> - unordered list",c=t-o.length+v.length+9,i.push({proposal:r(f),description:l,escapePosition:c})),"ol".indexOf(o)===0&&(f="ol>\n"+v+"	<li></li>\n"+v+"</ol>",l="<ol> - ordered list",c=t-o.length+v.length+9,i.push({proposal:r(f),description:l,escapePosition:c})),"dl".indexOf(o)===0&&(f="dl>\n"+v+"	<dt></dt>\n"+v+"	<dd></dd>\n"+v+"</dl>",l="<dl> - definition list",c=t-o.length+v.length+9,i.push({proposal:r(f),description:l,escapePosition:c})),"table".indexOf(o)===0&&(f="table>\n"+v+"	<tr>\n"+v+"		<td></td>\n"+v+"	</tr>\n"+v+"</table>",l="<table> - basic HTML table",c=t-o.length+v.length*2+19,i.push({proposal:r(f),description:l,escapePosition:c})),i}},{HTMLContentAssistProvider:e}}),define("orion/editor/jsTemplateContentAssist",[],function(){function e(e,t){var n="";t-=1;while(t>0){var r=e.charAt(t--);if(r==="\n"||r==="\r")break;/\s/.test(r)?n=r.concat(n):n=""}return n}function t(e,t){var n="";while(t>=0){n=e[t];if(n==="\n"||n==="\r")break;if(!/\s/.test(n))break;t--}return n}function r(e,r,i){var s=t(r,i-e.length-1);return!n[s]}function i(e,t){return t.substring(e.length)}function s(t,n,r){var s=r-t.length,o=[],u=e(n,r),a,f,l,c;return"if".indexOf(t)===0&&(a="if (condition) {\n"+u+"	\n"+u+"}",f="if - if statement",l=[{offset:s+4,length:9}],c=s+u.length+18,o.push({proposal:i(t,a),description:f,positions:l,escapePosition:c}),a="if (condition) {\n"+u+"	\n"+u+"} else {\n"+u+"	\n"+u+"}",f="if - if else statement",l=[{offset:s+4,length:9}],c=s+u.length+18,o.push({proposal:i(t,a),description:f,positions:l,escapePosition:c})),"for".indexOf(t)===0&&(a="for (var i = 0; i < array.length; i++) {\n"+u+"	\n"+u+"}",f="for - iterate over array",l=[{offset:s+9,length:1},{offset:s+20,length:5}],c=s+u.length+42,o.push({proposal:i(t,a),description:f,positions:l,escapePosition:c}),a="for (var property in object) {\n"+u+"	if (object.hasOwnProperty(property)) {\n"+u+"		\n"+u+"	}\n"+u+"}",f="for..in - iterate over properties of an object",l=[{offset:s+9,length:8},{offset:s+21,length:6}],c=s+2*u.length+73,o.push({proposal:i(t,a),description:f,positions:l,escapePosition:c})),"while".indexOf(t)===0&&(a="while (condition) {\n"+u+"	\n"+u+"}",f="while - while loop with condition",l=[{offset:s+7,length:9}],c=s+u.length+21,o.push({proposal:i(t,a),description:f,positions:l,escapePosition:c})),"do".indexOf(t)===0&&(a="do {\n"+u+"	\n"+u+"} while (condition);",f="do - do while loop with condition",l=[{offset:s+16,length:9}],c=s+u.length+6,o.push({proposal:i(t,a),description:f,positions:l,escapePosition:c})),"switch".indexOf(t)===0&&(a="switch (expression) {\n"+u+"	case value1:\n"+u+"		\n"+u+"		break;\n"+u+"	default:\n"+u+"}",f="switch - switch case statement",l=[{offset:s+8,length:10},{offset:s+28,length:6}],c=s+2*u.length+38,o.push({proposal:i(t,a),description:f,positions:l,escapePosition:c})),"try".indexOf(t)===0&&(a="try {\n"+u+"	\n"+u+"} catch (err) {\n"+u+"}",f="try - try..catch statement",c=s+u.length+7,o.push({proposal:i(t,a),description:f,escapePosition:c}),a="try {\n"+u+"	\n"+u+"} catch (err) {\n"+u+"} finally {\n"+u+"}",f="try - try..catch statement with finally block",c=s+u.length+7,o.push({proposal:i(t,a),description:f,escapePosition:c})),o}function o(e,t,n){var r=["break","case","catch","continue","debugger","default","delete","do","else","finally","for","function","if","in","instanceof","new","return","switch","this","throw","try","typeof","var","void","while","with"],s=[];for(var o=0;o<r.length;o++)r[o].indexOf(e)===0&&s.push({proposal:i(e,r[o]),description:r[o]});return s}function u(){}var n={":":":","!":"!","@":"@","#":"#",$:"$","^":"^","&":"&","*":"*",".":".","?":"?","<":"<",">":">"};return u.prototype={computeProposals:function(e,t,n){var i=n.prefix,u=[];return r(i,e,t)?(u=u.concat(s(i,e,t)),u=u.concat(o(i,e,t)),u):u}},{JSTemplateContentAssistProvider:u}}),define("orion/editor/AsyncStyler",["i18n!orion/editor/nls/messages","orion/editor/annotations"],function(e,t){function s(e){return e.getProperty("objectClass").indexOf(n)!==-1&&e.getProperty("type")==="highlighter"}function o(e,t,n){this.initialize(e,t,n),this.lineStyles=[]}var n="orion.edit.highlighter",r="orion.annotation.highlightError",i=n+" service must be an event emitter";return t.AnnotationType.registerType(r,{title:e.syntaxError,html:"<div class='annotationHTML error'></div>",rangeStyle:{styleClass:"annotationRange error"}}),o.prototype={initialize:function(e,t,r){this.textView=e,this.serviceRegistry=t,this.annotationModel=r,this.services=[];var i=this;this.listener={onModelChanging:function(e){i.onModelChanging(e)},onModelChanged:function(e){i.onModelChanged(e)},onDestroy:function(e){i.onDestroy(e)},onLineStyle:function(e){i.onLineStyle(e)},onStyleReady:function(e){i.onStyleReady(e)},onServiceAdded:function(e){i.onServiceAdded(e.serviceReference,i.serviceRegistry.getService(e.serviceReference))},onServiceRemoved:function(e){i.onServiceRemoved(e.serviceReference,i.serviceRegistry.getService(e.serviceReference))}},e.addEventListener("ModelChanging",this.listener.onModelChanging),e.addEventListener("ModelChanged",this.listener.onModelChanged),e.addEventListener("Destroy",this.listener.onDestroy),e.addEventListener("LineStyle",this.listener.onLineStyle),t.addEventListener("registered",this.listener.onServiceAdded),t.addEventListener("unregistering",this.listener.onServiceRemoved);var o=t.getServiceReferences(n);for(var u=0;u<o.length;u++){var a=o[u];s(a)&&this.addServiceListener(t.getService(a))}},onDestroy:function(e){this.destroy()},destroy:function(){this.textView&&(this.textView.removeEventListener("ModelChanging",this.listener.onModelChanging),this.textView.removeEventListener("ModelChanged",this.listener.onModelChanged),this.textView.removeEventListener("Destroy",this.listener.onDestroy),this.textView.removeEventListener("LineStyle",this.listener.onLineStyle),this.textView=null);if(this.services){for(var e=0;e<this.services.length;e++)this.removeServiceListener(this.services[e]);this.services=null}this.serviceRegistry&&(this.serviceRegistry.removeEventListener("registered",this.listener.onServiceAdded),this.serviceRegistry.removeEventListener("unregistering",this.listener.onServiceRemoved),this.serviceRegistry=null),this.listener=null,this.lineStyles=null},onModelChanging:function(e){this.startLine=this.textView.getModel().getLineAtOffset(e.start)},onModelChanged:function(e){var t=this.startLine;(e.addedLineCount||e.removedLineCount)&&Array.prototype.splice.apply(this.lineStyles,[t,e.removedLineCount].concat(this._getEmptyStyle(e.addedLineCount)))},onStyleReady:function(e){var n=e.lineStyles||e.style,i=Number.MAX_VALUE,s=-1,o=this.textView.getModel();for(var u in n)n.hasOwnProperty(u)&&(this.lineStyles[u]=n[u],i=Math.min(i,u),s=Math.max(s,u));i=Math.max(i,0),s=Math.min(s,o.getLineCount());var a=this.annotationModel;if(a){var f=a.getAnnotations(o.getLineStart(i),o.getLineEnd(s)),l=[];while(f.hasNext()){var c=f.next();c.type===r&&l.push(c)}var h=[];for(var p=i;p<=s;p++){u=p;var d=this.lineStyles[u],v=d&&d.errors,m=o.getLineStart(u);if(v)for(var g=0;g<v.length;g++){var y=v[g];h.push(t.AnnotationType.createAnnotation(r,y.start+m,y.end+m))}}a.replaceAnnotations(l,h)}this.textView.redrawLines(i,s+1)},onLineStyle:function(e){function t(e,t){var n=e.length,r=[];for(var i=0;i<n;i++){var s=e[i];r.push({start:s.start+t,end:s.end+t,style:s.style})}return r}var n=this.lineStyles[e.lineIndex];n&&(n.ranges?e.ranges=t(n.ranges,e.lineStart):n.style&&(e.style=n.style))},_getEmptyStyle:function(e){var t=[];for(var n=0;n<e;n++)t.push(null);return t},setContentType:function(e){this.contentType=e;if(this.services)for(var t=0;t<this.services.length;t++){var n=this.services[t];if(n.setContentType){var r=this.serviceRegistry.getService("orion.page.progress");r?r.progress(n.setContentType(this.contentType),"Styling content type: "+this.contentType.id?this.contentType.id:this.contentType):n.setContentType(this.contentType)}}},onServiceAdded:function(e,t){s(e)&&this.addServiceListener(t)},onServiceRemoved:function(e,t){this.services.indexOf(t)!==-1&&this.removeServiceListener(t)},addServiceListener:function(e){if(typeof e.addEventListener=="function"){e.addEventListener("orion.edit.highlighter.styleReady",this.listener.onStyleReady),this.services.push(e);if(e.setContentType&&this.contentType){var t=this.serviceRegistry.getService("orion.page.progress");t?t.progress(e.setContentType(this.contentType),"Styling content type: "+this.contentType.id?this.contentType.id:this.contentType):e.setContentType(this.contentType)}}else typeof console!="undefined"&&console.log(new Error(i))},removeServiceListener:function(e){if(typeof e.removeEventListener=="function"){e.removeEventListener("orion.edit.highlighter.styleReady",this.listener.onStyleReady);var t=this.services.indexOf(e);t!==-1&&this.services.splice(t,1)}else typeof console!="undefined"&&console.log(new Error(i))}},o}),define("orion/editor/mirror",["i18n!orion/editor/nls/messages","orion/editor/eventTarget","orion/editor/annotations"],function(e,t,n){function i(e){this.string=e,this.pos=0,this.tokenStart=0}function s(e){this._modes={},this.mimeModes={},this.options={},this.StringStream=i}function o(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t}function u(e,t,n){n=n||{},this.model=e,this.codeMirror=t,this.isWhitespaceVisible=typeof n.whitespacesVisible=="undefined"?!1:n.whitespacesVisible,this.mode=null,this.isModeLoaded=!1,this.lines=[],this.dirtyLines=[],this.startLine=Number.MAX_VALUE,this.endLine=-1,this.timer=null,this.initialize(e)}function v(e,t,n){this.init(e,t,n)}var r=4;i.prototype={eol:function(){return this.pos>=this.string.length},sol:function(){return this.pos===0},peek:function(){return this.string[this.pos]},next:function(){return this.string[this.pos++]},eat:function(e){var t=this.string[this.pos],n=typeof t=="string"&&(t===e||e.test&&e.test(t)||typeof e=="function"&&e(t));return n?this.string[this.pos++]:undefined},eatWhile:function(e){var t=!1;while(this.eat(e)!==undefined)t=!0;return t},eatSpace:function(){return this.eatWhile(/\s/)},skipToEnd:function(){this.pos=this.string.length},skipTo:function(e){var t=this.string.indexOf(e,this.pos);return t!==-1?(this.pos=t,!0):!1},match:function(e,t,n){t=t===!0||typeof t=="undefined";if(typeof e=="string"){var r=n?this.string.toLowerCase():this.string;e=n?e.toLowerCase():e;var i=r.indexOf(e,this.pos);return i!==-1&&t&&(this.pos=i+e.length),i!==-1}var s=this.string.substring(this.pos).match(e);return s&&t&&typeof s[0]=="string"&&(this.pos+=s.index+s[0].length),s},backUp:function(e){this.pos-=e},column:function(){var e=0,t=0;while(t<this.tokenStart)e+=this.string[t++]==="	"?r:1;return e},indentation:function(){var e=this.string.search(/\S/),t=0,n=0;while(n<e)t+=this.string[n++]==="	"?r:1;return t},current:function(){return this.string.substring(this.tokenStart,this.pos)},advance:function(){this.tokenStart=this.pos}},s.prototype={options:{},setOption:function(e,t){this.options[e]=t},getOption:function(e){return this.options[e]},copyState:function(e,t){if(typeof e.copyState=="function")return e.copyState(t);var n={};for(var r in t){var i=t[r];n[r]=i instanceof Array?i.slice():i}return n},defineMode:function(e,t){this._modes[e]=t},defineMIME:function(e,t){this.mimeModes[e]=t},getMode:function(e,t){var n={},r;typeof t=="string"&&this.mimeModes[t]&&(t=this.mimeModes[t]),typeof t=="object"&&(n=t,r=this._modes[t.name]),r=r||this._modes[t];if(typeof r!="function")throw"Mode not found "+t;return r(e,n)},listModes:function(){return o(this._modes)},listMIMEs:function(){return o(this.mimeModes)},_getModeName:function(e){var t=this.mimeModes[e];return typeof t=="object"&&(t=t.name),t}};var a="token_tab",f="token_space",l=500,c=50,h=30,p=3,d=40;u.prototype={initialize:function(e){var t=this;this.listener={onModelChanging:function(e){t._onModelChanging(e)},onModelChanged:function(e){t._onModelChanged(e)},onDestroy:function(e){t._onDestroy(e)}},this.model.addEventListener("Changing",this.listener.onModelChanging),this.model.addEventListener("Changed",this.listener.onModelChanged),this.model.addEventListener("Destroy",this.listener.onDestroy)},destroy:function(){this.model&&(this.model.removeEventListener("Changing",this.listener.onModelChanging),this.model.removeEventListener("Changed",this.listener.onModelChanged),this.model.removeEventListener("Destroy",this.listener.onDestroy)),this.model=null,this.codeMirror=null,this.mode=null,this.lines=null,this.dirtyLines=null,clearTimeout(this.timer),this.timer=null},_onModelChanging:function(e){this.startLine=this.model.getLineAtOffset(e.start)},_onModelChanged:function(e){this._dbgEvent(e);var t=this.startLine;(e.removedLineCount||e.addedLineCount)&&Array.prototype.splice.apply(this.lines,[t+1,e.removedLineCount].concat(this._newLines(e.addedLineCount)));if(!this.mode)return;var n=Math.max(e.addedLineCount,e.removedLineCount),r=t+Math.min(n,l);this.highlight(t,r),this.highlightLater(r+1)},_onDestroy:function(e){this.destroy()},setViewportIndex:function(e){this.viewportIndex=e},_dbgEvent:function(e){},_dbgStyle:function(){},_newLines:function(e,t){typeof t=="undefined"&&(t=0);var n=[];for(var r=0;r<e;r++)n.push({style:null,eolState:null});return n},setMode:function(e,t){if(!e)return;this.mode=this.codeMirror.getMode(this.codeMirror.options,e),this.lines=this._newLines(this.model.getLineCount()),t&&this.highlight()},highlight:function(e,t,n){if(!this.mode)return;var r=this.model.getLineCount();e=typeof e=="undefined"?0:e,t=typeof t=="undefined"?r-1:Math.min(t,r-1);var i=this.mode,s=this.getState(e);for(var o=e;o<=t;o++){var u=this.lines[o];this.highlightLine(o,u,s),u.eolState=this.codeMirror.copyState(i,s)}this._expandRange(e,t),n||this.onHighlightDone()},highlightLater:function(e){this.dirtyLines.push(e);var t=this;this.timer=setTimeout(function(){t._highlightJob()},c)},_highlightJob:function(){var e=+(new Date)+h,t=this.mode.compareStates,n=this.model.getLineCount();while(this.dirtyLines.length){var r=this.viewportIndex,i=this.lines[r],s;i&&!i.eolState?s=r:s=this.dirtyLines.pop();if(s>=n)break;this._expandRange(s,s);var o=this._getResumeLineIndex(s),u=o+1,a=o>=0&&this.lines[o].eolState;a=a?this.codeMirror.copyState(this.mode,a):this.mode.startState();var f=0;for(var l=u;l<n;l++){var c=this.lines[l],d=c.eolState,v=this.highlightLine(l,c,a);c.eolState=this.codeMirror.copyState(this.mode,a),v&&this._expandRange(u,l+1);var m=t&&d&&t(d,c.eolState),g=!t&&!v&&f++>p;if(m||g)break;if(!d||v)f=0;var y=l<n||this.dirtyLines.length,b=+(new Date)>e&&y;if(b){this.highlightLater(l+1),this.onHighlightDone();return}}}this.onHighlightDone()},onHighlightDone:function(){this.startLine!==Number.MAX_VALUE&&this.endLine!==-1&&this.dispatchEvent({type:"Highlight",start:this.startLine,end:this.endLine}),this.startLine=Number.MAX_VALUE,this.endLine=-1},_getResumeLineIndex:function(e){var t=this.lines;for(var n=e-1;n>=0;n--)if(t[n].eolState||e-n>d)return n;return-1},getState:function(e){var t=this.mode,n=this.lines,r,i;for(r=e-1;r>=0;r--){i=n[r];if(i.eolState||e-r>d)break}var s=r>=0&&n[r].eolState;if(s){s=this.codeMirror.copyState(t,s),r=Math.max(0,r);for(var o=r;o<e-1;o++)i=n[o],this.highlightLine(o,i,s),i.eolState=this.codeMirror.copyState(t,s);return s}return t.startState()},highlightLine:function(e,t,n){if(!this.mode)return;var r=this.model;r.getLineStart(e)===r.getLineEnd(e)&&this.mode.blankLine&&this.mode.blankLine(n);var s=t.style||[],o=r.getLine(e),u=new i(o),a=!t.style,f=[],l;for(var c=0;!u.eol();c++){var h=this.mode.token(u,n)||null,p=u.current();l=this._whitespaceStyle(h,p,u.tokenStart),l;var d=[u.tokenStart,u.pos,h],v=s[c];f.push(d),a=a||!v||v[0]!==d[0]||v[1]!==d[1]||v[2]!==d[2],u.advance()}return a=a||f.length!==s.length,a&&(t.style=f.length?f:null),a},_whitespaceStyle:function(e,t,n){if(!e&&this.isWhitespaceVisible&&/\s+/.test(t)){var r=[],i,s;for(var o=0;o<t.length;o++){var u=t[o];u!==s&&(s&&r.push([n+i,n+o,s==="	"?a:f]),i=o,s=u)}return r.push([n+i,n+o,s==="	"?a:f]),r}return null},_expandRange:function(e,t){this.startLine=Math.min(this.startLine,e),this.endLine=Math.max(this.endLine,t)},toStyleRangesAndErrors:function(e,t){function n(e){return e?e===a||e===f?e:"cm-"+e:null}var r=e.style;if(!r)return null;var i=[],s=[],o=typeof t=="undefined"?0:this.model.getLineStart(t);for(var u=0;u<r.length;u++){var l=r[u],c=n(l[2]);if(!c)continue;var h={start:o+l[0],end:o+l[1],style:{styleClass:c}};i.push(h),c==="cm-error"&&s.push(h)}return[i,s]},getLineStyle:function(e){return this.lines[e]},getLineStyles:function(){return this.lines}},t.EventTarget.addMixin(u.prototype);var m=20,g="orion.annotation.highlightError";return n.AnnotationType.registerType(g,{title:e.syntaxError,html:"<div class='annotationHTML error'></div>",rangeStyle:{styleClass:"annotationRange error"}}),v.prototype={init:function(e,t,n){this.textView=e,this.annotationModel=n,this.modeApplier=new u(e.getModel(),t);var r=this;this.listener={onLineStyle:function(e){r.onLineStyle(e)},onDestroy:function(e){r.onDestroy(e)},onHighlight:function(e){r.onHighlight(e)}},e.addEventListener("LineStyle",this.listener.onLineStyle),e.addEventListener("Destroy",this.listener.onDestroy),this.modeApplier.addEventListener("Highlight",this.listener.onHighlight)},destroy:function(){this.modeApplier&&(this.modeApplier.removeEventListener("Highlight",this.listener.onHighlight),this.modeApplier.destroy()),this.annotationModel,this.textView&&(this.textView.removeEventListener("LineStyle",this.listener.onLineStyle),this.textView.removeEventListener("Destroy",this.listener.onDestroy)),this.textView=null,this.annotationModel=null,this.modeApplier=null,this.listener=null},setMode:function(e){this.modeApplier.setMode(e)},onLineStyle:function(e){var t=e.lineIndex,r=this.modeApplier,i=r.getLineStyle(t);if(!i||!i.eolState){var s=this.textView.getModel().getLineCount();r.highlight(t,Math.min(t+m,s-1),!0),i=r.getLineStyle(t)}var o=this.textView.getModel();if(i){var u=r.toStyleRangesAndErrors(i,t);if(u){e.ranges=u[0];var a=this.annotationModel;if(a){var f=[],l=[],c=u[1];if(c)for(var h=0;h<c.length;h++){var p=c[h];p.style.styleClass==="cm-error"&&l.push(n.AnnotationType.createAnnotation(g,p.start,p.end))}var d=a.getAnnotations(o.getLineStart(t),o.getLineEnd(t));while(d.hasNext()){var v=d.next();v.type===g&&f.push(v)}a.replaceAnnotations(f,l)}}}},onHighlight:function(e){var t=e.start,n=e.end;this.textView.redrawLines(t,n)},onDestroy:function(e){this.destroy()}},{Mirror:s,ModeApplier:u,CodeMirrorStyler:v}}),define("orion/editor/textMateStyler",["orion/editor/regex"],function(e){function n(e,t,n){var r="",i=t.textView._parent,s=i.ownerDocument,o=t._stylesheet=t.util.createElement(s,"style");o.appendChild(s.createTextNode(t._styleSheet(e,r,t.util)));var u=s.getElementsByTagName("head")[0]||s.documentElement;u.appendChild(o),t.textView.update(!0)}function r(e,t){var n,r="JavaScript Editor",i=this;e.getPreferences("/settings",2).then(function(e){var s=e.get(r);if(s!==undefined){n=JSON.parse(e.get(r));if(!n)return;i._stylesheet&&(i._stylesheet.parentNode.removeChild(i._stylesheet),i._stylesheet=null),i._update(n,i,t)}})}function i(e,t){var n=[];for(var r=0;r<e.length;r++)n[e[r].element]=e[r].value;var i=[];i.push("");var s=n.fontFamily;return s==="sans serif"?s='"Menlo", "Consolas", "Vera Mono", "monospace"':s="monospace",i.push(t+" .textviewContainer {"),i.push("\background-color:"+n.background+";"),i.push("	font-family: "+s+";"),i.push("	font-size: "+n.fontSize+";"),i.push("	min-width: 50px;"),i.push("	min-height: 50px;"),i.push("	color: "+n.text+";"),i.push("}"),i.push(t+" {"),i.push("	font-family: "+s+";"),i.push("	font-size: "+n.fontSize+";"),i.push("	color: "+n.text+";"),i.push("}"),i.push(t+" .textview {"),i.push("	background-color: "+n.background+";"),i.push("}"),i.push(t+".ruler.annotations{"),i.push("	background-color: white;"),i.push("}"),i.push(t+" .ruler {"),i.push("	background-color: "+n.annotationRuler+";"),i.push("}"),i.push(t+" .rulerLines {"),i.push("	color: "+n.lineNumber+";"),i.push("	background-color: "+n.annotationRuler+";"),i.push("}"),i.push(t+" .rulerLines.even {"),i.push("	color: "+n.lineNumber+";"),i.push("	background-color: "+n.annotationRuler+";"),i.push("}"),i.push(t+" .rulerLines.odd {"),i.push("	color: "+n.lineNumber+";"),i.push("	background-color: "+n.annotationRuler+";"),i.push("}"),i.push(t+" .annotationLine.currentLine {"),i.push("	background-color: "+n.currentLine+";"),i.push("}"),i.push(t+" .entity-name-tag {"),i.push("color: "+n.keyword+";"),i.push("}"),i.join("\n")}function o(e){var t;if(e instanceof Array){t=new Array(e.length);for(var n=0;n<e.length;n++)t[n]=o(e[n])}else{t={};for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var i=e[r];typeof i=="object"&&i!==null?t[r]=o(i):t[r]=i}}return t}function u(e,t,s,u,a){this.initialize(e,u),this.grammar=o(t),this.externalGrammars=s?o(s):[],this._styles={},this._tree=null,this._allGrammars={},this.preprocess(this.grammar),this._updateStylesheet=r,this._update=n,this._styleSheet=i,this.util=a}var t,s={unsupported:[{regex:/\(\?[ims\-]:/,func:function(e){return"option on/off for subexp"}},{regex:/\(\?<([=!])/,func:function(e){return e[1]==="="?"lookbehind":"negative lookbehind"}},{regex:/\(\?>/,func:function(e){return"atomic group"}}],toRegExp:function(e){function t(e,t){throw new Error('Unsupported regex feature "'+e+'": "'+t[0]+'" at index: '+t.index+" in "+t.input)}function n(e){var t="",n=!1,r=e.length;for(var i=0;i<r;){var s=e.charAt(i);if(!n&&s==="#")while(i<r&&s!=="\r"&&s!=="\n")s=e.charAt(++i);else if(!n&&/\s/.test(s))while(i<r&&/\s/.test(s))s=e.charAt(++i);else s==="\\"?(t+=s,/\s/.test(e.charAt(i+1))||(t+=e.charAt(i+1),i+=1),i+=1):s==="["?(n=!0,t+=s,i+=1):s==="]"?(n=!1,t+=s,i+=1):(t+=s,i+=1)}return t}var r="",i;e=s.processGlobalFlag("x",e,function(e){return n(e)}),e=s.processGlobalFlag("i",e,function(e){return r+="i",e});for(i=0;i<this.unsupported.length;i++){var o;(o=this.unsupported[i].regex.exec(e))&&t(this.unsupported[i].func(o),o)}return new RegExp(e,r)},processGlobalFlag:function(e,t,n){function r(e,t){var n=0,r=e.length,i=-1;for(var s=t;s<r&&i===-1;s++)switch(e.charAt(s)){case"\\":s++;break;case"(":n++;break;case")":n--,n===0&&(i=s)}return i}var i="(?"+e+")",s="(?"+e+":";if(t.substring(0,i.length)===i)return n(t.substring(i.length));if(t.substring(0,s.length)===s){var o=r(t,0);if(o<t.length-1)throw new Error("Only a "+s+") group that encloses the entire regex is supported in: "+t);return n(t.substring(s.length,o))}return t},hasBackReference:function(e){return/\\\d+/.test(e.source)},getSubstitutedRegex:function(t,n,r){r=typeof r=="undefined"?!0:!1;var i=t.source.split(/(\\\d+)/g),s=[];for(var o=0;o<i.length;o++){var u=i[o],a=/\\(\d+)/.exec(u);if(a){var f=n[a[1]]||"";s.push(r?e.escape(f):f)}else s.push(u)}return new RegExp(s.join(""))},groupify:function(e,t){var n=1,r=2,i=3,s=4,o=e.source,u=o.length,a=[],f=0,l=[],c=1,h=1,p=[],d={},v={};for(var m=0;m<u;m++){var g=a[a.length-1],y=o.charAt(m);switch(y){case"(":g===s&&(a.pop(),p.push(")"),l[l.length-1].end=m);var b=m+2<u?o.charAt(m+1)+""+o.charAt(m+2):null;if(b==="?:"||b==="?="||b==="?!"){var w;b==="?:"?w=n:(w=i,f++),a.push(w),l.push({start:m,end:-1,type:w}),p.push(y),p.push(b),m+=b.length}else a.push(r),l.push({start:m,end:-1,type:r,oldNum:c,num:h}),p.push(y),f===0&&(v[h]=null),d[c]=h,c++,h++;break;case")":var E=a.pop();E===i&&f--,l[l.length-1].end=m,p.push(y);break;case"*":case"+":case"?":case"}":var S=y,x=o.charAt(m-1),T=m-1;if(y==="}"){for(var N=m-1;o.charAt(N)!=="{"&&N>=0;N--);x=o.charAt(N-1),T=N-1,S=o.substring(N,m+1)}var C=l[l.length-1];if(x===")"&&(C.type===r||C.type===s)){p.splice(C.start,0,"("),p.push(S),p.push(")");var k={start:C.start,end:p.length-1,type:s,num:C.num};for(var L=0;L<l.length;L++)E=l[L],(E.type===r||E.type===s)&&E.start>=C.start&&E.end<=T&&(E.start+=1,E.end+=1,E.num=E.num+1,E.type===r&&(d[E.oldNum]=E.num));l.push(k),h++;break};default:y!=="|"&&g!==r&&g!==s&&f===0&&(a.push(s),l.push({start:m,end:-1,type:s,num:h}),p.push("("),v[h]=null,h++),p.push(y);if(y==="\\"){var A=o.charAt(m+1);p.push(A),m+=1}}}while(a.length)a.pop(),p.push(")");var O=new RegExp(p.join("")),M={};t=t||d;for(var _ in t)t.hasOwnProperty(_)&&(M[_]="\\"+t[_]);return O=this.getSubstitutedRegex(O,M,!1),[O,d,v]},complexCaptures:function(e){if(!e)return!1;for(var t in e)if(e.hasOwnProperty(t)&&t!=="0")return!0;return!1}};return u.prototype={initialize:function(e,n,r){this.textView=e,this.textView.stylerOptions=this;var i=this;this.textView&&n&&n.startup().then(function(e){t=e.preferences,i.preferences=t,i._updateStylesheet(t,r),i.storageKey=t.listenForChangedSettings(i._listener.onStorage)}),this._listener={onModelChanged:function(e){i.onModelChanged(e)},onDestroy:function(e){i.onDestroy(e)},onLineStyle:function(e){i.onLineStyle(e)},onStorage:function(e){i.onStorage(e)}},e.addEventListener("ModelChanged",this._listener.onModelChanged),e.addEventListener("Destroy",this._listener.onDestroy),e.addEventListener("LineStyle",this._listener.onLineStyle),e.redrawLines()},onDestroy:function(e){this.destroy()},onStorage:function(e){e.key===this.storageKey&&this._updateStylesheet(this.preferences)},destroy:function(){this.textView&&(this.textView.removeEventListener("ModelChanged",this._listener.onModelChanged),this.textView.removeEventListener("Destroy",this._listener.onDestroy),this.textView.removeEventListener("LineStyle",this._listener.onLineStyle),this.textView=null),this.grammar=null,this._styles=null,this._tree=null,this._listener=null},preprocess:function(e){var t=[e];for(;t.length!==0;){var n=t.pop();if(n._resolvedRule&&n._typedRule)continue;n._resolvedRule=this._resolve(n),n._typedRule=this._createTypedRule(n),this.addStyles(n.name),this.addStyles(n.contentName),this.addStylesForCaptures(n.captures),this.addStylesForCaptures(n.beginCaptures),this.addStylesForCaptures(n.endCaptures),n._resolvedRule!==n&&t.push(n._resolvedRule);if(n.patterns)for(var r=0;r<n.patterns.length;r++)t.push(n.patterns[r])}},addStyles:function(e){if(e&&!this._styles[e]){this._styles[e]=[];var t=e.split(".");for(var n=0;n<t.length;n++)this._styles[e].push(t.slice(0,n+1).join("-"))}},addStylesForCaptures:function(e){for(var t in e)if(e.hasOwnProperty(t)){var n=e[t].name;this.addStyles(n)}},ContainerRule:function(){function e(e){this.rule=e,this.subrules=e.patterns}return e.prototype.valueOf=function(){return"aa"},e}(),BeginEndRule:function(){function e(e){this.rule=e,this.beginRegex=s.toRegExp(e.begin),this.endRegex=s.toRegExp(e.end),this.subrules=e.patterns||[],this.endRegexHasBackRef=s.hasBackReference(this.endRegex);var t=s.complexCaptures(e.captures),n=s.complexCaptures(e.beginCaptures)||s.complexCaptures(e.endCaptures);this.isComplex=t||n;if(this.isComplex){var r=s.groupify(this.beginRegex);this.beginRegex=r[0],this.beginOld2New=r[1],this.beginConsuming=r[2];var i=s.groupify(this.endRegex,this.beginOld2New);this.endRegex=i[0],this.endOld2New=i[1],this.endConsuming=i[2]}}return e.prototype.valueOf=function(){return this.beginRegex},e}(),MatchRule:function(){function e(e){this.rule=e,this.matchRegex=s.toRegExp(e.match),this.isComplex=s.complexCaptures(e.captures);if(this.isComplex){var t=s.groupify(this.matchRegex);this.matchRegex=t[0],this.matchOld2New=t[1],this.matchConsuming=t[2]}}return e.prototype.valueOf=function(){return this.matchRegex},e}(),_createTypedRule:function(e){return e.match?new this.MatchRule(e):e.begin?new this.BeginEndRule(e):new this.ContainerRule(e)},_resolve:function(e){var t=e;if(e.include){if(e.begin||e.end||e.match)throw new Error('Unexpected regex pattern in "include" rule '+e.include);var n=e.include;if(n.charAt(0)==="#"){t=this.grammar.repository&&this.grammar.repository[n.substring(1)];if(!t)throw new Error("Couldn't find included rule "+n+" in grammar repository")}else if(n==="$self")t=this.grammar;else{if(n==="$base")throw new Error('Include "$base" is not supported');t=this._allGrammars[n];if(!t)for(var r=0;r<this.externalGrammars.length;r++){var i=this.externalGrammars[r];if(i.scopeName===n){this.preprocess(i),this._allGrammars[n]=i,t=i;break}}}}return t},ContainerNode:function(){function e(e,t){this.parent=e,this.rule=t,this.children=[],this.start=null,this.end=null}return e.prototype.addChild=function(e){this.children.push(e)},e.prototype.valueOf=function(){var e=this.rule;return"ContainerNode { "+(e.include||"")+" "+(e.name||"")+(e.comment||"")+"}"},e}(),BeginEndNode:function(){function e(e,t,n){this.parent=e,this.rule=t,this.children=[],this.setStart(n),this.end=null,this.endMatch=null,t.endRegexHasBackRef?this.endRegexSubstituted=s.getSubstitutedRegex(t.endRegex,n):this.endRegexSubstituted=null}return e.prototype.addChild=function(e){this.children.push(e)},e.prototype.getIndexInParent=function(e){return this.parent?this.parent.children.indexOf(this):-1},e.prototype.setStart=function(e){this.start=e.index,this.beginMatch=e},e.prototype.setEnd=function(e){if(e&&typeof e=="object"){var t=e;this.endMatch=t,this.end=t.index+t[0].length}else{var n=e;this.endMatch=null,this.end=n}},e.prototype.shiftStart=function(e){this.start+=e,this.beginMatch.index+=e},e.prototype.shiftEnd=function(e){this.end+=e,this.endMatch&&(this.endMatch.index+=e)},e.prototype.valueOf=function(){return"{"+this.rule.beginRegex+" range="+this.start+".."+this.end+"}"},e}(),push:function(e,t){if(!t)return;for(var n=t.length;n>0;)e.push(t[--n])},exec:function(e,t,n){var r=e.exec(t);return r&&(r.index+=n),e.lastIndex=0,r},afterMatch:function(e){return e.index+e[0].length},getEndMatch:function(e,t,n){if(e instanceof this.BeginEndNode){var r=e.rule,i=e.endRegexSubstituted||r.endRegex;return i?this.exec(i,t,n):null}return null},initialParse:function(){var e=this.textView.getModel().getCharCount(),t=new this.ContainerNode(null,this.grammar._typedRule);this._tree=t,this.parse(this._tree,!1,0)},onModelChanged:function(e){var t=e.addedCharCount,n=e.addedLineCount,r=e.removedCharCount,i=e.removedLineCount,s=e.start;if(!this._tree)this.initialParse();else{var o=this.textView.getModel(),u=o.getCharCount(),a=o.getLineEnd(o.getLineAtOffset(s)-1),f=this.getFirstDamaged(a,a);a=a===-1?0:a;var l;f?l=this.parse(f,!0,a,s,t,r):l=u,this.textView.redrawRange(a,l)}},getFirstDamaged:function(e,t){if(e<0)return this._tree;var n=[this._tree],r=null;while(n.length){var i=n.pop();if(!i.parent||this.isDamaged(i,e,t)){i instanceof this.BeginEndNode&&(r=i);for(var s=0;s<i.children.length;s++)n.push(i.children[s])}}return r||this._tree},isDamaged:function(e,t,n){return e.start<=n&&e.end>t},parse:function(e,t,n,r,i,s){var o=this.textView.getModel(),u=o.getLineStart(o.getLineCount()-1),a=o.getCharCount(),f=this.getInitialExpected(e,n),l=-1;if(t){e.repaired=!0,e.endNeedsUpdate=!0;var c=e.children[e.children.length-1],h=i-s,p=c?o.getLineEnd(o.getLineAtOffset(c.end+h)):-1,d=o.getLineEnd(o.getLineAtOffset(r+s));l=Math.max(p,d)}l=l===-1?a:l;var v=f,m=e,g=!1,y=n,b=-1;while(m&&(!t||y<l)){var w=this.getNextMatch(o,m,y);w||(y=y>=u?a:o.getLineStart(o.getLineAtOffset(y)+1));var E=w&&w.match,S=w&&w.rule,x=w&&w.isSub,T=w&&w.isEnd;if(x){y=this.afterMatch(E);if(S instanceof this.BeginEndRule){g=!0;if(t&&S===v.rule&&m===v.parent){var N=v;N.setStart(E),N.repaired=!0,N.endNeedsUpdate=!0,m=N,v=this.getNextExpected(v,"begin")}else{t&&(this.prune(m,v),t=!1);var C=new this.BeginEndNode(m,S,E);m.addChild(C),m=C}}}else if(T||y===a)m instanceof this.BeginEndNode&&(E?(g=!0,b=Math.max(b,m.end),m.setEnd(E),y=this.afterMatch(E),t&&m===v&&m.parent===v.parent?(m.repaired=!0,delete m.endNeedsUpdate,v=this.getNextExpected(v,"end")):t&&(this.prune(m,v),t=!1)):(m.setEnd(a),delete m.endNeedsUpdate)),m=m.parent;t&&y>=l&&!g&&(this.prune(e,f),t=!1)}return this.removeUnrepairedChildren(e,t,n),this.cleanup(t,e,n,l,a,i,s),t?Math.max(b,y):y},removeUnrepairedChildren:function(e,t,n){if(t){var r=e.children,i=-1;for(var s=0;s<r.length;s++){var o=r[s];if(!o.repaired&&this.isDamaged(o,n,Number.MAX_VALUE)){i=s;break}}i!==-1&&(e.children.length=i)}},cleanup:function(e,t,n,r,i,s,o){var u,a,f;if(e){var l=s-o,c=this.getIntersecting(r-l+1,i);f=this.getIntersecting(n,r);for(u=0;u<c.length;u++)a=c[u],!a.repaired&&a instanceof this.BeginEndNode&&(a.shiftEnd(l),a.shiftStart(l));for(u=0;u<f.length;u++)a=f[u],a.repaired&&a.endNeedsUpdate&&a.shiftEnd(l),delete a.endNeedsUpdate,delete a.repaired}else{f=this.getIntersecting(n,r);for(u=0;u<f.length;u++)delete f[u].repaired}},getNextMatch:function(e,t,n,r){var i=e.getLineAtOffset(n),s=e.getLineEnd(i),o=e.getText(n,s),u=[],a=[],f=[],l=[];this.push(u,t.rule.subrules);while(u.length){var c=u.length?u.pop():null,h=c&&c._resolvedRule._typedRule;if(h instanceof this.ContainerRule&&a.indexOf(h)===-1){a.push(h),this.push(u,h.subrules);continue}if(h&&r&&!h.matchRegex)continue;var p=h&&this.exec(h.matchRegex||h.beginRegex,o,n);p&&(f.push(p),l.push(h))}var d=Number.MAX_VALUE,v=-1;for(var m=0;m<f.length;m++){var g=f[m];g.index<d&&(d=g.index,v=m)}if(!r){var y=t,b=this.getEndMatch(t,o,n);if(b){var w=y.rule.applyEndPatternLast,E=v===-1||b.index<d||!w&&b.index===d;if(E)return{isEnd:!0,rule:y.rule,match:b}}}return v===-1?null:{isSub:!0,rule:l[v],match:f[v]}},getInitialExpected:function(e,t){var n,r;if(e===this._tree)for(n=0;n<e.children.length;n++){r=e.children[n];if(r.start>=t)return r}else if(e instanceof this.BeginEndNode&&e.endMatch){var i=e.endMatch.index;for(n=0;n<e.children.length;n++){r=e.children[n];if(r.start>=t)break}if(r&&r.start<i)return r}return e},getNextExpected:function(e,t){var n=e;if(t==="begin"){var r=n.children[0];return r?r:n}if(t==="end"){var i=n.parent;if(i){var s=i.children[i.children.indexOf(n)+1];return s?s:i}}return null},prune:function(e,t){var n=t.parent===e;n?e.children.length=t.getIndexInParent():e instanceof this.BeginEndNode&&(e.endMatch=null,e.end=null),e.parent&&(e.parent.children.length=e.getIndexInParent()+1)},onLineStyle:function(e){function t(e,t){return e.start-t.start}this._tree||this.initialParse();var n=e.lineStart,r=this.textView.getModel(),i=r.getLineEnd(e.lineIndex),s=r.getLineEnd(r.getLineAtOffset(n)-1),o=this.getFirstDamaged(s,s),u=this.getLineScope(r,o,n,i);e.ranges=this.toStyleRanges(u),e.ranges.sort(t)},getLineScope:function(e,t,n,r){var i=n,s=this.getInitialExpected(t,n),o=[],u=[];while(t&&i<r){var a=this.getNextMatch(e,t,i);if(!a)break;var f=a&&a.match,l=a&&a.rule,c=a&&a.isSub,h=a&&a.isEnd;f.index!==i&&u.push({start:i,end:f.index,node:t}),c?(i=this.afterMatch(f),l instanceof this.BeginEndRule?(this.addBeginScope(o,f,l),t=s,s=this.getNextExpected(s,"begin")):this.addMatchScope(o,f,l)):h&&(i=this.afterMatch(f),this.addEndScope(o,f,l),s=this.getNextExpected(s,"end"),t=t.parent)}i<r&&u.push({start:i,end:r,node:t});var p=this.getInheritedLineScope(u,n,r);return o.concat(p)},getInheritedLineScope:function(e,t,n){var r=[];for(var i=0;i<e.length;i++){var s=e[i],o=s.node;while(o){var u=o.rule.rule,a=u.name,f=u.contentName,l=f||a;if(l){this.addScopeRange(r,s.start,s.end,l);break}o=o.parent}}return r},addBeginScope:function(e,t,n){var r=n.rule;this.addCapturesScope(e,t,r.beginCaptures||r.captures,n.isComplex,n.beginOld2New,n.beginConsuming)},addEndScope:function(e,t,n){var r=n.rule;this.addCapturesScope(e,t,r.endCaptures||r.captures,n.isComplex,n.endOld2New,n.endConsuming)},addMatchScope:function(e,t,n){var r=n.rule,i=r.name,s=r.captures;s?this.addCapturesScope(e,t,s,n.isComplex,n.matchOld2New,n.matchConsuming):this.addScope(e,t,i)},addScope:function(e,t,n){if(!n)return;e.push({start:t.index,end:this.afterMatch(t),scope:n})},addScopeRange:function(e,t,n,r){if(!r)return;e.push({start:t,end:n,scope:r})},addCapturesScope:function(e,t,n,r,i,s){if(!n)return;if(!r)this.addScope(e,t,n[0]&&n[0].name);else{var o={1:0},u=0;for(var a=1;t[a]!==undefined;a++)s[a]!==undefined&&(u+=t[a].length),t[a+1]!==undefined&&(o[a+1]=u);var f=t.index;for(var l=1;n[l];l++){var c=n[l].name,h=i[l],p=f+o[h];if(typeof t[h]!="undefined"){var d=p+t[h].length;this.addScopeRange(e,p,d,c)}}}},getIntersecting:function(e,t){var n=[],r=this._tree?[this._tree]:[];while(r.length){var i=r.pop(),s=!1;i instanceof this.ContainerNode?s=!0:this.isDamaged(i,e,t)&&(s=!0,n.push(i));if(s){var o=i.children.length;for(var u=0;u<o;u++)r.push(i.children[u])}}return n.reverse()},toStyleRanges:function(e){var t=[];for(var n=0;n<e.length;n++){var r=e[n],i=this._styles[r.scope];if(!i)throw new Error("styles not found for "+r.scope);var s=i.join(" ");t.push({start:r.start,end:r.end,style:{styleClass:s}})}return t}},{RegexUtil:s,TextMateStyler:u}}),define("orion/editor/htmlGrammar",[],function(){function e(){return{scopeName:"source.html",uuid:"3B5C76FB-EBB5-D930-F40C-047D082CE99B",patterns:[{begin:"<!(doctype|DOCTYPE)",end:">",contentName:"entity.name.tag.doctype.html",beginCaptures:{0:{name:"entity.name.tag.doctype.html"}},endCaptures:{0:{name:"entity.name.tag.doctype.html"}}},{begin:"<!--",end:"-->",beginCaptures:{0:{name:"punctuation.definition.comment.html"}},endCaptures:{0:{name:"punctuation.definition.comment.html"}},patterns:[{match:"--",name:"invalid.illegal.badcomment.html"}],contentName:"comment.block.html"},{match:"<[A-Za-z0-9_\\-:]+(?= ?)",name:"entity.name.tag.html"},{include:"#attrName"},{include:"#qString"},{include:"#qqString"},{include:"#entity"},{match:"</[A-Za-z0-9_\\-:]+>",name:"entity.name.tag.html"},{match:">",name:"entity.name.tag.html"}],repository:{attrName:{match:"[A-Za-z\\-:]+(?=\\s*=\\s*['\"])",name:"entity.other.attribute.name.html"},qqString:{match:'(")[^"]+(")',name:"token.string"},qString:{match:"(')[^']+(')",name:"token.string"},entity:{match:"&[A-Za-z0-9]+;",name:"constant.character.entity.html"}}}}return{HtmlGrammar:e}}),define("examples/editor/textStyler",["orion/editor/annotations"],function(e){function F(e,t){this.keywords=e,this.whitespacesVisible=t,this.setText("")}function I(){F.call(this,null,!0)}function q(e){F.call(this,null,e)}function R(){F.call(this,null,!1)}function U(e,i,s){this.commentStart="/*",this.commentEnd="*/";var o=[];switch(i){case"java":o=n;break;case"js":o=t;break;case"css":o=r}this.whitespacesVisible=!1,this.detectHyperlinks=!0,this.highlightCaretLine=!1,this.foldingEnabled=!0,this.detectTasks=!0,this._scanner=new F(o,this.whitespacesVisible),this._firstScanner=new R,this._commentScanner=new q(this.whitespacesVisible),this._whitespaceScanner=new I,i==="css"&&(this._scanner.isCSS=!0,this._firstScanner.isCSS=!0),this.view=e,this.annotationModel=s,this._bracketAnnotations=undefined;var u=this;this._listener={onChanged:function(e){u._onModelChanged(e)},onDestroy:function(e){u._onDestroy(e)},onLineStyle:function(e){u._onLineStyle(e)},onMouseDown:function(e){u._onMouseDown(e)},onSelection:function(e){u._onSelection(e)}};var a=e.getModel();a.getBaseModel&&(a=a.getBaseModel()),a.addEventListener("Changed",this._listener.onChanged),e.addEventListener("MouseDown",this._listener.onMouseDown),e.addEventListener("Selection",this._listener.onSelection),e.addEventListener("Destroy",this._listener.onDestroy),e.addEventListener("LineStyle",this._listener.onLineStyle),this._computeComments(),this._computeFolding(),e.redrawLines()}var t=["break","case","class","catch","continue","const","debugger","default","delete","do","else","enum","export","extends","false","finally","for","function","if","implements","import","in","instanceof","interface","let","new","null","package","private","protected","public","return","static","super","switch","this","throw","true","try","typeof","undefined","var","void","while","with","yield"],n=["abstract","boolean","break","byte","case","catch","char","class","continue","default","do","double","else","extends","false","final","finally","float","for","if","implements","import","instanceof","int","interface","long","native","new","null","package","private","protected","public","return","short","static","super","switch","synchronized","this","throw","throws","transient","true","try","void","volatile","while"],r=["alignment-adjust","alignment-baseline","animation","animation-delay","animation-direction","animation-duration","animation-iteration-count","animation-name","animation-play-state","animation-timing-function","appearance","azimuth","backface-visibility","background","background-attachment","background-clip","background-color","background-image","background-origin","background-position","background-repeat","background-size","baseline-shift","binding","bleed","bookmark-label","bookmark-level","bookmark-state","bookmark-target","border","border-bottom","border-bottom-color","border-bottom-left-radius","border-bottom-right-radius","border-bottom-style","border-bottom-width","border-collapse","border-color","border-image","border-image-outset","border-image-repeat","border-image-slice","border-image-source","border-image-width","border-left","border-left-color","border-left-style","border-left-width","border-radius","border-right","border-right-color","border-right-style","border-right-width","border-spacing","border-style","border-top","border-top-color","border-top-left-radius","border-top-right-radius","border-top-style","border-top-width","border-width","bottom","box-align","box-decoration-break","box-direction","box-flex","box-flex-group","box-lines","box-ordinal-group","box-orient","box-pack","box-shadow","box-sizing","break-after","break-before","break-inside","caption-side","clear","clip","color","color-profile","column-count","column-fill","column-gap","column-rule","column-rule-color","column-rule-style","column-rule-width","column-span","column-width","columns","content","counter-increment","counter-reset","crop","cue","cue-after","cue-before","cursor","direction","display","dominant-baseline","drop-initial-after-adjust","drop-initial-after-align","drop-initial-before-adjust","drop-initial-before-align","drop-initial-size","drop-initial-value","elevation","empty-cells","fit","fit-position","flex-align","flex-flow","flex-inline-pack","flex-order","flex-pack","float","float-offset","font","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","grid-columns","grid-rows","hanging-punctuation","height","hyphenate-after","hyphenate-before","hyphenate-character","hyphenate-lines","hyphenate-resource","hyphens","icon","image-orientation","image-rendering","image-resolution","inline-box-align","left","letter-spacing","line-height","line-stacking","line-stacking-ruby","line-stacking-shift","line-stacking-strategy","list-style","list-style-image","list-style-position","list-style-type","margin","margin-bottom","margin-left","margin-right","margin-top","mark","mark-after","mark-before","marker-offset","marks","marquee-direction","marquee-loop","marquee-play-count","marquee-speed","marquee-style","max-height","max-width","min-height","min-width","move-to","nav-down","nav-index","nav-left","nav-right","nav-up","opacity","orphans","outline","outline-color","outline-offset","outline-style","outline-width","overflow","overflow-style","overflow-x","overflow-y","padding","padding-bottom","padding-left","padding-right","padding-top","page","page-break-after","page-break-before","page-break-inside","page-policy","pause","pause-after","pause-before","perspective","perspective-origin","phonemes","pitch","pitch-range","play-during","position","presentation-level","punctuation-trim","quotes","rendering-intent","resize","rest","rest-after","rest-before","richness","right","rotation","rotation-point","ruby-align","ruby-overhang","ruby-position","ruby-span","size","speak","speak-header","speak-numeral","speak-punctuation","speech-rate","stress","string-set","table-layout","target","target-name","target-new","target-position","text-align","text-align-last","text-decoration","text-emphasis","text-height","text-indent","text-justify","text-outline","text-shadow","text-transform","text-wrap","top","transform","transform-origin","transform-style","transition","transition-delay","transition-duration","transition-property","transition-timing-function","unicode-bidi","vertical-align","visibility","voice-balance","voice-duration","voice-family","voice-pitch","voice-pitch-range","voice-rate","voice-stress","voice-volume","volume","white-space","white-space-collapse","widows","width","word-break","word-spacing","word-wrap","z-index"],i=1,s=2,o=3,u=4,a=5,f=6,l=7,c=8,h=9,p=10,d=11,v=12,m=13,g=14,y="{}()[]<>",b={styleClass:"comment"},w={styleClass:"token_multiline_comment"},E={styleClass:"token_doc_comment"},S={styleClass:"token_doc_html_markup"},x={styleClass:"token_task_tag"},T={styleClass:"token_doc_tag"},N={styleClass:"token-string"},C={styleClass:"token_number"},k={styleClass:"token_keyword"},L={styleClass:"token_space"},A={styleClass:"token_tab"},O={styleClass:"line_caret"},M={styleClass:"ruler"},_={styleCLass:"ruler.annotations"},D={styleClass:"ruler.lines"},P={styleClass:"ruler.overview"},H={styleCLass:"rulerLines"},B={styleClass:"rulerLines.even"},j={styleClass:"rulerLines.odd"};return F.prototype={getOffset:function(){return this.offset},getStartOffset:function(){return this.startOffset},getData:function(){return this.text.substring(this.startOffset,this.offset)},getDataLength:function(){return this.offset-this.startOffset},_default:function(e){switch(e){case 32:case 9:if(this.whitespacesVisible)return e===32?d:p;do e=this._read();while(e===32||e===9);return this._unread(e),h;case 123:case 125:case 40:case 41:case 91:case 93:case 60:case 62:return e;default:var t=this.isCSS,n=this.offset-1;if(!t&&48<=e&&e<=57){var r=!1,u=!1,a=!1,f=e;do{e=this._read();if(e===46&&!r)r=!0;else if(e===101&&!u)r=u=!0,e=this._read(),e!==45&&this._unread(e);else if(e===120&&f===48&&this.offset-n===2)r=u=a=!0;else if(!(48<=e&&e<=57||a&&(65<=e&&e<=70||97<=e&&e<=102)))break}while(!0);return this._unread(e),o}if(97<=e&&e<=122||65<=e&&e<=90||e===95||45===e&&t){do e=this._read();while(97<=e&&e<=122||65<=e&&e<=90||e===95||48<=e&&e<=57||45===e&&t);this._unread(e);var l=this.keywords;if(l.length>0){var c=this.text.substring(n,this.offset);for(var v=0;v<l.length;v++)if(this.keywords[v]===c)return s}}return i}},_read:function(){return this.offset<this.text.length?this.text.charCodeAt(this.offset++):-1},_unread:function(e){e!==-1&&this.offset--},nextToken:function(){this.startOffset=this.offset;for(;;){var e=this._read(),t;switch(e){case-1:return null;case 47:e=this._read();if(!this.isCSS&&e===47)for(;;){e=this._read();if(e===-1||e===10||e===13)return this._unread(e),f}if(e===42){e=this._read();var n=l;e===42&&(n=c);for(;;){while(e===42){e=this._read();if(e===47)return n}if(e===-1)return this._unread(e),n;e=this._read()}}return this._unread(e),i;case 39:t=u;for(;;){e=this._read();switch(e){case 39:return t;case 13:case 10:case-1:return this._unread(e),t;case 92:e=this._read();switch(e){case 10:t=a;break;case 13:t=a,e=this._read(),e!==10&&this._unread(e)}}}break;case 34:t=u;for(;;){e=this._read();switch(e){case 34:return t;case 13:case 10:case-1:return this._unread(e),t;case 92:e=this._read();switch(e){case 10:t=a;break;case 13:t=a,e=this._read(),e!==10&&this._unread(e)}}}break;default:return this._default(e)}}},setText:function(e){this.text=e,this.offset=0,this.startOffset=0}},I.prototype=new F(null),I.prototype.nextToken=function(){this.startOffset=this.offset;for(;;){var e=this._read();switch(e){case-1:return null;case 32:return d;case 9:return p;default:do e=this._read();while(e!==32&&e!==9&&e!==-1);return this._unread(e),i}}},q.prototype=new F(null),q.prototype.setType=function(e){this._type=e},q.prototype.nextToken=function(){this.startOffset=this.offset;for(;;){var e=this._read();switch(e){case-1:return null;case 32:case 9:if(this.whitespacesVisible)return e===32?d:p;do e=this._read();while(e===32||e===9);return this._unread(e),h;case 60:if(this._type===c){do e=this._read();while(e!==62&&e!==-1);if(e===62)return v}return i;case 64:if(this._type===c){do e=this._read();while(97<=e&&e<=122||65<=e&&e<=90||e===95||48<=e&&e<=57);return this._unread(e),m}return i;case 84:if((e=this._read())===79)if((e=this._read())===68)if((e=this._read())===79){e=this._read();if(!(97<=e&&e<=122||65<=e&&e<=90||e===95||48<=e&&e<=57))return this._unread(e),g;this._unread(e)}else this._unread(e);else this._unread(e);else this._unread(e);default:do e=this._read();while(e!==32&&e!==9&&e!==-1&&e!==60&&e!==64&&e!==84);return this._unread(e),i}}},R.prototype=new F(null),R.prototype._default=function(e){for(;;){e=this._read();switch(e){case 47:case 34:case 39:case-1:return this._unread(e),i}}},U.prototype={getClassNameForToken:function(e){switch(e){case"singleLineComment":return b.styleClass;case"multiLineComment":return w.styleClass;case"docComment":return E.styleClass;case"docHtmlComment":return S.styleClass;case"tasktag":return x.styleClass;case"doctag":return T.styleClass;case"string":return N.styleClass;case"number":return C.styleClass;case"keyword":return k.styleClass;case"space":return L.styleClass;case"tab":return A.styleClass;case"caretLine":return O.styleClass;case"rulerStyle":return M.styleClass;case"annotationsStyle":return _.styleClass;case"rulerFolding":return H.styleClass;case"rulerOverview":return P.styleClass;case"rulerLines":return H.styleClass;case"rulerLinesEven":return B.styleClass;case"rulerLinesOdd":return j.styleClass}return null},destroy:function(){var e=this.view;if(e){var t=e.getModel();t.getBaseModel&&(t=t.getBaseModel()),t.removeEventListener("Changed",this._listener.onChanged),e.removeEventListener("MouseDown",this._listener.onMouseDown),e.removeEventListener("Selection",this._listener.onSelection),e.removeEventListener("Destroy",this._listener.onDestroy),e.removeEventListener("LineStyle",this._listener.onLineStyle),this.view=null}},setHighlightCaretLine:function(e){this.highlightCaretLine=e},setWhitespacesVisible:function(e){this.whitespacesVisible=e,this._scanner.whitespacesVisible=e,this._commentScanner.whitespacesVisible=e},setDetectHyperlinks:function(e){this.detectHyperlinks=e},setFoldingEnabled:function(e){this.foldingEnabled=e},setDetectTasks:function(e){this.detectTasks=e},_binarySearch:function(e,t,n,r,i){var s;r===undefined&&(r=-1),i===undefined&&(i=e.length);while(i-r>1){s=Math.floor((i+r)/2);if(t<=e[s].start)i=s;else{if(n&&t<e[s].end){i=s;break}r=s}}return i},_computeComments:function(){var e=this.view.getModel();e.getBaseModel&&(e=e.getBaseModel()),this.comments=this._findComments(e.getText())},_computeFolding:function(){if(!this.foldingEnabled)return;var t=this.view,n=t.getModel();if(!n.getBaseModel)return;var r=this.annotationModel;if(!r)return;r.removeAnnotations(e.AnnotationType.ANNOTATION_FOLDING);var i=[],s=n.getBaseModel(),o=this.comments;for(var u=0;u<o.length;u++){var a=o[u],f=this._createFoldingAnnotation(n,s,a.start,a.end);f&&i.push(f)}r.replaceAnnotations(null,i)},_createFoldingAnnotation:function(t,n,r,i){var s=n.getLineAtOffset(r),o=n.getLineAtOffset(i);return s===o?null:new(e.AnnotationType.getType(e.AnnotationType.ANNOTATION_FOLDING))(r,i,t)},_computeTasks:function(t,n,r){if(!this.detectTasks)return;var i=this.annotationModel;if(!i)return;var s=this.view,o=s.getModel(),u=o;o.getBaseModel&&(u=o.getBaseModel());var a=i.getAnnotations(n,r),l=[],c=e.AnnotationType.ANNOTATION_TASK;while(a.hasNext()){var h=a.next();h.type===c&&l.push(h)}var p=[],d=this._commentScanner;d.setText(u.getText(n,r));var v;while(v=d.nextToken()){var m=d.getStartOffset()+n;if(v===g){var y=u.getLineEnd(u.getLineAtOffset(m));t!==f&&(y=Math.min(y,r-this.commentEnd.length)),p.push(e.AnnotationType.createAnnotation(c,m,y,u.getText(m,y)))}}i.replaceAnnotations(l,p)},_getLineStyle:function(e){if(this.highlightCaretLine){var t=this.view,n=t.getModel(),r=t.getSelection();if(r.start===r.end&&n.getLineAtOffset(r.start)===e)return O}return null},_getStyles:function(e,t,n){e.getBaseModel&&(n=e.mapOffset(n));var r=n+t.length,i=[],s=n,o=this.comments,u=this._binarySearch(o,n,!0);for(var f=u;f<o.length;f++){if(o[f].start>=r)break;var h=o[f].start,p=o[f].end;s<h&&this._parse(t.substring(s-n,h-n),s,i);var d=o[f].type,v;switch(d){case c:v=E;break;case l:v=w;break;case a:v=N}var m=Math.max(s,h),g=Math.min(r,p);d!==c&&d!==l||!this.whitespacesVisible&&!this.detectHyperlinks?d===a&&this.whitespacesVisible?this._parseString(t.substring(m-n,g-n),m,i,N):i.push({start:m,end:g,style:v}):this._parseComment(t.substring(m-n,g-n),m,i,v,d),s=p}s<r&&this._parse(t.substring(s-n,r-n),s,i);if(e.getBaseModel)for(var y=0;y<i.length;y++){var b=i[y].end-i[y].start;i[y].start=e.mapOffset(i[y].start,!0),i[y].end=i[y].start+b}return i},_parse:function(e,t,n){var r=this._scanner;r.setText(e);var i;while(i=r.nextToken()){var h=r.getStartOffset()+t,v=null;switch(i){case s:v=k;break;case o:v=C;break;case a:case u:if(this.whitespacesVisible){this._parseString(r.getData(),h,n,N);continue}v=N;break;case c:this._parseComment(r.getData(),h,n,E,i);continue;case f:this._parseComment(r.getData(),h,n,b,i);continue;case l:this._parseComment(r.getData(),h,n,w,i);continue;case p:this.whitespacesVisible&&(v=A);break;case d:this.whitespacesVisible&&(v=L)}n.push({start:h,end:r.getOffset()+t,style:v})}},_parseComment:function(e,t,n,r,i){var s=this._commentScanner;s.setText(e),s.setType(i);var o;while(o=s.nextToken()){var u=s.getStartOffset()+t,a=r;switch(o){case p:this.whitespacesVisible&&(a=A);break;case d:this.whitespacesVisible&&(a=L);break;case v:a=S;break;case m:a=T;break;case g:a=x;break;default:this.detectHyperlinks&&(a=this._detectHyperlinks(s.getData(),u,n,a))}a&&n.push({start:u,end:s.getOffset()+t,style:a})}},_parseString:function(e,t,n,r){var i=this._whitespaceScanner;i.setText(e);var s;while(s=i.nextToken()){var o=i.getStartOffset()+t,u=r;switch(s){case p:this.whitespacesVisible&&(u=A);break;case d:this.whitespacesVisible&&(u=L)}u&&n.push({start:o,end:i.getOffset()+t,style:u})}},_detectHyperlinks:function(e,t,n,r){var i=null,s,o;if((s=e.indexOf("://"))>0){i=e;var u=s;while(u>0){var a=i.charCodeAt(u-1);if(!(97<=a&&a<=122||65<=a&&a<=90||45===a||48<=a&&a<=57))break;u--}if(u>0){var f="\"\"''(){}[]<>";s=f.indexOf(i.substring(u-1,u));if(s!==-1&&(s&1)===0&&(s=i.lastIndexOf(f.substring(s+1,s+2)))!==-1){var l=s;return o=this._clone(r),o.tagName="A",o.attributes={href:i.substring(u,l)},n.push({start:t,end:t+u,style:r}),n.push({start:t+u,end:t+l,style:o}),n.push({start:t+l,end:t+e.length,style:r}),null}}}else e.toLowerCase().indexOf("bug#")===0&&(i="https://bugs.eclipse.org/bugs/show_bug.cgi?id="+parseInt(e.substring(4),10));return i?(o=this._clone(r),o.tagName="A",o.attributes={href:i},o):r},_clone:function(e){if(!e)return e;var t={};for(var n in e)if(e.hasOwnProperty(n)){var r=e[n];t[n]=r}return t},_findComments:function(e,t){t=t||0;var n=this._firstScanner,r;n.setText(e);var i=[];while(r=n.nextToken())(r===l||r===c||r===a)&&i.push({start:n.getStartOffset()+t,end:n.getOffset()+t,type:r}),(r===f||r===l||r===c)&&this._computeTasks(r,n.getStartOffset()+t,n.getOffset()+t);return i},_findMatchingBracket:function(e,t){var n=y,r=e.getText(t,t+1),i=n.indexOf(r,0);if(i===-1)return-1;var s;i&1?s=n.substring(i-1,i):s=n.substring(i+1,i+2);var o=e.getLineAtOffset(t),u=e.getLine(o),a=e.getLineStart(o),f=e.getLineEnd(o);n=this._findBrackets(r,s,u,a,a,f);for(var l=0;l<n.length;l++){var c=n[l]>=0?1:-1;if(n[l]*c-1===t){var h=1;if(i&1){l--;for(;l>=0;l--){c=n[l]>=0?1:-1,h+=c;if(h===0)return n[l]*c-1}o-=1;while(o>=0){u=e.getLine(o),a=e.getLineStart(o),f=e.getLineEnd(o),n=this._findBrackets(r,s,u,a,a,f);for(var p=n.length-1;p>=0;p--){c=n[p]>=0?1:-1,h+=c;if(h===0)return n[p]*c-1}o--}}else{l++;for(;l<n.length;l++){c=n[l]>=0?1:-1,h+=c;if(h===0)return n[l]*c-1}o+=1;var d=e.getLineCount();while(o<d){u=e.getLine(o),a=e.getLineStart(o),f=e.getLineEnd(o),n=this._findBrackets(r,s,u,a,a,f);for(var v=0;v<n.length;v++){c=n[v]>=0?1:-1,h+=c;if(h===0)return n[v]*c-1}o++}}break}}return-1},_findBrackets:function(e,t,n,r,i,s){var o=[],u=e.charCodeAt(0),a=t.charCodeAt(0),f=i,l=this._scanner,c,h=this.comments,p=this._binarySearch(h,i,!0);for(var d=p;d<h.length;d++){if(h[d].start>=s)break;var v=h[d].start,m=h[d].end;if(f<v){l.setText(n.substring(f-i,v-i));while(c=l.nextToken())c===u?o.push(l.getStartOffset()+f-i+r+1):c===a&&o.push(-(l.getStartOffset()+f-i+r+1))}f=m}if(f<s){l.setText(n.substring(f-i,s-i));while(c=l.nextToken())c===u?o.push(l.getStartOffset()+f-i+r+1):c===a&&o.push(-(l.getStartOffset()+f-i+r+1))}return o},_onDestroy:function(e){this.destroy()},_onLineStyle:function(e){e.textView===this.view&&(e.style=this._getLineStyle(e.lineIndex)),e.ranges=this._getStyles(e.textView.getModel(),e.lineText,e.lineStart)},_onSelection:function(t){var n=t.oldValue,r=t.newValue,i=this.view,s=i.getModel(),o;if(this.highlightCaretLine){var u=s.getLineAtOffset(n.start);o=s.getLineAtOffset(r.start);var a=r.start===r.end,f=n.start===n.end;if(u!==o||!f||!a)f&&i.redrawLines(u,u+1),(u!==o||!f)&&a&&i.redrawLines(o,o+1)}if(!this.annotationModel)return;var l=this._bracketAnnotations,c,h;if(r.start===r.end&&(h=i.getCaretOffset())>0){var p=h-1;s.getBaseModel&&(p=s.mapOffset(p),s=s.getBaseModel());var d=this._findMatchingBracket(s,p);d!==-1&&(c=[e.AnnotationType.createAnnotation(e.AnnotationType.ANNOTATION_MATCHING_BRACKET,d,d+1),e.AnnotationType.createAnnotation(e.AnnotationType.ANNOTATION_CURRENT_BRACKET,p,p+1)])}this._bracketAnnotations=c,this.annotationModel.replaceAnnotations(l,c)},_onMouseDown:function(e){if(e.clickCount!==2)return;var t=this.view,n=t.getModel(),r=t.getOffsetAtLocation(e.x,e.y);if(r>0){var i=r-1,s=n;n.getBaseModel&&(i=n.mapOffset(i),s=n.getBaseModel());var o=this._findMatchingBracket(s,i);if(o!==-1){e.preventDefault();var u=o;n.getBaseModel&&(u=n.mapOffset(u,!0)),r>u&&(r--,u++),t.setSelection(u,r)}}},_onModelChanged:function(t){var n=t.start,r=t.removedCharCount,i=t.addedCharCount,s=i-r,o=this.view,u=o.getModel(),a=u.getBaseModel?u.getBaseModel():u,f=n+r,l=a.getCharCount(),c=this.comments.length,h=a.getLineStart(a.getLineAtOffset(n)),p=this._binarySearch(this.comments,h,!0),d=this._binarySearch(this.comments,f,!1,p-1,c),v;p<c&&this.comments[p].start<=h&&h<this.comments[p].end?(v=this.comments[p].start,v>n&&(v+=s)):p===c&&c>0&&l-s===this.comments[c-1].end?v=this.comments[c-1].start:v=h;var m;d<c?(m=this.comments[d].end,m>n&&(m+=s),d+=1):(d=c,m=l);var g=a.getText(v,m),y,b=this._findComments(g,v),w;for(w=p;w<this.comments.length;w++)y=this.comments[w],y.start>n&&(y.start+=s),y.start>n&&(y.end+=s);var E=d-p!==b.length;if(!E)for(w=0;w<b.length;w++){y=this.comments[p+w];var S=b[w];if(y.start!==S.start||y.end!==S.end||y.type!==S.type){E=!0;break}}var x=[p,d-p].concat(b);Array.prototype.splice.apply(this.comments,x);if(E){var T=v,N=m;u!==a&&(T=u.mapOffset(T,!0),N=u.mapOffset(N,!0)),o.redrawRange(T,N)}if(this.foldingEnabled&&a!==u&&this.annotationModel){var C=this.annotationModel,k=C.getAnnotations(v,m),L=[],A=[],O;while(k.hasNext()){O=k.next();if(O.type===e.AnnotationType.ANNOTATION_FOLDING){A.push(O);for(w=0;w<b.length;w++)if(O.start===b[w].start&&O.end===b[w].end)break;if(w===b.length)L.push(O),O.expand();else{var M=O.start,_=O.end;M>n&&(M-=s),_>n&&(_-=s);if(M<=n&&n<_&&M<=f&&f<_){var D=a.getLineAtOffset(O.start),P=a.getLineAtOffset(O.end);D!==P?O.expanded||(O.expand(),C.modifyAnnotation(O)):C.removeAnnotation(O)}}}}var H=[];for(w=0;w<b.length;w++){y=b[w];for(var B=0;B<A.length;B++)if(A[B].start===y.start&&A[B].end===y.end)break;B===A.length&&(O=this._createFoldingAnnotation(u,a,y.start,y.end),O&&H.push(O))}C.replaceAnnotations(L,H)}}},{TextStyler:U}}),define("orion/editor/edit",["orion/editor/textView","orion/editor/textModel","orion/editor/projectionTextModel","orion/editor/eventTarget","orion/editor/keyBinding","orion/editor/rulers","orion/editor/annotations","orion/editor/tooltip","orion/editor/undoStack","orion/editor/textDND","orion/editor/editor","orion/editor/editorFeatures","orion/editor/contentAssist","orion/editor/cssContentAssist","orion/editor/htmlContentAssist","orion/editor/jsTemplateContentAssist","orion/editor/AsyncStyler","orion/editor/mirror","orion/editor/textMateStyler","orion/editor/htmlGrammar","examples/editor/textStyler"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w){function E(e){if(!window.getSelection)return e.innerText||e.textContent;var t=document.createRange();t.selectNode(e);var n=window.getSelection(),r=[],i;for(i=0;i<n.rangeCount;i++)r.push(n.getRangeAt(i));n.removeAllRanges(),n.addRange(t);var s=n.toString();n.removeAllRanges();for(i=0;i<r.length;i++)n.addRange(r[i]);return s}function S(r){var i=r.parent;i||(i="editor"),typeof i=="string"&&(i=(r.document||document).getElementById(i));if(!i)throw"no parent";var s=function(){return new e.TextView({parent:i,model:new n.ProjectionTextModel(new t.TextModel("")),tabSize:r.tabSize?r.tabSize:4,readonly:r.readonly,fullSelection:r.fullSelection,tabMode:r.tabMode,expandTab:r.expandTab,themeClass:r.themeClass,wrapMode:r.wrapMode})},o,u;if(!r.readonly){u={createContentAssistMode:function(e){o=new h.ContentAssist(e.getTextView());var t=new h.ContentAssistWidget(o);return new h.ContentAssistMode(o,t)}};var a=new p.CssContentAssistProvider,f=new v.JSTemplateContentAssistProvider}var d={styler:null,highlight:function(e,t){this.styler&&(this.styler.destroy(),this.styler=null);if(e){var n=t.getTextView(),i=t.getAnnotationModel();switch(e){case"js":case"java":case"css":this.styler=new w.TextStyler(n,e,i),t.setFoldingRulerVisible(r.showFoldingRuler==undefined||r.showFoldingRuler);break;case"html":this.styler=new y.TextMateStyler(n,new b.HtmlGrammar)}}}},m=function(e,t,n,r){var i=new c.TextActions(e,n);t.push(i);var s=new c.SourceCodeActions(e,n,r);t.push(s)},g=new l.Editor({textViewFactory:s,undoStackFactory:new c.UndoFactory,annotationFactory:new c.AnnotationFactory,lineNumberRulerFactory:new c.LineNumberRulerFactory,foldingRulerFactory:new c.FoldingRulerFactory,textDNDFactory:new c.TextDNDFactory,contentAssistFactory:u,keyBindingFactory:m,statusReporter:r.statusReporter,domNode:i}),S=r.contents;return S===undefined&&(S=E(i)),S||(S=""),g.installTextView(),g.setLineNumberRulerVisible(r.showLinesRuler==undefined||r.showLinesRuler),g.setAnnotationRulerVisible(r.showAnnotationRuler==undefined||r.showFoldingRuler),g.setOverviewRulerVisible(r.showOverviewRuler==undefined||r.showOverviewRuler),g.setFoldingRulerVisible(r.showFoldingRuler==undefined||r.showFoldingRuler),g.setInput(r.title,null,S),d.highlight(r.lang,g),o&&o.addEventListener("Activating",function(){/css$/.test(r.lang)?o.setProviders([a]):/js$/.test(r.lang)&&o.setProviders([f])}),g}return S});